	<style>
		/* Unificar distancia entre todos los botones */
		.btn,
		button,
		.btn-cam,
		.btn-velocidad,
		.btn-gps,
		.btn-direccion,
		.btn-rele {
			margin: 3px !important;
		}
		.reles-botones,
		.velocidades-botones,
		.gps-botones,
		.cruz-botones,
		.indicadores-grid {
			gap: 6px !important;
		}
		/* Dividir pantalla en dos mitades */
		body {
			margin: 0;
			padding: 0;
			height: 100vh;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}
		.cuadro-superior-wrapper {
			flex: 1;
			min-height: 50vh;
			max-height: 50vh;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: auto;
		}
		.cuadro-inferior {
			flex: 1;
			min-height: 50vh;
			max-height: 50vh;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: auto;
		}
	</style>

<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Control Remoto Digital</title>
	<link rel="stylesheet" href="/static/tema_universal.css">
	<style>
			   .indicador-item {
				   font-size: 12px !important;
				   font-family: 'Segoe UI', 'Roboto', Arial, sans-serif !important;
			   }
		.reles-botones {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 6px !important;
			margin: 0 !important;
			width: 100%;
			max-width: 420px;
		}
		@media (max-width: 700px) {
			.reles-botones {
				grid-template-columns: 1fr 1fr;
				gap: 8px;
				max-width: 320px;
			}
		}
		@media (max-width: 480px) {
			.reles-botones {
				grid-template-columns: 1fr;
				max-width: 180px;
			}
		}
		/* .cruz-botones ahora se ajusta desde tema_universal.css para unificar formato */
		#btn-arriba { grid-row: 1; grid-column: 2; }
		#btn-izquierda { grid-row: 2; grid-column: 1; }
		#btn-centro { grid-row: 2; grid-column: 2; }
		#btn-derecha { grid-row: 2; grid-column: 3; }
		#btn-abajo { grid-row: 3; grid-column: 2; }	/* Dividir pantalla en dos mitades */
	body {
		margin: 0;
		padding: 0;
		height: 100vh;
		overflow: hidden;
		display: flex;
		flex-direction: column;
	}
	.cuadro-superior-wrapper {
		flex: 1;
		min-height: 50vh;
		max-height: 50vh;
		display: flex;
		align-items: stretch;
		justify-content: center;
		overflow: auto;
		padding: 4px;
		box-sizing: border-box;
	}
	.cuadro-superior-wrapper > div {
		display: flex;
		align-items: stretch;
		height: 100%;
	}
	.cuadro-externo-superior {
		height: 100% !important;
		margin: 0 !important;
	}
	.cuadro-inferior {
		flex: 1;
		min-height: 50vh;
		max-height: 50vh;
		display: flex;
		align-items: stretch;
		justify-content: center;
		overflow: auto;
		padding: 4px;
		box-sizing: border-box;
	}
	.cuadro-inferior > div {
		display: flex;
		align-items: stretch;
		height: 100%;
	}
	.cuadro-externo-inferior {
		height: 100% !important;
		margin: 0 !important;
	}	</style>
	<script src="/static/leaflet_loader.js"></script>
</head>
<body>
		<!-- Tuerca flotante en esquina superior derecha -->
		<div id="menu-flotante">
		<button id="btn-tuerca" class="btn-menu" type="button" aria-label="Men√∫ de opciones">
				<svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="#4a9eff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
			</button>
			<div id="menu-opciones" style="display:none;">
				<button class="btn-menu" onclick="document.documentElement.requestFullscreen()">üñµ Pantalla completa</button>
				<button class="btn-menu" onclick="window.location.href='configuracion.html'">‚öôÔ∏è Configuraci√≥n</button>
				<button class="btn-menu" onclick="if(confirm('¬øReiniciar el sistema?')) fetch('/api/reiniciar', {method:'POST'}).then(()=>window.location.reload())">üîÑ Reiniciar</button>
				<button class="btn-menu" onclick="if(confirm('¬øApagar el sistema?')) fetch('/api/apagar', {method:'POST'})">‚èª Apagar</button>
			</div>
		</div>
		<script>
			const btnTuerca = document.getElementById('btn-tuerca');
			const menuOpciones = document.getElementById('menu-opciones');
			btnTuerca.onclick = function(e) {
				e.stopPropagation();
				menuOpciones.style.display = menuOpciones.style.display === 'none' ? 'block' : 'none';
			};
			document.addEventListener('click', function(e) {
				if (menuOpciones.style.display === 'block') menuOpciones.style.display = 'none';
			});
		</script>
		<div class="cuadro-superior-wrapper">
			   <div style="width:100%; display:flex; justify-content:center; align-items:stretch;">
				   <div class="cuadro-externo-superior" style="background:#e3eaf2; border-radius:8px; box-shadow:0 2px 12px #0002; padding:4px; display:flex; justify-content:center; align-items:center;">
					   <div class="fila-superior" style="gap:0; margin:0; display:flex; justify-content:center; align-items:stretch;">
			   <div class="panel-cam" style="margin:0; min-width:260px; max-width:340px; width:300px; height:220px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:6px; box-sizing:border-box;">
					   <video id="videoCam1" controls muted playsinline></video>
					   <div style="display: flex; gap: 8px; margin-top: 4px;">
						   <button id="playCam1" class="btn btn-cam btn-cam-icon" title="Play/Stop Cam 1">
							   <span id="iconPlayCam1" style="display:inline-block;width:100%;height:100%;vertical-align:middle;">
								   <svg width="100%" height="100%" viewBox="0 0 22 22" fill="#2196f3" style="display:block;"><polygon points="6,4 18,11 6,18"/></svg>
							   </span>
						   </button>
						   <button id="captureCam1" class="btn btn-cam btn-cam-icon" title="Capturar Foto">
							   <svg width="100%" height="100%" viewBox="0 0 32 32" fill="#555" style="display:block;">
								   <rect x="4" y="10" width="24" height="14" rx="3" fill="#bbb"/>
								   <circle cx="16" cy="17" r="6" fill="#2196f3"/>
								   <rect x="11" y="5" width="10" height="6" rx="2" fill="#bbb"/>
							   </svg>
						   </button>
						<button id="grabar-cam1" class="btn btn-cam btn-cam-icon" title="Grabar video">
						<svg width="100%" height="100%" viewBox="0 0 32 32" style="display:block;">
							<rect x="4" y="10" width="16" height="12" rx="2" fill="#d32f2f"/>
							<circle cx="12" cy="16" r="3" fill="#fff"/>
							<path d="M20 12 L28 8 L28 24 L20 20 Z" fill="#d32f2f"/>
							</svg>
						</button>
						   </div>
					   </div>
				   </div>
			   <div class="panel-cam" style="margin:0; min-width:260px; max-width:340px; width:300px; height:220px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:6px; box-sizing:border-box;">
					   <video id="videoCam2" controls muted playsinline></video>
					   <div style="display: flex; gap: 8px; margin-top: 4px;">
						   <button id="playCam2" class="btn btn-cam btn-cam-icon" title="Play/Stop Cam 2">
							   <span id="iconPlayCam2" style="display:inline-block;width:100%;height:100%;vertical-align:middle;">
								   <svg width="100%" height="100%" viewBox="0 0 22 22" fill="#2196f3" style="display:block;"><polygon points="6,4 18,11 6,18"/></svg>
							   </span>
						   </button>
						   <button id="captureCam2" class="btn btn-cam btn-cam-icon" title="Capturar Foto">
							   <svg width="100%" height="100%" viewBox="0 0 32 32" fill="#555" style="display:block;">
								   <rect x="4" y="10" width="24" height="14" rx="3" fill="#bbb"/>
								   <circle cx="16" cy="17" r="6" fill="#2196f3"/>
								   <rect x="11" y="5" width="10" height="6" rx="2" fill="#bbb"/>
							   </svg>
						   </button>
						<button id="grabar-cam2" class="btn btn-cam btn-cam-icon" title="Grabar video">
						<svg width="100%" height="100%" viewBox="0 0 32 32" style="display:block;">
							<rect x="4" y="10" width="16" height="12" rx="2" fill="#d32f2f"/>
							<circle cx="12" cy="16" r="3" fill="#fff"/>
							<path d="M20 12 L28 8 L28 24 L20 20 Z" fill="#d32f2f"/>
							</svg>
						</button>
						<style>
							.btn-cam-icon {
								width: 48px;
								height: 48px;
								min-width: 48px;
								min-height: 48px;
								padding: 0;
								display: flex;
								align-items: center;
								justify-content: center;
							}
							.btn-cam-icon svg {
								width: 90%;
								height: 90%;
							}
						</style>
					   </div>
				   </div>
			   <div class="panel-cam" style="margin:0; min-width:260px; max-width:340px; width:300px; height:220px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:6px; box-sizing:border-box;">
					   <div id="mapa-gps" style="width: 100%; height: 100%; min-width: 0; min-height: 0; border-radius: 8px; background: #232a36;"></div>
				</div>
			</div>
		</div>
	</div>
	<div class="cuadro-inferior">
		<div style="width:100%; display:flex; justify-content:center; align-items:stretch;">
			<div class="cuadro-externo-inferior" style="background:#e3eaf2; border-radius:8px; box-shadow:0 2px 12px #0002; padding:4px; display:flex; justify-content:center; align-items:center;">
					<div class="fila-inferior" style="display:flex; justify-content:center; gap:8px;">
						<div class="panel-bajo" style="margin-left:0;margin-right:0; padding-left:12px; padding-right:12px; box-sizing:border-box;">
							<!-- Panel de depuraci√≥n eliminado -->
							<div class="cruz-botones">
								<button class="btn btn-direccion" id="btn-arriba">‚ñ≤</button>
								<button class="btn btn-direccion" id="btn-izquierda">‚óÄ</button>
								<button class="btn btn-direccion" id="btn-centro">‚óè</button>
								<button class="btn btn-direccion" id="btn-derecha">‚ñ∂</button>
								<button class="btn btn-direccion" id="btn-abajo">‚ñº</button>
							</div>
						</div>
						<div class="panel-bajo" style="margin-left:0;margin-right:0; display:flex; justify-content:center; align-items:center; min-width:120px; max-width:140px; width:130px; padding-left:12px; padding-right:12px; box-sizing:border-box;">
							<div class="velocidades-botones" style="display:flex; flex-direction:column; gap:2px; align-items:center; padding-left:2px; padding-right:2px; width:100%; box-sizing:border-box;">
								<button class="btn btn-velocidad" id="vel-lenta" style="margin-left:0;margin-right:0;padding-left:6px;padding-right:6px;min-width:120px;max-width:140px;width:100%;box-sizing:border-box;">Lenta</button>
								<button class="btn btn-velocidad" id="vel-media" style="margin-left:0;margin-right:0;padding-left:6px;padding-right:6px;min-width:120px;max-width:140px;width:100%;box-sizing:border-box;">Media</button>
								<button class="btn btn-velocidad" id="vel-rapida" style="margin-left:0;margin-right:0;padding-left:6px;padding-right:6px;min-width:120px;max-width:140px;width:100%;box-sizing:border-box;">R√°pida</button>
							</div>
						</div>
						<div class="panel-bajo" style="margin-left:0;margin-right:0; padding-left:12px; padding-right:12px; width:100%; box-sizing:border-box;">
							<div class="reles-botones" id="reles-botones">
								<!-- Los botones de rel√© se generan din√°micamente -->
							</div>
						</div>
						<div class="panel-bajo" style="margin-left:0;margin-right:0; display:flex; justify-content:center; align-items:center; min-width:120px; max-width:140px; width:130px; padding-left:12px; padding-right:12px; box-sizing:border-box;">
							<div class="gps-botones" style="display:flex; flex-direction:column; gap:2px; align-items:center; padding-left:2px; padding-right:2px; width:100%; box-sizing:border-box;">
								<button class="btn btn-gps" id="gps-posicion" style="margin-left:0;margin-right:0;padding-left:6px;padding-right:6px;min-width:120px;max-width:140px;width:100%;box-sizing:border-box;">Posici√≥n</button>
								<button class="btn btn-gps" id="gps-guardar" style="margin-left:0;margin-right:0;padding-left:6px;padding-right:6px;min-width:120px;max-width:140px;width:100%;box-sizing:border-box;">Guardar</button>
								<button class="btn btn-gps" id="gps-destino" style="margin-left:0;margin-right:0;padding-left:6px;padding-right:6px;min-width:120px;max-width:140px;width:100%;box-sizing:border-box;">Destino</button>
							</div>
						</div>
						<div class="panel-bajo" style="margin-left:0;margin-right:0; padding-left:12px; padding-right:12px; width:100%; box-sizing:border-box;">
							<table class="tabla-indicadores" style="width:100%; max-width:340px; margin:0 auto; border-collapse:collapse; background:#23272b; border-radius:8px; box-shadow:0 1px 6px #0001; color:#f2f2f2;">
								<tbody>
									<tr>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<span id="indicador-conexion" class="desconectado">
												<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><circle cx="8" cy="8" r="7" fill="#e53935"/></svg>
												<span id="texto-conexion" style="color:#e53935; font-weight:600;">Desconectado</span>
											</span>
										</td>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><rect x="2" y="4" width="12" height="8" rx="2" fill="#6ec1e4"/></svg>
											RAM: <span id="ram-valor">--</span>
										</td>
									</tr>
									<tr>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><rect x="7" y="2" width="2" height="8" fill="#e6a23c"/><circle cx="8" cy="12" r="3" fill="#e6a23c"/></svg>
											Temp: <span id="temp-valor">--</span>
										</td>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><rect x="3" y="5" width="10" height="6" rx="2" fill="#43a047"/><rect x="13" y="7" width="2" height="2" fill="#43a047"/></svg>
											Bater√≠a: <span id="bat-valor">--</span>
										</td>
									</tr>
									<tr>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><circle cx="8" cy="8" r="7" fill="#6ec1e4"/></svg>
											Red: <span id="red-valor">--</span>
										</td>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><path d="M8 2 A6 6 0 1 1 7.99 2" stroke="#6ec1e4" stroke-width="2" fill="none"/><circle cx="8" cy="8" r="2" fill="#6ec1e4"/></svg>
											Velocidad: <span id="vel-valor">--</span>
										</td>
									</tr>
									<tr>
										<td style="border:1px solid #cfd8dc; padding:6px; text-align:center;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><circle cx="8" cy="8" r="4" fill="#ffd600"/></svg>
											Solar: <span id="solar-valor">--</span>
										</td>
										<td style="border:1px solid #cfd8dc; padding:6px; text-align:center;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><rect x="4" y="8" width="8" height="4" fill="#b71c1c"/></svg>
											Peso: <span id="peso-valor">--</span>
										</td>
									</tr>
									<tr>
										<td colspan="2" style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><circle cx="8" cy="8" r="7" fill="#6ec1e4"/></svg>
											Lat: <span id="gps-lat">--</span> Lon: <span id="gps-lon">--</span>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
			</div>
		</div>
	    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
	    <script>
		    // C√°mara 1 y 2

			   // --- Play/Stop y Captura ---
			   let hlsPlayers = { cam1: null, cam2: null };
			   let playing = { cam1: false, cam2: false };

			   function iniciarCamara(videoId, playlist, camKey) {
				   var video = document.getElementById(videoId);
				   if (window.Hls && Hls.isSupported()) {
					   if (hlsPlayers[camKey]) {
						   hlsPlayers[camKey].destroy();
					   }
					   var hls = new Hls({lowLatencyMode: true});
					   hls.loadSource(playlist);
					   hls.attachMedia(video);
					   hlsPlayers[camKey] = hls;
				   } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
					   video.src = playlist;
				   }
				   video.play();
				   playing[camKey] = true;
			   }

			   function detenerCamara(videoId, camKey) {
				   var video = document.getElementById(videoId);
				   if (window.Hls && Hls.isSupported() && hlsPlayers[camKey]) {
					   hlsPlayers[camKey].destroy();
					   hlsPlayers[camKey] = null;
				   }
				   video.pause();
				   video.removeAttribute('src');
				   video.load();
				   playing[camKey] = false;
			   }

			   function toggleCamara(videoId, playlist, camKey, btnId) {
				   const iconSpan = document.getElementById('icon' + btnId.charAt(0).toUpperCase() + btnId.slice(1));
				   if (!playing[camKey]) {
					   iniciarCamara(videoId, playlist, camKey);
					   // Cambia a icono de Stop
					   iconSpan.innerHTML = '<svg width="100%" height="100%" viewBox="0 0 22 22" fill="#e53935" style="display:block;"><rect x="6" y="6" width="10" height="10" rx="2"/></svg>';
				   } else {
					   detenerCamara(videoId, camKey);
					   // Cambia a icono de Play
					   iconSpan.innerHTML = '<svg width="100%" height="100%" viewBox="0 0 22 22" fill="#2196f3" style="display:block;"><polygon points="6,4 18,11 6,18"/></svg>';
				   }
			   }

			   document.getElementById('playCam1').onclick = function() {
				   toggleCamara('videoCam1', '/hls/cam1/cam1.m3u8', 'cam1', 'playCam1');
			   };
			   document.getElementById('playCam2').onclick = function() {
				   toggleCamara('videoCam2', '/hls/cam2/cam2.m3u8', 'cam2', 'playCam2');
			   };


			// --- Captura de Foto ---
			async function capturarFoto(videoId, camara) {
				const video = document.getElementById(videoId);
				if (video.readyState < 2) {
					alert('La c√°mara no est√° lista para capturar.');
					return;
				}
				const canvas = document.createElement('canvas');
				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				const ctx = canvas.getContext('2d');
				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
				const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
				try {
					const resp = await fetch('/api/captura_foto', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ imagen: dataUrl, camara })
					});
					const res = await resp.json();
					if (res.ok) {
						alert('Foto guardada: ' + res.archivo);
					} else {
						alert('Error al guardar foto: ' + (res.error || ''));
					}
				} catch (e) {
					alert('Error de red al guardar foto.');
				}
			}

			document.getElementById('captureCam1').onclick = function() {
				capturarFoto('videoCam1', 'cam1');
			};
			document.getElementById('captureCam2').onclick = function() {
				capturarFoto('videoCam2', 'cam2');
			};

			// --- Grabaci√≥n de Video ---
			let mediaRecorders = { cam1: null, cam2: null };
			let recordedChunks = { cam1: [], cam2: [] };
			let grabando = { cam1: false, cam2: false };

			async function grabarVideo(videoId, camara) {
				const video = document.getElementById(videoId);
				let stream = video.captureStream ? video.captureStream() : null;
				if (!stream) {
					alert('No se puede obtener el stream de video.');
					return;
				}
				if (grabando[camara]) {
					// Detener grabaci√≥n
					mediaRecorders[camara].stop();
					return;
				}
				recordedChunks[camara] = [];
				let options = { mimeType: 'video/webm;codecs=vp9' };
				let mediaRecorder = new MediaRecorder(stream, options);
				mediaRecorders[camara] = mediaRecorder;
				grabando[camara] = true;
				mediaRecorder.ondataavailable = function(e) {
					if (e.data.size > 0) recordedChunks[camara].push(e.data);
				};
				mediaRecorder.onstop = async function() {
					grabando[camara] = false;
					const blob = new Blob(recordedChunks[camara], { type: 'video/webm' });
					const reader = new FileReader();
					reader.onloadend = async function() {
						const base64data = reader.result;
						try {
							const resp = await fetch('/api/grabar_video', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify({ video: base64data, camara })
							});
							const res = await resp.json();
							if (res.ok) {
								alert('Video guardado: ' + res.archivo);
							} else {
								alert('Error al guardar video: ' + (res.error || ''));
							}
						} catch (e) {
							alert('Error de red al guardar video.');
						}
					};
					reader.readAsDataURL(blob);
				};
				mediaRecorder.start();
				alert('Grabando video... pulsa el bot√≥n nuevamente para detener y guardar.');
			}

			document.getElementById('grabar-cam1').onclick = function() {
				grabarVideo('videoCam1', 'cam1');
			};
			document.getElementById('grabar-cam2').onclick = function() {
				grabarVideo('videoCam2', 'cam2');
			};

			// WebSocket para indicadores y rel√©s
			let ws;
			let conectado = false;
			function beep(frec, dur, vol=0.2) {
				try {
					const ctx = new (window.AudioContext || window.webkitAudioContext)();
					const o = ctx.createOscillator();
					const g = ctx.createGain();
					o.type = 'sine';
					o.frequency.value = frec;
					g.gain.value = vol;
					o.connect(g); g.connect(ctx.destination);
					o.start();
					setTimeout(()=>{o.stop();ctx.close();}, dur);
				} catch(e) {}
			}
			function setConexion(estado) {
				const icon = document.querySelector('#indicador-conexion svg circle');
				const texto = document.getElementById('texto-conexion');
				   if (estado) {
					   icon.setAttribute('fill', '#43a047');
					   texto.textContent = 'Conectado';
					   texto.style.color = '#43a047';
					   beep(880, 120, 0.18); // Sonido de conexi√≥n
				   } else {
					   icon.setAttribute('fill', '#e53935');
					   texto.textContent = 'Desconectado';
					   texto.style.color = '#e53935';
					   beep(220, 220, 0.18); // Sonido de desconexi√≥n
				   }
			}
	function actualizarIndicadores(data) {
				// RAM
				if (data.ram && typeof data.ram.percent !== 'undefined') {
					document.getElementById('ram-valor').textContent = data.ram.percent + ' % (' + data.ram.used + 'MB/' + data.ram.total + 'MB)';
				} else {
					document.getElementById('ram-valor').textContent = '--';
				}
				// Temperatura
				if (data.temperatura && typeof data.temperatura.temperatura !== 'undefined') {
					document.getElementById('temp-valor').textContent = data.temperatura.temperatura + ' ¬∞C';
				} else {
					document.getElementById('temp-valor').textContent = '--';
				}
				// Bater√≠a
				if (data.bateria && typeof data.bateria.porcentaje !== 'undefined') {
					document.getElementById('bat-valor').textContent = data.bateria.porcentaje + ' %';
				} else {
					document.getElementById('bat-valor').textContent = '--';
				}
				// Red
				if (data.red !== undefined && data.red !== null) {
					document.getElementById('red-valor').textContent = Number(data.red).toFixed(1) + ' Mbps';
				} else {
					document.getElementById('red-valor').textContent = '--';
				}
				// Velocidad
				if (data.velocidad !== undefined && data.velocidad !== null) {
					document.getElementById('vel-valor').textContent = Number(data.velocidad).toFixed(2) + ' km/h';
				} else {
					document.getElementById('vel-valor').textContent = '--';
				}
				// Solar
				if (data.solar && typeof data.solar !== 'undefined') {
					document.getElementById('solar-valor').textContent = Number(data.solar).toFixed(1) + ' W';
				} else {
					document.getElementById('solar-valor').textContent = '--';
				}
				// Peso
				if (data.peso && typeof data.peso.peso_kg !== 'undefined') {
					document.getElementById('peso-valor').textContent = Number(data.peso.peso_kg).toFixed(2) + ' kg';
				} else {
					document.getElementById('peso-valor').textContent = '--';
				}
				// GPS Lat/Lon y mapa
				if (data.gps && data.gps.latitud && data.gps.longitud) {
					let lat = Number(data.gps.latitud);
					let lon = Number(data.gps.longitud);
					let gpsActivo = data.gps.valido === true;
					document.getElementById('gps-lat').textContent = isNaN(lat) ? '--' : lat.toFixed(1);
					document.getElementById('gps-lon').textContent = isNaN(lon) ? '--' : lon.toFixed(1);
					if (!isNaN(lat) && !isNaN(lon)) {
						mostrarMapaGPS(lat, lon, gpsActivo);
					}
				} else {
					document.getElementById('gps-lat').textContent = '--';
					document.getElementById('gps-lon').textContent = '--';
				}
			}
			// Rel√©s
			function renderReles(reles) {
				const contenedor = document.getElementById('reles-botones');
				contenedor.innerHTML = '';
				// Los nombres de los rel√©s se reciben por WebSocket en data.nombres_reles
				let nombresReles = window.nombres_reles || {};
				for (let i = 1; i <= 9; i++) {
					let nombre = nombresReles[i] || `Rel√© ${i}`;
					let activo = reles[i]?.estado ? 'activo' : 'inactivo';
					const btn = document.createElement('button');
					btn.className = `btn btn-rele btn-modern ${activo}`;
					btn.id = `rele${i}`;
					btn.innerHTML = `<span style='font-weight:600;'>${nombre}</span>`;
					btn.addEventListener('click', () => {
						if (window.ws && window.ws.readyState === 1) {
							window.ws.send(JSON.stringify({
								tipo: 'rele',
								numero: i,
								estado: !(reles[i]?.estado)
							}));
						}
					});
					contenedor.appendChild(btn);
				}
			}
	// toggleRele eliminado, todo se hace por WebSocket
			function conectarWS() {
				let wsProto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
				let wsUrl = wsProto + location.hostname + ':8080/ws';
				ws = new WebSocket(wsUrl);
				ws.onopen = function() {
					setConexion(true);
					conectado = true;
				};
				ws.onclose = function() {
					setConexion(false);
					conectado = false;
					setTimeout(conectarWS, 2000); // reconectar
				};
				ws.onerror = function() {
					setConexion(false);
				};
				ws.onmessage = function(event) {
					try {
						let data = JSON.parse(event.data);
						if (data.tipo === 'conexion' || data.tipo === 'datos') {
							if (data.nombres_reles) {
								window.nombres_reles = data.nombres_reles;
							}
							actualizarIndicadores(data);
							if (data.reles) {
								renderReles(data.reles);
							}
						}
						if (data.tipo === 'reles' && data.reles) {
							renderReles(data.reles);
						}
					} catch(e) {
						// Error de parseo
					}
				};
			}
			window.addEventListener('DOMContentLoaded', () => {
				conectarWS();
			});
	</script>
</body>
</html>
