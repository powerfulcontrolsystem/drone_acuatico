<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Remoto Digital - Drone Acu√°tico</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 3px;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Encabezado */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            margin-bottom: 4px;
            flex-shrink: 0;
        }
        
        h1 { font-size: 13px; margin: 0; font-weight: bold; }
        
        .info-sistema {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 9px;
        }
        
        .estado-conexion {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
        }
        
        .conectado { background: #4CAF50; }
        .desconectado { background: #f44336; }
        
        .indicador-ram, .indicador-temp, .indicador-bat {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            background: rgba(255, 255, 255, 0.15);
            font-family: monospace;
        }
        
        .ram-ok, .temp-ok, .bat-ok { background: rgba(76, 175, 80, 0.3); }
        .ram-warning, .temp-warning, .bat-warning { background: rgba(255, 152, 0, 0.3); }
        .ram-critical, .temp-critical, .bat-critical { background: rgba(244, 67, 54, 0.3); animation: parpadeo 1s infinite; }
        
        @keyframes parpadeo {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .btn-header {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 3px;
        }
        
        .btn-header:hover { background: rgba(255, 255, 255, 0.3); }
        
        /* Grid de vistas */
        .grid-vistas {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            margin-bottom: 4px;
            flex: 1;
            min-height: 0;
        }
        
        .vista-columna {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .vista-titulo {
            font-size: 9px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 3px;
            padding: 2px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .camara {
            background: #263238;
            border-radius: 5px;
            overflow: hidden;
            flex: 1;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 9px;
        }
        
        .camara img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #mapa {
            width: 100%;
            height: 100%;
            border-radius: 5px;
        }
        
        /* Panel de controles */
        .panel-controles {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            padding: 4px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .seccion-control {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            padding: 4px;
        }
        
        .seccion-control h3 {
            font-size: 9px;
            margin: 0 0 3px 0;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 2px;
        }
        
        /* Rel√©s */
        .grid-reles {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
        }
        
        button {
            padding: 4px;
            border: none;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-rele {
            background: #607D8B;
            font-size: 8px;
            padding: 5px 3px;
        }
        
        .btn-rele.activo { background: #4CAF50; }
        
        /* Control de movimiento */
        .control-movimiento {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
        }
        
        .btn-direccion {
            background: #1a1a1a;
            color: white;
            padding: 8px;
            font-size: 12px;
            border: 2px solid #333;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .btn-direccion:hover {
            background: #333;
            transform: scale(1.05);
        }
        
        .btn-parar {
            background: #f44336;
            border-color: #d32f2f;
        }
        
        .btn-parar:hover {
            background: #d32f2f;
        }
        
        .btn-fila-lateral {
            display: flex;
            gap: 2px;
            justify-content: center;
        }
        
        .columna-velocidad {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-left: 5px;
        }
        
        .btn-velocidad {
            background: #2196F3;
            border: 2px solid #1976D2;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            cursor: pointer;
            min-width: 40px;
        }
        
        .btn-velocidad:hover { background: #1976D2; }
        .btn-velocidad.activo { background: #0D47A1; border-color: #0D47A1; }
        
        /* GPS */
        .gps-actions {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
        }

        .btn-gps {
            background: #FF9800;
            margin-top: 0;
            font-size: 11px;
            padding: 6px 8px;
        }
        
        .control-movimiento-wrapper {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
        }
        /* Notificaciones no intrusivas */
        .toast { position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.35); }
        .toast.show { display: block; }
        .toast.ok { background: rgba(76,175,80,0.92); }
        .toast.warn { background: rgba(255,152,0,0.92); }
        .toast.err { background: rgba(244,67,54,0.92); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üö§ Control Remoto Digital</h1>
            <div class="info-sistema">
                <span id="estado-conexion" class="estado-conexion desconectado">‚óè Desconectado</span>
                <span id="indicador-ram" class="indicador-ram">RAM: --</span>
                <span id="indicador-temp" class="indicador-temp">Temp: --</span>
                <span id="indicador-bat" class="indicador-bat">Bat: --</span>
            </div>
            <div>
                <button class="btn-header" onclick="toggleFullScreen()" title="Pantalla completa">‚õ∂</button>
                <button class="btn-header" onclick="irConfiguracion()">‚öôÔ∏è Config</button>
                <button class="btn-header" onclick="apagarRaspberry()" title="Apagar">üî¥</button>
                <button class="btn-header" onclick="reiniciarRaspberry()" title="Reiniciar">üîÑ</button>
            </div>
        </header>

        <div class="grid-vistas">
            <div class="vista-columna">
                <div class="vista-titulo">üìπ C√°mara 1</div>
                <div class="camara" id="camara1">
                    <div>
                        <div style="font-size:10px; margin-bottom:4px;">
                            <label style="margin-right:6px;">Calidad:</label>
                            <select id="calidadCam1" style="font-size:11px; padding:2px 4px; border-radius:4px;">
                                <option value="sd">SD</option>
                                <option value="hd" selected>HD/2K</option>
                            </select>
                        </div>
                        <a id="linkCamara1" href="#" style="color:#B2FF59; font-size:11px;">rtsp://...</a>
                        <div style="margin-top:6px;">
                            <video id="videoCam1" controls muted playsinline style="max-height:180px; width:100%; background:#000; border-radius:4px"></video>
                        </div>
                        <div style="display:flex; gap:4px; margin-top:6px; justify-content:center;">
                            <button class="btn-header" onclick="iniciarCamara(1)">‚ñ∂Ô∏è Iniciar</button>
                            <button class="btn-header" onclick="detenerCamara(1)">‚èπÔ∏è Detener</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="vista-columna" style="border-left:1px solid rgba(255,255,255,0.25); padding-left:8px;">
                <div class="vista-titulo">üìπ C√°mara 2 (2K por defecto)</div>
                <div class="camara" id="camara2">
                    <div>
                        <div style="font-size:10px; margin-bottom:4px;">
                            <label style="margin-right:6px;">Calidad:</label>
                            <select id="calidadCam2" style="font-size:11px; padding:2px 4px; border-radius:4px;">
                                <option value="sd">SD</option>
                                <option value="hd" selected>HD/2K</option>
                            </select>
                        </div>
                        <a id="linkCamara2" href="#" style="color:#B2FF59; font-size:11px;">rtsp://...</a>
                        <div style="margin-top:6px;">
                            <video id="videoCam2" controls muted playsinline style="max-height:180px; width:100%; background:#000; border-radius:4px"></video>
                        </div>
                        <div style="display:flex; gap:4px; margin-top:6px; justify-content:center;">
                            <button class="btn-header" onclick="iniciarCamara(2)">‚ñ∂Ô∏è Iniciar</button>
                            <button class="btn-header" onclick="detenerCamara(2)">‚èπÔ∏è Detener</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="vista-columna">
                <div class="vista-titulo">
                    <span style="float: left;">üó∫Ô∏è Mapa</span>
                    <span style="float: right; font-size: 7px;">
                        Lat: <span id="latitud">---</span> | Lon: <span id="longitud">---</span>
                    </span>
                    <div style="clear: both;"></div>
                </div>
                <div id="mapa"></div>
            </div>
        </div>

        <div class="panel-controles">
            <!-- Control de Movimiento -->
            <div class="seccion-control">
                <h3>üéÆ MOVIMIENTO</h3>
                <div class="control-movimiento-wrapper">
                    <div class="control-movimiento">
                        <button class="btn-direccion" onmousedown="moverDrone('adelante')" onmouseup="pararDrone()">‚ñ≤</button>
                        <div class="btn-fila-lateral">
                            <button class="btn-direccion" onmousedown="moverDrone('izquierda')" onmouseup="pararDrone()">‚óÄ</button>
                            <button class="btn-direccion btn-parar" onclick="pararDrone()">‚ñ†</button>
                            <button class="btn-direccion" onmousedown="moverDrone('derecha')" onmouseup="pararDrone()">‚ñ∂</button>
                        </div>
                        <button class="btn-direccion" onmousedown="moverDrone('atras')" onmouseup="pararDrone()">‚ñº</button>
                    </div>
                    <div class="columna-velocidad">
                        <button class="btn-velocidad activo" onclick="setVelocidad(1)">V1</button>
                        <button class="btn-velocidad" onclick="setVelocidad(2)">V2</button>
                        <button class="btn-velocidad" onclick="setVelocidad(3)">V3</button>
                    </div>
                </div>
            </div>

            <!-- Rel√©s -->
            <div class="seccion-control">
                <h3>‚ö° REL√âS</h3>
                <div class="grid-reles">
                    <button class="btn-rele" onclick="toggleRele(1)">R1</button>
                    <button class="btn-rele" onclick="toggleRele(2)">R2</button>
                    <button class="btn-rele" onclick="toggleRele(3)">R3</button>
                    <button class="btn-rele" onclick="toggleRele(4)">R4</button>
                    <button class="btn-rele" onclick="toggleRele(5)">R5</button>
                    <button class="btn-rele" onclick="toggleRele(6)">R6</button>
                    <button class="btn-rele" onclick="toggleRele(7)">R7</button>
                    <button class="btn-rele" onclick="toggleRele(8)">R8</button>
                    <button class="btn-rele" onclick="toggleRele(9)">R9</button>
                </div>
            </div>

            <!-- GPS -->
            <div class="seccion-control">
                <h3>üó∫Ô∏è GPS</h3>
                <div class="gps-actions">
                    <button class="btn-gps" onclick="guardarUbicacion()">üíæ Guardar Ubicaci√≥n</button>
                    <button class="btn-gps" onclick="irADestino()">üìç Ir a Destino</button>
                    <button class="btn-gps" onclick="mostrarRuta()">üõ£Ô∏è Ver Recorrido</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        let ws = null;
        let estadoReles = {};
        let mapa = null;
        let __toastTimer = null;

        function mostrarToast(texto, tipo = 'ok') {
            const t = document.getElementById('toast');
            if (!t) return;
            t.textContent = texto;
            t.className = 'toast show ' + (tipo === 'warn' ? 'warn' : tipo === 'err' ? 'err' : 'ok');
            clearTimeout(__toastTimer);
            __toastTimer = setTimeout(() => { t.className = 'toast'; }, 2500);
        }
        let marcadorGPS = null;
        let marcadorActual = null;
        let velocidadActual = 50;

        // Conectar WebSocket
        function conectarWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket conectado');
                document.getElementById('estado-conexion').textContent = '‚óè Conectado';
                document.getElementById('estado-conexion').className = 'estado-conexion conectado';
                enviarMensaje({ tipo: 'obtener_datos' });
                enviarMensaje({ tipo: 'obtener_config' });
            };

            ws.onmessage = function(event) {
                const datos = JSON.parse(event.data);
                procesarMensaje(datos);
            };

            ws.onclose = function() {
                console.log('WebSocket desconectado');
                document.getElementById('estado-conexion').textContent = '‚óè Desconectado';
                document.getElementById('estado-conexion').className = 'estado-conexion desconectado';
                setTimeout(conectarWebSocket, 3000);
            };

            ws.onerror = function(error) {
                console.error('Error WebSocket:', error);
            };
        }

        function enviarMensaje(datos) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(datos));
            }
        }

        function procesarMensaje(datos) {
            console.log('Mensaje:', datos);
            
            switch(datos.tipo) {
                case 'conexion':
                    console.log('‚úì Conectado');
                    break;
                    
                case 'respuesta_rele':
                    if (datos.exito) {
                        console.log(`‚úì Rel√© ${datos.numero}: ${datos.estado}`);
                    }
                    break;
                    
                case 'ram':
                    actualizarRAM(datos.datos);
                    break;
                    
                case 'temperatura':
                    actualizarTemperatura(datos.datos);
                    break;
                    
                case 'bateria':
                    actualizarBateria(datos.datos);
                    break;

                case 'gps':
                    actualizarGPS(datos.datos);
                    break;

                case 'config_actual':
                    aplicarConfig(datos.datos || {});
                    break;

                case 'camara':
                    manejarRespuestaCamara(datos);
                    break;

                case 'respuesta_gps':
                    mostrarToast(datos.mensaje || (datos.exito ? 'Ubicaci√≥n guardada' : 'No se pudo guardar'), datos.exito ? 'ok' : 'err');
                    break;
            }
        }

        function actualizarRAM(datos) {
            const elem = document.getElementById('indicador-ram');
            elem.textContent = `üíæ ${datos.used}/${datos.total}MB (${datos.percent}%)`;
            elem.className = 'indicador-ram';
            if (datos.percent < 70) elem.classList.add('ram-ok');
            else if (datos.percent < 85) elem.classList.add('ram-warning');
            else elem.classList.add('ram-critical');
        }

        function actualizarTemperatura(datos) {
            const elem = document.getElementById('indicador-temp');
            elem.textContent = `üå°Ô∏è ${datos.temperatura}¬∞C`;
            elem.className = 'indicador-temp';
            if (datos.temperatura < 60) elem.classList.add('temp-ok');
            else if (datos.temperatura < 75) elem.classList.add('temp-warning');
            else elem.classList.add('temp-critical');
        }

        function actualizarBateria(datos) {
            const elem = document.getElementById('indicador-bat');
            const icono = datos.estado === "cargando" ? 'üîå' : 'üîã';
            elem.textContent = `${icono} ${datos.porcentaje}%`;
            elem.className = 'indicador-bat';
            if (datos.porcentaje > 50) elem.classList.add('bat-ok');
            else if (datos.porcentaje > 20) elem.classList.add('bat-warning');
            else elem.classList.add('bat-critical');
        }

        function toggleRele(numero) {
            const boton = event.target;
            const nuevoEstado = !estadoReles[numero];
            estadoReles[numero] = nuevoEstado;

            if (nuevoEstado) boton.classList.add('activo');
            else boton.classList.remove('activo');

            enviarMensaje({ tipo: 'rele', numero: numero, estado: nuevoEstado });
        }

        function moverDrone(direccion) {
            enviarMensaje({ tipo: 'motor', direccion: direccion });
        }

        function pararDrone() {
            enviarMensaje({ tipo: 'motor', direccion: 'parar' });
        }

        function setVelocidad(nivel) {
            velocidadActual = nivel * 33;
            enviarMensaje({ tipo: 'velocidad', nivel: velocidadActual });
            
            document.querySelectorAll('.btn-velocidad').forEach(btn => btn.classList.remove('activo'));
            event.target.classList.add('activo');
        }

        function guardarUbicacion() {
            enviarMensaje({ tipo: 'gps_guardar' });
        }

        function irADestino() {
            mostrarToast('Funci√≥n en desarrollo: Navegar a destino', 'warn');
        }

        function mostrarRuta() {
            mostrarToast('Funci√≥n en desarrollo: Mostrar recorrido', 'warn');
        }

        function iniciarCamara(indice) {
            const calidad = document.getElementById(`calidadCam${indice}`).value;
            enviarMensaje({ tipo: 'camara', accion: 'iniciar', indice, calidad });
        }

        function detenerCamara(indice) {
            enviarMensaje({ tipo: 'camara', accion: 'detener', indice });
        }

        function manejarRespuestaCamara(datos) {
            const i = datos.indice;
            const exito = !!datos.exito;
            if (datos.accion === 'iniciar') {
                const videoEl = i === 1 ? document.getElementById('videoCam1') : document.getElementById('videoCam2');
                const playlist = i === 1 ? '/hls/cam1/cam1.m3u8' : '/hls/cam2/cam2.m3u8';
                if (exito) {
                    inicializarHLS(videoEl, playlist);
                } else {
                    mostrarToast('No se pudo iniciar la c√°mara ' + i, 'err');
                }
            } else if (datos.accion === 'detener') {
                const videoEl = i === 1 ? document.getElementById('videoCam1') : document.getElementById('videoCam2');
                try {
                    videoEl.pause();
                    videoEl.removeAttribute('src');
                } catch (e) {}
            }
        }

        function irConfiguracion() {
            window.location.href = '/configuracion.html';
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function apagarRaspberry() {
            if (confirm('¬øApagar Raspberry Pi?')) {
                enviarMensaje({ tipo: 'sistema', comando: 'apagar' });
            }
        }

        function reiniciarRaspberry() {
            if (confirm('¬øReiniciar Raspberry Pi?')) {
                enviarMensaje({ tipo: 'sistema', comando: 'reiniciar' });
            }
        }


        function actualizarGPS(datos) {
            if (!mapa || !datos.lat || !datos.lon) return;
            
            const lat = parseFloat(datos.lat);
            const lon = parseFloat(datos.lon);
            
            // Crear o actualizar marcador
            if (!marcadorGPS) {
                marcadorGPS = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'marcador-gps',
                        html: '<div style="background: #ff4444; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 0 10px rgba(255,68,68,0.8);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(mapa);
                
                marcadorGPS.bindPopup('<b>Posici√≥n Drone</b><br>Cargando datos GPS...');
                
                // Centrar mapa en primera lectura GPS v√°lida
                mapa.setView([lat, lon], 17);
                console.log('GPS inicializado en:', lat, lon);
            } else {
                // Actualizar posici√≥n del marcador
                marcadorGPS.setLatLng([lat, lon]);
                
                // Seguir el drone autom√°ticamente
                mapa.panTo([lat, lon]);
            }
            
            // Actualizar popup con datos actuales
            const popupContent = `
                <b>üö§ Posici√≥n Drone</b><br>
                <b>Lat:</b> ${lat.toFixed(6)}<br>
                <b>Lon:</b> ${lon.toFixed(6)}<br>
                <b>Alt:</b> ${datos.alt || 0}m<br>
                <b>Sat√©lites:</b> ${datos.satelites || 0}<br>
                <b>Velocidad:</b> ${(datos.velocidad || 0).toFixed(1)} km/h
            `;
            marcadorGPS.getPopup().setContent(popupContent);
            
            console.log(`GPS actualizado: ${lat.toFixed(6)}, ${lon.toFixed(6)} - ${datos.satelites} sats`);
        }

        function inicializarMapa() {
            mapa = L.map('mapa').setView([4.6097, -74.0817], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(mapa);
        }

        function aplicarConfig(cfg) {
            try {
                // C√°mara 1
                const des1 = !!cfg.desactivar_camara1;
                const url1_sd = (cfg.url_camara1_sd || '').trim();
                const url1_hd = (cfg.url_camara1_hd || '').trim();
                const link1 = document.getElementById('linkCamara1');
                const cam1 = document.getElementById('camara1');
                const v1 = document.getElementById('videoCam1');
                const sel1 = document.getElementById('calidadCam1');
                
                if (des1 || (!url1_sd && !url1_hd)) {
                    link1.textContent = 'C√°mara 1 desactivada';
                    link1.removeAttribute('href');
                    cam1.style.opacity = 0.6;
                    v1.removeAttribute('src');
                } else {
                    const urlMostrar = url1_sd || url1_hd;
                    link1.textContent = urlMostrar;
                    link1.setAttribute('href', urlMostrar);
                    cam1.style.opacity = 1.0;
                    inicializarHLS(v1, '/hls/cam1/cam1.m3u8');
                    
                    // Habilitar/deshabilitar opciones seg√∫n disponibilidad
                    if (!url1_hd) sel1.querySelector('[value="hd"]').disabled = true;
                    if (!url1_sd) sel1.querySelector('[value="sd"]').disabled = true;
                    // Seleccionar HD/2K por defecto si est√° disponible
                    sel1.value = url1_hd ? 'hd' : 'sd';
                }

                // C√°mara 2
                const des2 = !!cfg.desactivar_camara2;
                const url2_sd = (cfg.url_camara2_sd || '').trim();
                const url2_hd = (cfg.url_camara2_hd || '').trim();
                const link2 = document.getElementById('linkCamara2');
                const cam2 = document.getElementById('camara2');
                const v2 = document.getElementById('videoCam2');
                const sel2 = document.getElementById('calidadCam2');
                
                if (des2 || (!url2_sd && !url2_hd)) {
                    link2.textContent = 'C√°mara 2 desactivada';
                    link2.removeAttribute('href');
                    cam2.style.opacity = 0.6;
                    v2.removeAttribute('src');
                } else {
                    const urlMostrar = url2_sd || url2_hd;
                    link2.textContent = urlMostrar;
                    link2.setAttribute('href', urlMostrar);
                    cam2.style.opacity = 1.0;
                    inicializarHLS(v2, '/hls/cam2/cam2.m3u8');
                    
                    // Habilitar/deshabilitar opciones seg√∫n disponibilidad
                    if (!url2_hd) sel2.querySelector('[value="hd"]').disabled = true;
                    if (!url2_sd) sel2.querySelector('[value="sd"]').disabled = true;
                    // Seleccionar HD/2K por defecto si est√° disponible
                    sel2.value = url2_hd ? 'hd' : 'sd';
                }
            } catch (e) {
                console.error('Error aplicando configuraci√≥n:', e);
            }
        }

        window.onload = function() {
            inicializarMapa();
            conectarWebSocket();
        };

        function inicializarHLS(videoEl, playlistUrl) {
            try {
                if (Hls.isSupported()) {
                    const hls = new Hls({ lowLatencyMode: true });
                    hls.loadSource(playlistUrl);
                    hls.attachMedia(videoEl);
                } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
                    videoEl.src = playlistUrl;
                }
            } catch (e) {
                console.error('Error inicializando HLS:', e);
            }
        }
    </script>
    <div id="toast" class="toast"></div>
</body>
</html>
