<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Remoto Digital - Drone Acu√°tico</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="tema.css?v=20251229b">
        <style>
            body {
                margin: 0;
                padding: 0;
                background: #181f2a;
                color: #e8edef;
                font-family: var(--font-family, Arial, sans-serif);
            }
            .container {
                max-width: 100vw;
                height: 100vh;
                display: flex;
                flex-direction: column;
                background: #1a2332;
                border-radius: 8px;
                box-shadow: 0 4px 24px rgba(0,0,0,0.25);
            }
            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 18px 24px 12px 24px;
                margin-bottom: 18px;
                background: #232e43;
                border-radius: 0 0 12px 12px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            }
            h1 {
                font-size: 22px;
                margin: 0;
                font-weight: 700;
                color: #4a9eff;
                letter-spacing: 0.01em;
            }
            .info-sistema {
                display: flex;
                gap: 8px;
                align-items: center;
                flex-wrap: wrap;
                font-size: 13px;
            }
            .estado-conexion {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 6px 10px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
            }
            .dropdown { position: relative; display: inline-block; }
            .dropdown-menu { position: absolute; right: 0; top: 100%; min-width: 160px; padding: 6px; display: none; z-index: 2000; border-radius: 8px; margin-top: 4px; }
            .dropdown.open .dropdown-menu { display: block; }
            .btn-menu { width: 100%; padding: 8px 10px; border-radius: 6px; font-size: 13px; cursor: pointer; text-align: left; border: 1px solid transparent; font-weight: 500; }
            .grid-vistas {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 14px;
                margin-bottom: 14px;
                flex: 1;
                min-height: 0;
            }
            .vista-columna {
                display: flex;
                flex-direction: column;
                min-height: 0;
                overflow: hidden;
                background: #232e43;
                border-radius: 12px;
                padding: 12px 10px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            }
            .vista-titulo {
                font-size: 14px;
                margin-bottom: 10px;
                padding: 8px;
                flex-shrink: 0;
                background: #28334a;
                border-radius: 6px;
                color: #b0b8c2;
                font-weight: 700;
            }
            .camara {
                overflow: hidden;
                flex: 1;
                min-height: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 13px;
                background: #181f2a;
                border-radius: 8px;
                color: #8a92a0;
            }
            .camara img { width: 100%; height: 100%; object-fit: cover; }
            #mapa {
                width: 100%;
                height: 100%;
                background: #181f2a;
                border-radius: 8px;
            }
            .panel-controles {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-shrink: 0;
                padding: 18px;
                background: #232e43 !important;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.10);
                margin-bottom: 18px;
            }
            .contenedor-controles {
                padding: 0;
                display: grid;
                grid-template-columns: auto auto auto auto;
                gap: 18px;
                align-items: start;
            }
            .seccion-control {
                display: flex;
                flex-direction: column;
                min-width: 120px;
                background: #28334a;
                border-radius: 8px;
                padding: 16px 12px 12px 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                margin-bottom: 0;
                border: 1.5px solid #2a3748;
            }
            .seccion-control h3 {
                font-size: 14px;
                margin: 0 0 12px 0;
                text-align: center;
                padding-bottom: 8px;
                font-weight: 700;
                color: #b0b8c2;
                border-bottom: 1.5px solid #2a3748;
            }
            .grid-reles { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .control-movimiento { display: flex; flex-direction: column; gap: 10px; align-items: center; }
            .btn-direccion {
                padding: 12px;
                font-size: 18px;
                width: 52px;
                height: 52px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                background: #1a2332;
                color: #4a9eff;
                border: none;
                border-radius: 50%;
                box-shadow: 0 2px 8px rgba(0,0,0,0.10);
                font-weight: 700;
                transition: background 0.18s, color 0.18s, transform 0.12s;
            }
            .btn-direccion:hover {
                background: #4a9eff;
                color: #fff;
                transform: scale(1.08);
            }
            .btn-fila-lateral { display: flex; gap: 10px; justify-content: center; }
            .columna-velocidad { display: flex; flex-direction: column; gap: 10px; }
            .gps-actions { display: flex; flex-direction: column; gap: 10px; align-items: stretch; }
            .btn-header { font-size: 13px; padding: 8px 14px; border-radius: 999px; background: linear-gradient(90deg, #4a9eff 60%, #6a8cff 100%); color: #fff; border: none; font-weight: 600; box-shadow: 0 2px 8px rgba(74,158,255,0.10); cursor: pointer; transition: background 0.18s, box-shadow 0.18s, transform 0.12s; outline: none; letter-spacing: 0.02em; position: relative; z-index: 1; }
            .btn-header:hover { background: linear-gradient(90deg, #3a8ae5 60%, #4a9eff 100%); box-shadow: 0 4px 16px rgba(74,158,255,0.18); transform: translateY(-2px) scale(1.04); }
            .btn-header:active { transform: scale(0.98); box-shadow: 0 1px 3px rgba(74,158,255,0.10); }
            button { transition: all 0.2s ease; }
            button:active { transform: translateY(1px); }
            .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 16px; font-size: 13px; z-index: 9999; display: none; font-weight: 500; background: #232e43; color: #4a9eff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.10); }
            .toast.show { display: block; }
            @media (max-width: 900px) {
                .grid-vistas { grid-template-columns: 1fr; }
                .contenedor-controles { grid-template-columns: 1fr; }
            }
            @media (max-width: 600px) {
                .container { padding: 0 2px; }
                .vista-columna, .panel-controles, .seccion-control { padding: 8px 2px; }
                .vista-titulo { font-size: 12px; }
            }
        </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üö§ Control Remoto Digital</h1>
            <div class="info-sistema">
                <span id="estado-conexion" class="estado-conexion desconectado">‚óè Desconectado</span>
                <span id="indicador-ram" class="indicador-ram">RAM: --</span>
                <span id="indicador-temp" class="indicador-temp">Temp: --</span>
                <span id="indicador-red" class="indicador-red">Red: --</span>
                <span id="indicador-bat" class="indicador-bat">Bat: --</span>
                <span id="indicador-vel" class="indicador-vel">Vel: -- km/h</span>
            </div>
            <div style="display: flex; gap: 6px; align-items: center;">
                <button class="btn-header" onclick="toggleFullScreen()" title="Pantalla completa">‚õ∂</button>
                <div class="dropdown" id="power-dropdown">
                    <button class="btn-header" onclick="togglePowerMenu(event)" title="Opciones">‚öôÔ∏è</button>
                    <div class="dropdown-menu" id="menu-power">
                        <button class="btn-menu" onclick="irConfiguracion()">‚öôÔ∏è Configuraci√≥n</button>
                        <button class="btn-menu" onclick="reiniciarRaspberry()">üîÑ Reiniciar</button>
                        <button class="btn-menu" onclick="apagarRaspberry()">üî¥ Apagar</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid-vistas">
            <div class="vista-columna">
                <div class="vista-titulo">üìπ C√°mara 1</div>
                <div class="camara" id="camara1">
                    <div>
                        <div style="font-size:10px; margin-bottom:4px;">
                            <label style="margin-right:6px;">Calidad:</label>
                            <select id="calidadCam1" style="font-size:11px; padding:2px 4px; border-radius:4px;">
                                <option value="sd">SD</option>
                                <option value="hd" selected>HD/2K</option>
                            </select>
                        </div>
                        <a id="linkCamara1" href="#" style="color:#B2FF59; font-size:11px;">rtsp://...</a>
                        <div style="margin-top:6px;">
                            <video id="videoCam1" controls muted playsinline style="max-height:180px; width:100%; background:#000; border-radius:4px"></video>
                        </div>
                        <div style="display:flex; gap:4px; margin-top:6px; justify-content:center;">
                            <button class="btn-header" onclick="iniciarCamara(1)">‚ñ∂Ô∏è Iniciar</button>
                            <button class="btn-header" onclick="detenerCamara(1)">‚èπÔ∏è Detener</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="vista-columna" style="border-left:1px solid rgba(255,255,255,0.25); padding-left:8px;">
                <div class="vista-titulo">üìπ C√°mara 2 (2K por defecto)</div>
                <div class="camara" id="camara2">
                    <div>
                        <div style="font-size:10px; margin-bottom:4px;">
                            <label style="margin-right:6px;">Calidad:</label>
                            <select id="calidadCam2" style="font-size:11px; padding:2px 4px; border-radius:4px;">
                                <option value="sd">SD</option>
                                <option value="hd" selected>HD/2K</option>
                            </select>
                        </div>
                        <a id="linkCamara2" href="#" style="color:#B2FF59; font-size:11px;">rtsp://...</a>
                        <div style="margin-top:6px;">
                            <video id="videoCam2" controls muted playsinline style="max-height:180px; width:100%; background:#000; border-radius:4px"></video>
                        </div>
                        <div style="display:flex; gap:4px; margin-top:6px; justify-content:center;">
                            <button class="btn-header" onclick="iniciarCamara(2)">‚ñ∂Ô∏è Iniciar</button>
                            <button class="btn-header" onclick="detenerCamara(2)">‚èπÔ∏è Detener</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="vista-columna">
                <div class="vista-titulo">
                    <span style="float: left;">üó∫Ô∏è Mapa</span>
                    <span style="float: right; font-size: 7px;">
                        Lat: <span id="latitud">---</span> | Lon: <span id="longitud">---</span>
                    </span>
                    <div style="clear: both;"></div>
                </div>
                <div id="mapa"></div>
            </div>
        </div>

        <div class="panel-controles">
            <div class="contenedor-controles">
                <!-- Control de Movimiento -->
                <div class="seccion-control">
                    <h3>üéÆ MOVIMIENTO</h3>
                    <div class="control-movimiento">
                        <button class="btn-direccion" onmousedown="moverDrone('adelante')" onmouseup="pararDrone()">‚ñ≤</button>
                        <div class="btn-fila-lateral">
                            <button class="btn-direccion" onmousedown="moverDrone('izquierda')" onmouseup="pararDrone()">‚óÄ</button>
                            <button class="btn-direccion btn-parar" onclick="pararDrone()">‚ñ†</button>
                            <button class="btn-direccion" onmousedown="moverDrone('derecha')" onmouseup="pararDrone()">‚ñ∂</button>
                        </div>
                        <button class="btn-direccion" onmousedown="moverDrone('atras')" onmouseup="pararDrone()">‚ñº</button>
                    </div>
                </div>

                <!-- Control de Velocidad -->
                <div class="seccion-control">
                    <h3>‚ö° VELOCIDAD</h3>
                    <div class="columna-velocidad">
                        <button class="btn-velocidad activo" onclick="setVelocidad(1)">V1</button>
                        <button class="btn-velocidad" onclick="setVelocidad(2)">V2</button>
                        <button class="btn-velocidad" onclick="setVelocidad(3)">V3</button>
                    </div>
                </div>

                <!-- Rel√©s -->
                <div class="seccion-control">
                    <h3>‚ö° REL√âS</h3>
                    <div class="grid-reles">
                        <button class="btn-rele" onclick="toggleRele(1)">R1</button>
                        <button class="btn-rele" onclick="toggleRele(2)">R2</button>
                        <button class="btn-rele" onclick="toggleRele(3)">R3</button>
                        <button class="btn-rele" onclick="toggleRele(4)">R4</button>
                        <button class="btn-rele" onclick="toggleRele(5)">R5</button>
                        <button class="btn-rele" onclick="toggleRele(6)">R6</button>
                        <button class="btn-rele" onclick="toggleRele(7)">R7</button>
                        <button class="btn-rele" onclick="toggleRele(8)">R8</button>
                        <button class="btn-rele" onclick="toggleRele(9)">R9</button>
                    </div>
                </div>

                <!-- GPS -->
                <div class="seccion-control">
                    <h3>üó∫Ô∏è GPS</h3>
                    <div class="gps-actions">
                        <button class="btn-gps" onclick="guardarUbicacion()">üíæ Guardar Ubicaci√≥n</button>
                        <button class="btn-gps" onclick="irADestino()">üìç Ir a Destino</button>
                        <button class="btn-gps" onclick="mostrarRuta()">üõ£Ô∏è Ver Recorrido</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        let ws = null;
        let estadoReles = {};
        let mapa = null;
        let __toastTimer = null;
        let audioCtx = null;
        let menuPowerAbierto = false;
        let wasDesconectado = false;
        let intervaloPitidoDesconectado = null;

        function mostrarToast(texto, tipo = 'ok') {
            const t = document.getElementById('toast');
            if (!t) return;
            t.textContent = texto;
            t.className = 'toast show ' + (tipo === 'warn' ? 'warn' : tipo === 'err' ? 'err' : 'ok');
            clearTimeout(__toastTimer);
            __toastTimer = setTimeout(() => { t.className = 'toast'; }, 2500);
        }
        let marcadorGPS = null;
        let marcadorActual = null;
        let velocidadActual = 50;

        function reproducirBeep(freq = 900, durMs = 220, wave = 'sine') {
            try {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                if (!Ctx) return;
                if (!audioCtx) audioCtx = new Ctx();
                if (audioCtx.state === 'suspended') audioCtx.resume();

                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = wave;
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + durMs / 1000);

                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + durMs / 1000);
            } catch (e) {
                console.warn('No se pudo reproducir sonido', e);
            }
        }

        // Conectar WebSocket
        function conectarWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket conectado');
                document.getElementById('estado-conexion').textContent = '‚óè Conectado';
                document.getElementById('estado-conexion').className = 'estado-conexion conectado';
                
                // Detener pitido peri√≥dico si exist√≠a
                if (intervaloPitidoDesconectado) {
                    clearInterval(intervaloPitidoDesconectado);
                    intervaloPitidoDesconectado = null;
                }
                
                // Sonido: beep LARGO al conectar (500ms)
                if (wasDesconectado) {
                    // Reconexi√≥n: doble beep largo y fuerte
                    reproducirBeep(880, 500, 'sine');
                    setTimeout(() => reproducirBeep(1000, 500, 'sine'), 600);
                    mostrarToast('‚úì Reconectado a la red', 'ok');
                    wasDesconectado = false;
                } else {
                    // Conexi√≥n inicial: beep largo
                    reproducirBeep(960, 500, 'triangle');
                }
                
                enviarMensaje({ tipo: 'obtener_datos' });
                enviarMensaje({ tipo: 'obtener_config' });
            };

            ws.onmessage = function(event) {
                const datos = JSON.parse(event.data);
                procesarMensaje(datos);
            };

            ws.onclose = function() {
                console.log('WebSocket desconectado');
                // Sonido LARGO de desconexi√≥n (600ms)
                reproducirBeep(360, 600, 'sawtooth');
                
                document.getElementById('estado-conexion').textContent = '‚óè Desconectado';
                document.getElementById('estado-conexion').className = 'estado-conexion desconectado';
                wasDesconectado = true;
                mostrarToast('‚úó Desconectado, reintentando...', 'warn');
                
                // Iniciar pitido peri√≥dico cada 5 segundos mientras est√© desconectado
                if (!intervaloPitidoDesconectado) {
                    intervaloPitidoDesconectado = setInterval(() => {
                        // Pitido corto cada 5 segundos
                        reproducirBeep(440, 200, 'square');
                    }, 5000);
                }
                
                setTimeout(conectarWebSocket, 3000);
            };

            ws.onerror = function(error) {
                console.error('Error WebSocket:', error);
            };
        }

        function togglePowerMenu(event) {
            event.stopPropagation();
            const dd = document.getElementById('power-dropdown');
            if (!dd) return;
            const abierto = dd.classList.toggle('open');
            menuPowerAbierto = abierto;
        }

        function cerrarPowerMenu() {
            const dd = document.getElementById('power-dropdown');
            if (!dd) return;
            dd.classList.remove('open');
            menuPowerAbierto = false;
        }

        function enviarMensaje(datos) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(datos));
            }
        }

        function procesarMensaje(datos) {
            console.log('Mensaje:', datos);
            
            switch(datos.tipo) {
                case 'conexion':
                    console.log('‚úì Conectado');
                    if (datos.gps) actualizarGPS(datos.gps);
                    if (datos.nombres_reles) aplicarNombresReles(datos.nombres_reles);
                    if (datos.reles) aplicarEstadosReles(datos.reles);
                    break;
                    
                case 'respuesta_rele':
                    if (datos.exito) {
                        console.log(`‚úì Rel√© ${datos.numero}: ${datos.estado}`);
                    }
                    break;
                    
                case 'ram':
                    actualizarRAM(datos.datos);
                    break;
                    
                case 'temperatura':
                    actualizarTemperatura(datos.datos);
                    break;
                    
                case 'bateria':
                    actualizarBateria(datos.datos);
                    break;

                case 'velocidad_red':
                    actualizarVelocidadRed(datos.datos);
                    break;

                case 'gps':
                    actualizarGPS(datos.datos);
                    break;

                case 'config_actual':
                    aplicarConfig(datos.datos || {});
                    if (datos.datos && datos.datos.reles) aplicarNombresReles(datos.datos.reles);
                    break;

                case 'config_actualizada':
                    console.log('Configuraci√≥n actualizada');
                    break;

                case 'camara':
                    manejarRespuestaCamara(datos);
                    break;

                case 'respuesta_gps':
                    mostrarToast(datos.mensaje || (datos.exito ? 'Ubicaci√≥n guardada' : 'No se pudo guardar'), datos.exito ? 'ok' : 'err');
                    break;
            }
        }

        function actualizarRAM(datos) {
            const elem = document.getElementById('indicador-ram');
            elem.textContent = `üíæ ${datos.used}/${datos.total}MB (${datos.percent}%)`;
            elem.className = 'indicador-ram';
            if (datos.percent < 70) elem.classList.add('ram-ok');
            else if (datos.percent < 85) elem.classList.add('ram-warning');
            else elem.classList.add('ram-critical');
        }

        function actualizarTemperatura(datos) {
            const elem = document.getElementById('indicador-temp');
            elem.textContent = `üå°Ô∏è ${datos.temperatura}¬∞C`;
            elem.className = 'indicador-temp';
            if (datos.temperatura < 60) elem.classList.add('temp-ok');
            else if (datos.temperatura < 75) elem.classList.add('temp-warning');
            else elem.classList.add('temp-critical');
        }

        function actualizarBateria(datos) {
            const elem = document.getElementById('indicador-bat');
            const icono = datos.estado === "cargando" ? 'üîå' : 'üîã';
            elem.textContent = `${icono} ${datos.porcentaje}%`;
            elem.className = 'indicador-bat';
            if (datos.porcentaje > 50) elem.classList.add('bat-ok');
            else if (datos.porcentaje > 20) elem.classList.add('bat-warning');
            else elem.classList.add('bat-critical');
        }

        function actualizarVelocidadRed(datos) {
            const elem = document.getElementById('indicador-red');
            const velocidad = datos && typeof datos.velocidad === 'number' ? datos.velocidad : null;
            if (velocidad === null) {
                elem.textContent = 'üåê Red: sin datos';
                elem.className = 'indicador-red';
                return;
            }
            if (velocidad <= 0) {
                elem.textContent = 'üåê Red: sin datos';
                elem.className = 'indicador-red ram-critical';
                return;
            }
            const unidad = velocidad >= 1000 ? 'Mbps' : 'Kbps';
            const valor = velocidad >= 1000 ? (velocidad / 1000).toFixed(1) : velocidad.toFixed(0);
            elem.textContent = `üåê ${valor} ${unidad}`;
            elem.className = 'indicador-red';
            // Colorear seg√∫n velocidad: > 10 Mbps = verde, > 5 Mbps = amarillo, < 5 Mbps = rojo
            if (velocidad >= 10000) elem.classList.add('ram-ok');
            else if (velocidad >= 5000) elem.classList.add('ram-warning');
            else elem.classList.add('ram-critical');
        }

        function aplicarNombresReles(nombresDict) {
            // Aplicar nombres configurados a los botones de rel√©s
            const botones = document.querySelectorAll('.btn-rele');
            for (let i = 1; i <= 9; i++) {
                const btn = botones[i - 1];
                if (btn) {
                    const nombre = nombresDict[i] || `R${i}`;
                    btn.textContent = nombre;
                    btn.title = `Rel√© ${i}: ${nombre}`;
                }
            }
        }

        function aplicarEstadosReles(estadosDict) {
            // Aplicar estados guardados a los botones de rel√©s
            const botones = document.querySelectorAll('.btn-rele');
            for (let i = 1; i <= 9; i++) {
                const btn = botones[i - 1];
                if (btn && estadosDict[i] !== undefined) {
                    estadoReles[i] = estadosDict[i];
                    if (estadosDict[i]) {
                        btn.classList.add('activo');
                    } else {
                        btn.classList.remove('activo');
                    }
                }
            }
        }

        function toggleRele(numero) {
            const boton = event.target;
            const nuevoEstado = !estadoReles[numero];
            estadoReles[numero] = nuevoEstado;

            if (nuevoEstado) boton.classList.add('activo');
            else boton.classList.remove('activo');

            enviarMensaje({ tipo: 'rele', numero: numero, estado: nuevoEstado });
        }

        function moverDrone(direccion) {
            enviarMensaje({ tipo: 'motor', direccion: direccion });
        }

        function pararDrone() {
            enviarMensaje({ tipo: 'motor', direccion: 'parar' });
        }

        function setVelocidad(nivel) {
            velocidadActual = nivel * 33;
            enviarMensaje({ tipo: 'velocidad', nivel: velocidadActual });
            
            document.querySelectorAll('.btn-velocidad').forEach(btn => btn.classList.remove('activo'));
            event.target.classList.add('activo');
        }

        function guardarUbicacion() {
            enviarMensaje({ tipo: 'gps_guardar' });
        }

        function irADestino() {
            mostrarToast('Funci√≥n en desarrollo: Navegar a destino', 'warn');
        }

        function mostrarRuta() {
            mostrarToast('Funci√≥n en desarrollo: Mostrar recorrido', 'warn');
        }

        function iniciarCamara(indice) {
            const calidad = document.getElementById(`calidadCam${indice}`).value;
            enviarMensaje({ tipo: 'camara', accion: 'iniciar', indice, calidad });
        }

        function detenerCamara(indice) {
            enviarMensaje({ tipo: 'camara', accion: 'detener', indice });
        }

        function manejarRespuestaCamara(datos) {
            const i = datos.indice;
            const exito = !!datos.exito;
            const mensaje = datos.mensaje || '';
            if (datos.accion === 'iniciar') {
                const videoEl = i === 1 ? document.getElementById('videoCam1') : document.getElementById('videoCam2');
                const playlist = i === 1 ? '/hls/cam1/cam1.m3u8' : '/hls/cam2/cam2.m3u8';
                if (exito) {
                    inicializarHLS(videoEl, playlist);
                } else {
                    const msg = mensaje || ('No se pudo iniciar la c√°mara ' + i);
                    mostrarToast(msg, 'err');
                }
            } else if (datos.accion === 'detener') {
                const videoEl = i === 1 ? document.getElementById('videoCam1') : document.getElementById('videoCam2');
                try {
                    videoEl.pause();
                    videoEl.removeAttribute('src');
                } catch (e) {}
            }
        }

        function irConfiguracion() {
            window.location.href = '/configuracion.html';
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function apagarRaspberry() {
            cerrarPowerMenu();
            if (confirm('¬øApagar Raspberry Pi?')) {
                enviarMensaje({ tipo: 'sistema', comando: 'apagar' });
            }
        }

        function reiniciarRaspberry() {
            cerrarPowerMenu();
            if (confirm('¬øReiniciar Raspberry Pi?')) {
                enviarMensaje({ tipo: 'sistema', comando: 'reiniciar' });
            }
        }


        function actualizarGPS(datos) {
            const sinSenal = !datos || datos.valido === false || datos.lat === undefined || datos.lon === undefined;
            if (sinSenal) {
                document.getElementById('latitud').textContent = 'Sin se√±al';
                document.getElementById('longitud').textContent = 'Sin se√±al';
                const velEl = document.getElementById('indicador-vel');
                if (velEl) velEl.textContent = 'Vel: -- km/h';
                return;
            }

            if (!mapa) return;
            
            const lat = parseFloat(datos.lat);
            const lon = parseFloat(datos.lon);
            const velGPS = (typeof datos.velocidad === 'number' && isFinite(datos.velocidad)) ? datos.velocidad : 0;
            const latEl = document.getElementById('latitud');
            const lonEl = document.getElementById('longitud');
            if (latEl && lonEl) {
                latEl.textContent = isFinite(lat) ? lat.toFixed(6) : '---';
                lonEl.textContent = isFinite(lon) ? lon.toFixed(6) : '---';
            }

            const velEl = document.getElementById('indicador-vel');
            if (velEl) {
                velEl.textContent = `üöÄ ${velGPS.toFixed(1)} km/h`;
            }

            if (!isFinite(lat) || !isFinite(lon)) return;
            
            // Crear o actualizar marcador
            if (!marcadorGPS) {
                marcadorGPS = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'marcador-gps',
                        html: '<div style="background: #ff4444; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 0 10px rgba(255,68,68,0.8);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(mapa);
                
                marcadorGPS.bindPopup('<b>Posici√≥n Drone</b><br>Cargando datos GPS...');
                
                // Centrar mapa en primera lectura GPS v√°lida
                mapa.setView([lat, lon], 17);
                console.log('GPS inicializado en:', lat, lon);
            } else {
                // Actualizar posici√≥n del marcador
                marcadorGPS.setLatLng([lat, lon]);
                
                // Seguir el drone autom√°ticamente
                mapa.panTo([lat, lon]);
            }
            
            // Actualizar popup con datos actuales
            const popupContent = `
                <b>üö§ Posici√≥n Drone</b><br>
                <b>Lat:</b> ${lat.toFixed(6)}<br>
                <b>Lon:</b> ${lon.toFixed(6)}<br>
                <b>Alt:</b> ${datos.alt || 0}m<br>
                <b>Sat√©lites:</b> ${datos.satelites || 0}<br>
                <b>Velocidad:</b> ${(datos.velocidad || 0).toFixed(1)} km/h
            `;
            marcadorGPS.getPopup().setContent(popupContent);
            
            console.log(`GPS actualizado: ${lat.toFixed(6)}, ${lon.toFixed(6)} - ${datos.satelites} sats`);
        }

        function inicializarMapa() {
            mapa = L.map('mapa').setView([4.6097, -74.0817], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(mapa);
        }

        function aplicarConfig(cfg) {
            try {
                // C√°mara 1
                const des1 = !!cfg.desactivar_camara1;
                const url1_sd = (cfg.url_camara1_sd || '').trim();
                const url1_hd = (cfg.url_camara1_hd || '').trim();
                const link1 = document.getElementById('linkCamara1');
                const cam1 = document.getElementById('camara1');
                const v1 = document.getElementById('videoCam1');
                const sel1 = document.getElementById('calidadCam1');
                
                if (des1 || (!url1_sd && !url1_hd)) {
                    link1.textContent = 'C√°mara 1 desactivada';
                    link1.removeAttribute('href');
                    cam1.style.opacity = 0.6;
                    v1.removeAttribute('src');
                } else {
                    const urlMostrar = url1_sd || url1_hd;
                    link1.textContent = urlMostrar;
                    link1.setAttribute('href', urlMostrar);
                    cam1.style.opacity = 1.0;
                    inicializarHLS(v1, '/hls/cam1/cam1.m3u8');
                    
                    // Habilitar/deshabilitar opciones seg√∫n disponibilidad
                    if (!url1_hd) sel1.querySelector('[value="hd"]').disabled = true;
                    if (!url1_sd) sel1.querySelector('[value="sd"]').disabled = true;
                    // Seleccionar HD/2K por defecto si est√° disponible
                    sel1.value = url1_hd ? 'hd' : 'sd';
                }

                // C√°mara 2
                const des2 = !!cfg.desactivar_camara2;
                const url2_sd = (cfg.url_camara2_sd || '').trim();
                const url2_hd = (cfg.url_camara2_hd || '').trim();
                const link2 = document.getElementById('linkCamara2');
                const cam2 = document.getElementById('camara2');
                const v2 = document.getElementById('videoCam2');
                const sel2 = document.getElementById('calidadCam2');
                
                if (des2 || (!url2_sd && !url2_hd)) {
                    link2.textContent = 'C√°mara 2 desactivada';
                    link2.removeAttribute('href');
                    cam2.style.opacity = 0.6;
                    v2.removeAttribute('src');
                } else {
                    const urlMostrar = url2_sd || url2_hd;
                    link2.textContent = urlMostrar;
                    link2.setAttribute('href', urlMostrar);
                    cam2.style.opacity = 1.0;
                    inicializarHLS(v2, '/hls/cam2/cam2.m3u8');
                    
                    // Habilitar/deshabilitar opciones seg√∫n disponibilidad
                    if (!url2_hd) sel2.querySelector('[value="hd"]').disabled = true;
                    if (!url2_sd) sel2.querySelector('[value="sd"]').disabled = true;
                    // Seleccionar HD/2K por defecto si est√° disponible
                    sel2.value = url2_hd ? 'hd' : 'sd';
                }
            } catch (e) {
                console.error('Error aplicando configuraci√≥n:', e);
            }
        }

        window.onload = function() {
            inicializarMapa();
            conectarWebSocket();
            document.addEventListener('click', function() {
                if (menuPowerAbierto) cerrarPowerMenu();
            });
        };

        function inicializarHLS(videoEl, playlistUrl) {
            try {
                if (Hls.isSupported()) {
                    const hls = new Hls({ lowLatencyMode: true });
                    hls.loadSource(playlistUrl);
                    hls.attachMedia(videoEl);
                } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
                    videoEl.src = playlistUrl;
                }
            } catch (e) {
                console.error('Error inicializando HLS:', e);
            }
        }
    </script>
    <script src="tema.js"></script>
    <script src="config-ui.js"></script>
    <div id="toast" class="toast"></div>
</body>
</html>
