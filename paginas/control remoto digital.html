<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Control Remoto Digital</title>
	<link rel="stylesheet" href="/static/tema_universal.css">
	<style>
		   .fila-superior {
			display: grid;
			grid-template-columns: repeat(3, minmax(0, 1fr));
			gap: 4px;
			width: 100%;
			height: 100%;
			min-height: 260px;
			align-items: stretch;
			justify-items: stretch;
			margin: 0;
			overflow: visible;
		}
		.panel-cam {
			margin: 0;
			flex: 1 1 0;
			height: 100%;
			min-height: 260px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 4px;
			box-sizing: border-box;
			position: relative;
			overflow: visible;
			background: #1a1f28;
			border-radius: 8px;
		}
		.panel-cam video {
			flex: 1 1 0;
			width: 100%;
			min-height: 0;
			object-fit: contain;
			border-radius: 8px;
			display: block;
			margin: 0 auto;
		}
		.cam-controles {
			display: flex;
			gap: 8px;
			margin-top: 4px;
			justify-content: center;
			align-items: center;
		}
		.panel-cam.mapa {
			padding: 4px;
		}
		.cam-controles .btn-cam-icon {
			width: 48px;
			height: 48px;
			min-width: 48px;
			min-height: 48px;
			padding: 0;
			display: none !important;
			align-items: center;
			justify-content: center;
		}
		.btn-cam-icon svg {
			width: 90%;
			height: 90%;
		}
		
		/* Estilos para el men√∫ flotante de c√°mara */
		.menu-cam-flotante {
			position: absolute;
			top: 10px;
			right: 10px;
			z-index: 1002;
			display: flex;
			flex-direction: row;
			gap: 8px;
		}
		
		.btn-menu-cam {
			width: 44px;
			height: 44px;
			padding: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 50%;
			background: #1a1f28;
			border: 2px solid #2196f3;
			color: #2196f3;
			cursor: pointer;
			transition: all 0.2s ease;
			box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
		}
		
		.btn-menu-cam:hover {
			background: #2196f3;
			color: #fff;
			box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
		}

		.btn-cam-flotante {
			width: 44px;
			height: 44px;
			padding: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 50%;
			background: #1a1f28;
			border: 2px solid #2196f3;
			color: #2196f3;
			cursor: pointer;
			transition: all 0.2s ease;
			box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
		}

		.btn-cam-flotante:hover {
			background: #2196f3;
			color: #fff;
			box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
		}

		/* Animaci√≥n de parpadeo para grabaci√≥n */
		@keyframes parpadeoGrabar {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.4; }
		}

		.btn-cam-flotante.grabando {
			animation: parpadeoGrabar 0.8s infinite;
	}

	/* Estilos para el men√∫ flotante de opciones */
	#menu-opciones {
		position: fixed;
		top: 70px;
		right: 18px;
		background: #1a1f28;
		border: 2px solid #2d3748;
		border-radius: 12px;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
		padding: 8px 0;
		min-width: 240px;
		z-index: 998;
	}

	#menu-opciones .btn-menu {
		display: block;
		width: 100%;
		padding: 12px 20px;
		margin: 0;
		border: none;
		border-radius: 0;
		background: transparent;
		color: #e5e7eb;
		text-align: left;
		cursor: pointer;
		transition: all 0.2s ease;
		box-shadow: none;
		font-size: 1em;
			font-weight: 500;
	}
	
	#menu-opciones .btn-menu:hover {
	background: rgba(33, 150, 243, 0.2);
	color: #2196f3;
	}
	
	.panel-cam.mapa #mapa-gps {
	flex: 1 1 0;
	width: 100%;
	height: 100%;
	min-height: 240px;
	border-radius: 8px;
	background: #1a1f28;
	position: relative;
	z-index: 1;
	}
			   .indicador-item {
				   font-size: 12px !important;
				   font-family: 'Segoe UI', 'Roboto', Arial, sans-serif !important;
			   }
		.reles-botones {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 2px !important;
			margin: 0 !important;
			width: 100%;
			max-width: 420px;
		}
		@media (max-width: 700px) {
			.reles-botones {
				grid-template-columns: 1fr 1fr;
				gap: 2px;
				max-width: 320px;
			}
		}
		@media (max-width: 480px) {
			.reles-botones {
				grid-template-columns: 1fr;
				max-width: 180px;
			}
		}
		/* .cruz-botones ahora se ajusta desde tema_universal.css para unificar formato */
		#btn-arriba { grid-row: 1; grid-column: 2; }
		#btn-izquierda { grid-row: 2; grid-column: 1; }
		#btn-centro { grid-row: 2; grid-column: 2; }
		#btn-derecha { grid-row: 2; grid-column: 3; }
		#btn-abajo { grid-row: 3; grid-column: 2; }
		
		/* Animaci√≥n de parpadeo para grabaci√≥n */
		@keyframes parpadeoRojo {
			0% { opacity: 1; }
			50% { opacity: 0.3; }
			100% { opacity: 1; }
		}
		
		@keyframes onda-latido {
			0% {
				stroke-dashoffset: 0;
				opacity: 1;
			}
			100% {
				stroke-dashoffset: 20;
				opacity: 0.5;
			}
		}
		
		.grabando-indicador {
			position: fixed;
			top: 20px;
			right: 60px;
			display: flex;
			align-items: center;
			gap: 12px;
			background: rgba(211, 47, 47, 0.95);
			color: white;
			padding: 12px 20px;
			border-radius: 8px;
			font-weight: 600;
			font-size: 14px;
			box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
			z-index: 1000;
			display: none;
		}
		
		.grabando-indicador.activo {
			display: flex;
		}
		
		.grabando-punto {
			width: 16px;
			height: 16px;
			border-radius: 50%;
			background: #ff5252;
			animation: parpadeoRojo 0.8s infinite;
			box-shadow: 0 0 8px #ff5252;
		}
		
		#iconGrabarCam1 svg circle,
		#iconGrabarCam2 svg circle {
			transition: all 0.2s ease;
		}
		
		#grabar-cam1.grabando svg circle,
		#grabar-cam2.grabando svg circle {
			animation: parpadeoRojo 0.8s infinite;
			filter: drop-shadow(0 0 4px #ff5252);
		}
		
		/* Modo oscuro profesional */
		body {
			margin: 0;
			padding: 0;
			height: 100vh;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			background: #0f1218 !important;
			color: #e5e7eb !important;
		}
		.cuadro-superior-wrapper {
			flex: 1;
			min-height: 50vh;
			max-height: 50vh;
			display: flex;
			align-items: stretch;
			justify-content: center;
			overflow: visible;
			padding: 4px;
			box-sizing: border-box;
			background: #0f1218;
		}
		.cuadro-superior-wrapper > div {
			display: flex;
			align-items: stretch;
			height: 100%;
			width: 100%;
			justify-content: stretch;
		}
		.cuadro-externo-superior {
			height: 100% !important;
			margin: 0 auto !important;
			width: 100%;
			max-width: 1200px;
			display: flex;
			justify-content: stretch;
			align-items: stretch;
			overflow: visible;
			background: #1a1f28 !important;
			border: 2px solid #2d3748 !important;
		}
		.cuadro-inferior {
			flex: 1;
			min-height: 50vh;
			max-height: 50vh;
			display: flex;
			align-items: stretch;
			justify-content: center;
			overflow: auto;
			padding: 4px;
			box-sizing: border-box;
			background: #0f1218;
		}
		.cuadro-inferior > div {
			display: flex;
			align-items: stretch;
			height: 100%;
		}
		.cuadro-externo-inferior {
			height: 100% !important;
			margin: 0 !important;
			background: #0f1218 !important;
		}
	</style>
	<script src="/static/leaflet_loader.js"></script>
</head>
<body>
		<!-- Indicador de grabaci√≥n en vivo -->
		<div id="grabando-indicador" class="grabando-indicador">
			<div class="grabando-punto"></div>
			<span id="grabando-camara">Grabando C√°mara 1</span>
		</div>

		<!-- Tuerca flotante en esquina superior derecha -->
		<div id="menu-flotante">
		<button id="btn-pantalla-completa" class="btn-menu" type="button" aria-label="Pantalla completa" style="position: fixed; bottom: 18px; right: 80px; z-index: 999; width: 44px; height: 44px; padding: 0; display: flex; align-items: center; justify-content: center;">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2196f3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
		</button>
		<button id="btn-tuerca" class="btn-menu" type="button" aria-label="Men√∫ de opciones" style="width: 44px; height: 44px; padding: 0; display: flex; align-items: center; justify-content: center;">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2196f3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
			</button>
			<div id="menu-opciones" style="display:none;">
				<button class="btn-menu" onclick="document.documentElement.requestFullscreen()">üñµ Pantalla completa</button>
				<button class="btn-menu" onclick="window.location.href='mapa_gps.html'">üß≠ Mapa GPS</button>
				<button class="btn-menu" onclick="window.location.href='configuracion.html'">‚öôÔ∏è Configuraci√≥n</button>
				<button class="btn-menu" onclick="abrirRouter()">üì° Router 4G/5G</button>
				<button class="btn-menu" onclick="if(confirm('¬øReiniciar el sistema?')) fetch('/api/reiniciar', {method:'POST'}).then(()=>window.location.reload())">üîÑ Reiniciar</button>
				<button class="btn-menu" onclick="if(confirm('¬øApagar el sistema?')) fetch('/api/apagar', {method:'POST'})">‚èª Apagar</button>
			</div>
		</div>
		<script>
			const btnTuerca = document.getElementById('btn-tuerca');
			const btnPantallaCompleta = document.getElementById('btn-pantalla-completa');
			const menuOpciones = document.getElementById('menu-opciones');
			btnTuerca.onclick = function(e) {
				e.stopPropagation();
				menuOpciones.style.display = menuOpciones.style.display === 'none' ? 'block' : 'none';
			};
			document.addEventListener('click', function(e) {
				if (menuOpciones.style.display === 'block') menuOpciones.style.display = 'none';
			});

			// Bot√≥n pantalla completa
			btnPantallaCompleta.onclick = function(e) {
				e.stopPropagation();
				document.documentElement.requestFullscreen().catch(err => console.log('Error fullscreen:', err));
			};

			// Verificar si debe iniciar con pantalla completa
			async function verificarPantallaCompleta() {
				try {
					const res = await fetch('/api/config');
					if (res.ok) {
						const cfg = await res.json();
						if (cfg.pantalla_completa) {
							// Esperar un momento para asegurar que el DOM est√© listo
							setTimeout(() => {
								document.documentElement.requestFullscreen().catch(err => console.log('Fullscreen autom√°tico fall√≥:', err));
							}, 500);
						}
					}
				} catch (e) {
					console.log('Error verificando pantalla completa:', e);
				}
			}

			// Llamar funci√≥n al cargar p√°gina
			window.addEventListener('load', verificarPantallaCompleta);

			// Funci√≥n para abrir el router
			async function abrirRouter() {
				try {
					const res = await fetch('/api/config');
					if (!res.ok) {
						alert('No se pudo obtener la configuraci√≥n del router');
						return;
					}
					const config = await res.json();
					const routerIp = config.router_ip;
					if (!routerIp || routerIp.trim() === '') {
						alert('‚ö†Ô∏è No hay direcci√≥n IP del router configurada.\n\nPor favor, configura la IP del router en Configuraci√≥n.');
						return;
					}
					// Agregar http:// si no tiene protocolo
					let url = routerIp.trim();
					if (!url.startsWith('http://') && !url.startsWith('https://')) {
						url = 'http://' + url;
					}
					window.open(url, '_blank');
				} catch (e) {
					alert('Error al intentar abrir el router: ' + e.message);
				}
			}
		</script>
		<script>
			// El mapa se inicializar√° autom√°ticamente cuando lleguen datos GPS del WebSocket
			// No inicializar con coordenadas (0,0) para evitar conflictos
			console.log('Esperando datos GPS para inicializar el mapa...');
		</script>
		<div class="cuadro-superior-wrapper">
			<div class="cuadro-externo-superior" style="background:#1a1f28; border:2px solid #2d3748; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.4); padding:6px; display:flex; justify-content:stretch; align-items:stretch; width:100%; max-width:1200px; margin:0 auto; box-sizing:border-box;">
				<div class="fila-superior">
					<div class="panel-cam">
						<video id="videoCam1" controls muted playsinline></video>
						<div class="menu-cam-flotante">
							<button class="btn-cam-flotante" id="btnPlayCam1Float" type="button" title="Play/Stop Cam 1" onclick="document.getElementById('playCam1').click()">
								<svg id="iconPlayCam1Float" width="22" height="22" viewBox="0 0 32 32" fill="#2196f3" style="display:block;">
									<polygon points="10,6 26,16 10,26"/>
								</svg>
							</button>
							<button class="btn-cam-flotante" id="btnPhotoCam1Float" type="button" title="Capturar Foto Cam 1" onclick="document.getElementById('captureCam1').click()">
								<svg width="22" height="22" viewBox="0 0 32 32" fill="none" stroke="#2196f3" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="display:block;">
									<rect x="6" y="10" width="20" height="12" rx="3" fill="none"></rect>
									<circle cx="16" cy="16" r="5" fill="#2196f3"></circle>
									<rect x="12" y="6" width="8" height="5" rx="2" fill="none"></rect>
								</svg>
							</button>
							<button class="btn-cam-flotante" id="btnRecordCam1Float" type="button" title="Grabar Video Cam 1" onclick="document.getElementById('grabar-cam1').click()">
								<svg width="22" height="22" viewBox="0 0 32 32" fill="#d32f2f" style="display:block;">
									<circle cx="16" cy="16" r="10" fill="#d32f2f"></circle>
								</svg>
							</button>
						</div>
						<div class="cam-controles">
							<button id="playCam1" class="btn btn-cam btn-cam-icon" title="Play/Stop Cam 1">
								<span id="iconPlayCam1" style="display:inline-block;width:100%;height:100%;vertical-align:middle;">
									<svg width="100%" height="100%" viewBox="0 0 22 22" fill="#2196f3" style="display:block;"><polygon points="6,4 18,11 6,18"/></svg>
								</span>
							</button>
							<button id="captureCam1" class="btn btn-cam btn-cam-icon" title="Capturar Foto">
								<svg width="100%" height="100%" viewBox="0 0 32 32" fill="#555" style="display:block;">
									<rect x="4" y="10" width="24" height="14" rx="3" fill="#bbb"/>
									<circle cx="16" cy="17" r="6" fill="#2196f3"/>
									<rect x="11" y="5" width="10" height="6" rx="2" fill="#bbb"/>
								</svg>
							</button>
							<button id="grabar-cam1" class="btn btn-cam btn-cam-icon" title="Grabar video">
							<span id="iconGrabarCam1" style="display:inline-block;width:100%;height:100%;vertical-align:middle;">
								<svg width="100%" height="100%" viewBox="0 0 32 32" style="display:block;"><circle cx="16" cy="16" r="12" fill="#d32f2f"/></svg>
							</span>
							</button>
						</div>
					</div>
					<div class="panel-cam">
						<video id="videoCam2" controls muted playsinline></video>
						<div class="menu-cam-flotante">
							<button class="btn-cam-flotante" id="btnPlayCam2Float" type="button" title="Play/Stop Cam 2" onclick="document.getElementById('playCam2').click()">
								<svg id="iconPlayCam2Float" width="22" height="22" viewBox="0 0 22 22" fill="#2196f3" style="display:block;">
									<polygon points="6,4 18,11 6,18"/>
								</svg>
							</button>
							<button class="btn-cam-flotante" id="btnPhotoCam2Float" type="button" title="Capturar Foto Cam 2" onclick="document.getElementById('captureCam2').click()">
								<svg width="22" height="22" viewBox="0 0 32 32" fill="#555" style="display:block;">
									<rect x="4" y="10" width="24" height="14" rx="3" fill="#bbb"/>
									<circle cx="16" cy="17" r="6" fill="#2196f3"/>
									<rect x="11" y="5" width="10" height="6" rx="2" fill="#bbb"/>
								</svg>
							</button>
							<button class="btn-cam-flotante" id="btnRecordCam2Float" type="button" title="Grabar Video Cam 2" onclick="document.getElementById('grabar-cam2').click()">
								<svg width="22" height="22" viewBox="0 0 32 32" fill="#d32f2f" style="display:block;">
									<circle cx="16" cy="16" r="10" fill="#d32f2f"></circle>
								</svg>
							</button>
						</div>
						<div class="cam-controles">
							<button id="playCam2" class="btn btn-cam btn-cam-icon" title="Play/Stop Cam 2">
								<span id="iconPlayCam2" style="display:inline-block;width:100%;height:100%;vertical-align:middle;">
									<svg width="100%" height="100%" viewBox="0 0 22 22" fill="#2196f3" style="display:block;"><polygon points="6,4 18,11 6,18"/></svg>
								</span>
							</button>
							<button id="captureCam2" class="btn btn-cam btn-cam-icon" title="Capturar Foto">
								<svg width="100%" height="100%" viewBox="0 0 32 32" fill="#555" style="display:block;">
									<rect x="4" y="10" width="24" height="14" rx="3" fill="#bbb"/>
									<circle cx="16" cy="17" r="6" fill="#2196f3"/>
									<rect x="11" y="5" width="10" height="6" rx="2" fill="#bbb"/>
								</svg>
							</button>
							<button id="grabar-cam2" class="btn btn-cam btn-cam-icon" title="Grabar video">
							<span id="iconGrabarCam2" style="display:inline-block;width:100%;height:100%;vertical-align:middle;">
								<svg width="100%" height="100%" viewBox="0 0 32 32" style="display:block;"><circle cx="16" cy="16" r="12" fill="#d32f2f"/></svg>
							</span>
							</button>
						</div>
					</div>
					<div class="panel-cam mapa">
						<div id="mapa-gps"></div>
						<div class="menu-cam-flotante">
							<button class="btn-menu-cam" id="btn-menu-mapa" type="button" aria-label="Opciones Mapa">
								<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2196f3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<circle cx="12" cy="12" r="1"></circle>
									<circle cx="19" cy="12" r="1"></circle>
									<circle cx="5" cy="12" r="1"></circle>
								</svg>
							</button>
							<div id="menu-mapa-opciones" class="menu-cam-opciones" style="display:none;">
								<button class="btn-menu" id="mapa-guardar-ubicacion">üìç Guardar ubicaci√≥n</button>
								<button class="btn-menu" onclick="document.getElementById('gps-destino').click()">üéØ Ir a destino</button>
								<button class="btn-menu" id="mapa-grabar-recorrido">üõ§Ô∏è Grabar recorrido</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<div class="cuadro-inferior">
		<div style="width:100%; display:flex; justify-content:center; align-items:stretch;">
			<div class="cuadro-externo-inferior" style="background:#1a1f28; border:2px solid #2d3748; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.4); padding:4px; display:flex; justify-content:center; align-items:center;">
					<div class="fila-inferior" style="display:flex; justify-content:center; gap:8px;">
						<div class="panel-bajo" style="margin:0; padding:0; width:78px; box-sizing:border-box;">
					<!-- T√≠tulo del mando -->
					<div style="font-size:0.85em; font-weight:600; color:#6ec1e4; margin-bottom:4px; text-align:center; width:100%;">Mando</div>
							<!-- Panel de depuraci√≥n eliminado -->
							<div style="display: grid; grid-template-rows: 1fr 1fr 1fr; grid-template-columns: 1fr 1fr 1fr; gap: 1px; width: 100%; margin: 0; padding: 0; box-sizing: border-box;">
								<button class="btn btn-direccion" id="btn-arriba" style="margin:0; padding:0; width:100%; height:32px; font-size:0.9em;">‚ñ≤</button>
								<button class="btn btn-direccion" id="btn-izquierda" style="margin:0; padding:0; width:100%; height:32px; font-size:0.9em;">‚óÄ</button>
								<button class="btn btn-direccion" id="btn-centro" style="margin:0; padding:0; width:100%; height:32px; font-size:0.9em; background:#d32f2f !important; border-color:#d32f2f !important; color:#fff !important;">‚óè</button>
								<button class="btn btn-direccion" id="btn-derecha" style="margin:0; padding:0; width:100%; height:32px; font-size:0.9em;">‚ñ∂</button>
								<button class="btn btn-direccion" id="btn-abajo" style="margin:0; padding:0; width:100%; height:32px; font-size:0.9em;">‚ñº</button>
							</div>
						</div>
					<div class="panel-bajo" style="margin:0; display:flex; flex-direction:column; justify-content:flex-start; align-items:center; min-width:70px; max-width:90px; width:75px; padding:0; box-sizing:border-box;">
						<div style="font-size:0.85em; font-weight:600; color:#6ec1e4; margin-bottom:4px; text-align:center; width:100%;">Vel.</div>
						<div class="velocidades-botones" style="display:flex; flex-direction:column; gap:2px; align-items:center; padding:0; width:100%; box-sizing:border-box;">
							<button class="btn btn-velocidad" id="vel-lenta" style="margin-left:0;margin-right:0;padding-left:4px;padding-right:4px;min-width:70px;max-width:90px;width:100%;box-sizing:border-box;">1</button>
							<button class="btn btn-velocidad" id="vel-media" style="margin-left:0;margin-right:0;padding-left:4px;padding-right:4px;min-width:70px;max-width:90px;width:100%;box-sizing:border-box;">2</button>
							<button class="btn btn-velocidad" id="vel-rapida" style="margin-left:0;margin-right:0;padding-left:4px;padding-right:4px;min-width:70px;max-width:90px;width:100%;box-sizing:border-box;">3</button>
							</div>
						</div>
						<div class="panel-bajo" style="margin:0; padding:0; width:100%; box-sizing:border-box;">
							<div style="font-size:0.85em; font-weight:600; color:#6ec1e4; margin-bottom:4px; text-align:center; width:100%;">Panel de control</div>
							<div class="reles-botones" id="reles-botones">
								<!-- Los botones de rel√© se generan din√°micamente -->
							</div>
						</div>
						<div class="panel-bajo" style="margin-left:0;margin-right:0; margin-top:0; padding-left:4px; padding-right:4px; width:100%; box-sizing:border-box;">
							<div style="font-size:0.85em; font-weight:600; color:#6ec1e4; margin-bottom:4px; text-align:center; width:100%;">Indicadores</div>
							<table class="tabla-indicadores" style="width:100%; max-width:440px; margin:0 auto; border-collapse:collapse; background:#23272b; border-radius:8px; box-shadow:0 1px 6px #0001; color:#f2f2f2; table-layout:fixed; font-family:'Space Grotesk','Segoe UI',sans-serif;">
								<colgroup>
									<col style="width:50%">
									<col style="width:50%">
								</colgroup>
								<tbody>
									<tr>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<span id="indicador-conexion" class="desconectado">
												<svg id="svg-osciloscopio" width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;">
													<!-- Marco del osciloscopio -->
													<rect x="1" y="1" width="14" height="14" rx="2" ry="2" fill="none" stroke="#4caf50" stroke-width="1"/>
													<!-- L√≠neas de la cuadr√≠cula -->
													<line x1="1" y1="8" x2="15" y2="8" stroke="#4caf50" stroke-width="0.5" opacity="0.3"/>
													<line x1="8" y1="1" x2="8" y2="15" stroke="#4caf50" stroke-width="0.5" opacity="0.3"/>
													<!-- Onda animada (latido card√≠aco) -->
													<polyline id="onda-conexion" points="2,8 3,8 4,7 5,6 6,8 7,8 8,6 9,4 10,8 11,8 12,7 13,6 14,8 15,8" stroke="#4caf50" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
												</svg>
												<span id="texto-conexion" style="color:#4caf50; font-weight:600;">Conectado</span>
											</span>
										</td>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><rect x="2" y="4" width="12" height="8" rx="2" fill="#6ec1e4"/></svg>
											RAM: <span id="ram-valor">--</span>
										</td>
									</tr>
									<tr>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><rect x="7" y="2" width="2" height="8" fill="#e6a23c"/><circle cx="8" cy="12" r="3" fill="#e6a23c"/></svg>
											Temp: <span id="temp-valor">--</span>
										</td>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><rect x="3" y="5" width="10" height="6" rx="2" fill="#43a047"/><rect x="13" y="7" width="2" height="2" fill="#43a047"/></svg>
											Bater√≠a: <span id="bat-valor">--</span>
										</td>
									</tr>
									<tr>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><circle cx="8" cy="8" r="7" fill="#6ec1e4"/></svg>
											Red: <span id="red-valor">--</span>
										</td>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><path d="M8 2 A6 6 0 1 1 7.99 2" stroke="#6ec1e4" stroke-width="2" fill="none"/><circle cx="8" cy="8" r="2" fill="#6ec1e4"/></svg>
											Vel: <span id="vel-valor">--</span>
										</td>
									</tr>
									<tr>
										<td style="border:1px solid #cfd8dc; padding:6px; text-align:center;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><circle cx="8" cy="8" r="4" fill="#ffd600"/></svg>
											Solar: <span id="solar-valor">--</span>
										</td>
										<td style="border:1px solid #cfd8dc; padding:6px; text-align:center;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><rect x="4" y="8" width="8" height="4" fill="#b71c1c"/></svg>
											Peso: <span id="peso-valor">--</span>
										</td>
									</tr>
									<tr>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><circle cx="8" cy="8" r="7" fill="#6ec1e4"/></svg>
											Lat: <span id="gps-lat">--</span>
										</td>
										<td style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><circle cx="8" cy="8" r="7" fill="#6ec1e4"/></svg>
											Lon: <span id="gps-lon">--</span>
										</td>
									</tr>
									<tr>
										<td colspan="2" style="border:1px solid #e0e0e0; padding:6px; text-align:center; background:#23272b; color:#f2f2f2;">
											<svg width="16" height="16" viewBox="0 0 16 16" style="vertical-align:middle;"><path d="M8 2 A6 6 0 1 1 7.99 2" stroke="#6ec1e4" stroke-width="2" fill="none"/><circle cx="8" cy="8" r="2" fill="#6ec1e4"/></svg>
											Vel: <span id="vel-valor">--</span>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
			</div>
		</div>
	    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
	    <script>
		    // C√°mara 1 y 2

			   // --- Play/Stop y Captura ---
			let hlsPlayers = { cam1: null, cam2: null };
			let playing = { cam1: false, cam2: false };
			let estadoReles = {};

		// Variables para calcular velocidad en tiempo real basada en GPS
		let ultimaPosicionGPS = { lat: null, lon: null, tiempo: null };

		// Funci√≥n para calcular distancia entre dos puntos GPS (Haversine formula)
		function calcularDistanciaGPS(lat1, lon1, lat2, lon2) {
			const R = 6371; // Radio de la Tierra en km
			const dLat = (lat2 - lat1) * Math.PI / 180;
			const dLon = (lon2 - lon1) * Math.PI / 180;
			const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
				  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
				  Math.sin(dLon/2) * Math.sin(dLon/2);
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
			return R * c; // Distancia en km
		}

		// Funci√≥n para calcular velocidad en km/h basada en cambios de GPS
		function calcularVelocidadGPS(latActual, lonActual) {
			const ahora = Date.now();
			if (ultimaPosicionGPS.lat === null || ultimaPosicionGPS.lon === null || ultimaPosicionGPS.tiempo === null) {
				ultimaPosicionGPS = { lat: latActual, lon: lonActual, tiempo: ahora };
				return 0; // Primera lectura
			}
			const distancia = calcularDistanciaGPS(ultimaPosicionGPS.lat, ultimaPosicionGPS.lon, latActual, lonActual);
			const tiempoTranscurrido = (ahora - ultimaPosicionGPS.tiempo) / 3600000; // Convertir ms a horas
			const velocidad = tiempoTranscurrido > 0 ? distancia / tiempoTranscurrido : 0;
			ultimaPosicionGPS = { lat: latActual, lon: lonActual, tiempo: ahora };
			return velocidad;
		}

		// --- Play/Stop y Captura ---
		function iniciarCamara(videoId, playlist, camKey) {
			var video = document.getElementById(videoId);
			if (window.Hls && Hls.isSupported()) {
				var hls = new Hls({
					lowLatencyMode: true,
					maxBufferLength: 1,
					maxMaxBufferLength: 2,
					maxBufferSize: 4 * 1000 * 1000,
					maxBufferHole: 0.1,
					liveSyncDuration: 0.1
				});
				hls.loadSource(playlist);
				hls.attachMedia(video);
				hlsPlayers[camKey] = hls;
			} else if (video.canPlayType('application/vnd.apple.mpegurl')) {
				video.src = playlist;
			}
			video.play();
			playing[camKey] = true;
		}

		function detenerCamara(videoId, camKey) {
			var video = document.getElementById(videoId);
			if (window.Hls && Hls.isSupported() && hlsPlayers[camKey]) {
				hlsPlayers[camKey].destroy();
				hlsPlayers[camKey] = null;
			}
			video.pause();
			video.removeAttribute('src');
			video.load();
			playing[camKey] = false;
		}

		function toggleCamara(videoId, playlist, camKey, btnId) {
			const iconSpan = document.getElementById('icon' + btnId.charAt(0).toUpperCase() + btnId.slice(1));
			const floatIconId = 'iconPlay' + camKey.charAt(0).toUpperCase() + camKey.slice(1) + 'Float';
			const floatIcon = document.getElementById(floatIconId);
			
			if (!playing[camKey]) {
				iniciarCamara(videoId, playlist, camKey);
				// Cambia a icono de Stop
				const stopSvg = '<svg width="100%" height="100%" viewBox="0 0 22 22" fill="#e53935" style="display:block;"><rect x="6" y="6" width="10" height="10" rx="2"/></svg>';
				iconSpan.innerHTML = stopSvg;
				if (floatIcon) floatIcon.outerHTML = '<svg id="' + floatIconId + '" width="22" height="22" viewBox="0 0 22 22" fill="#e53935" style="display:block;"><rect x="6" y="6" width="10" height="10" rx="2"/></svg>';
			} else {
				detenerCamara(videoId, camKey);
				// Cambia a icono de Play
				const playSvg = '<svg width="100%" height="100%" viewBox="0 0 22 22" fill="#2196f3" style="display:block;"><polygon points="6,4 18,11 6,18"/></svg>';
				iconSpan.innerHTML = playSvg;
				if (floatIcon) floatIcon.outerHTML = '<svg id="' + floatIconId + '" width="22" height="22" viewBox="0 0 22 22" fill="#2196f3" style="display:block;"><polygon points="6,4 18,11 6,18"/></svg>';
			}
		}

		document.getElementById('playCam1').onclick = function() {
			toggleCamara('videoCam1', '/hls/cam1/cam1.m3u8', 'cam1', 'playCam1');
		};
		document.getElementById('playCam2').onclick = function() {
			toggleCamara('videoCam2', '/hls/cam2/cam2.m3u8', 'cam2', 'playCam2');
		};


			// --- Captura de Foto ---
			async function capturarFoto(videoId, camara) {
				const video = document.getElementById(videoId);
				if (video.readyState < 2) {
					alert('La c√°mara no est√° lista para capturar.');
					return;
				}
				const canvas = document.createElement('canvas');
				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				const ctx = canvas.getContext('2d');
				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
				
				// Convertir canvas a blob
				canvas.toBlob(function(blob) {
					// Crear URL descargable de la imagen
					const url = URL.createObjectURL(blob);
					
					// Crear nombre del archivo con fecha y hora
					const ahora = new Date();
					const fecha = ahora.toISOString().replace(/[:.]/g, '-').split('T')[0];
					const hora = ahora.toTimeString().split(' ')[0].replace(/:/g, '');
					const nombreArchivo = `foto_cam${camara === 'cam1' ? '1' : '2'}_${fecha}_${hora}.jpg`;
					
					// Crear elemento <a> para descargar
					const a = document.createElement('a');
					a.href = url;
					a.download = nombreArchivo;
					
					// Agregar al DOM, hacer clic y remover
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					
					// Liberar la URL del objeto
					URL.revokeObjectURL(url);
					
					alert(`‚úì Foto descargada: ${nombreArchivo}`);
				}, 'image/jpeg', 0.92);
			}

			document.getElementById('captureCam1').onclick = function() {
				capturarFoto('videoCam1', 'cam1');
			};
			document.getElementById('captureCam2').onclick = function() {
				capturarFoto('videoCam2', 'cam2');
			};

			// --- Grabaci√≥n de Video ---
			let mediaRecorders = { cam1: null, cam2: null };
			let recordedChunks = { cam1: [], cam2: [] };
			let grabando = { cam1: false, cam2: false };

			async function grabarVideo(videoId, camara) {
				const video = document.getElementById(videoId);
				const btnGrabar = document.getElementById(`grabar-cam${camara === 'cam1' ? '1' : '2'}`);
				const btnGrabarFloat = document.getElementById(`btnRecordCam${camara === 'cam1' ? '1' : '2'}Float`);
				const iconSpan = document.getElementById(`iconGrabarCam${camara === 'cam1' ? '1' : '2'}`);
				const indicador = document.getElementById('grabando-indicador');
				const textoCamara = document.getElementById('grabando-camara');
				
				let stream = video.captureStream ? video.captureStream() : null;
				if (!stream) {
					alert('No se puede obtener el stream de video.');
					return;
				}
				if (grabando[camara]) {
					// Detener grabaci√≥n
					mediaRecorders[camara].stop();
					btnGrabar.classList.remove('grabando');
					if (btnGrabarFloat) btnGrabarFloat.classList.remove('grabando');
					indicador.classList.remove('activo');
					return;
				}
				recordedChunks[camara] = [];
				let options = { mimeType: 'video/webm;codecs=vp9' };
				let mediaRecorder = new MediaRecorder(stream, options);
				mediaRecorders[camara] = mediaRecorder;
				grabando[camara] = true;
				
				// Mostrar indicador de grabaci√≥n
				btnGrabar.classList.add('grabando');
				if (btnGrabarFloat) btnGrabarFloat.classList.add('grabando');
				textoCamara.textContent = `Grabando C√°mara ${camara === 'cam1' ? '1' : '2'}`;
				indicador.classList.add('activo');
				
				mediaRecorder.ondataavailable = function(e) {
					if (e.data.size > 0) recordedChunks[camara].push(e.data);
				};
				mediaRecorder.onstop = function() {
					grabando[camara] = false;
					const blob = new Blob(recordedChunks[camara], { type: 'video/webm' });
					
					// Crear URL descargable del video
					const url = URL.createObjectURL(blob);
					
					// Crear nombre del archivo con fecha y hora
					const ahora = new Date();
					const fecha = ahora.toISOString().replace(/[:.]/g, '-').split('T')[0];
					const hora = ahora.toTimeString().split(' ')[0].replace(/:/g, '');
					const nombreArchivo = `video_cam${camara === 'cam1' ? '1' : '2'}_${fecha}_${hora}.webm`;
					
					// Crear elemento <a> para descargar
					const a = document.createElement('a');
					a.href = url;
					a.download = nombreArchivo;
					
					// Agregar al DOM, hacer clic y remover
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					
					// Liberar la URL del objeto
					URL.revokeObjectURL(url);
					
					alert(`‚úì Video descargado: ${nombreArchivo}`);
				};
				mediaRecorder.start();
			}

			document.getElementById('grabar-cam1').onclick = function() {
				grabarVideo('videoCam1', 'cam1');
			};
			document.getElementById('grabar-cam2').onclick = function() {
				grabarVideo('videoCam2', 'cam2');
			};

			// WebSocket para indicadores y rel√©s
			let ws;
			let conectado = false;
			function beep(frec, dur, vol=0.2) {
				try {
					const ctx = new (window.AudioContext || window.webkitAudioContext)();
					const o = ctx.createOscillator();
					const g = ctx.createGain();
					o.type = 'sine';
					o.frequency.value = frec;
					g.gain.value = vol;
					o.connect(g); g.connect(ctx.destination);
					o.start();
					setTimeout(()=>{o.stop();ctx.close();}, dur);
				} catch(e) {}
			}
			function setConexion(estado) {
				const icon = document.querySelector('#indicador-conexion svg circle');
				const texto = document.getElementById('texto-conexion');
				   if (estado) {
					   icon.setAttribute('fill', '#43a047');
					   texto.textContent = 'Conectado';
					   texto.style.color = '#43a047';
					   beep(880, 120, 0.18); // Sonido de conexi√≥n
				   } else {
					   icon.setAttribute('fill', '#e53935');
					   texto.textContent = 'Desconectado';
					   texto.style.color = '#e53935';
					   beep(220, 220, 0.18); // Sonido de desconexi√≥n
				   }
			}
	function actualizarIndicadores(data) {
				// RAM
				if (data.ram && typeof data.ram.percent !== 'undefined') {
					document.getElementById('ram-valor').textContent = data.ram.percent + ' % (' + data.ram.used + 'MB/' + data.ram.total + 'MB)';
				} else {
					document.getElementById('ram-valor').textContent = '--';
				}
				// Temperatura
				if (data.temperatura && typeof data.temperatura.temperatura !== 'undefined') {
					document.getElementById('temp-valor').textContent = data.temperatura.temperatura + ' ¬∞C';
				} else {
					document.getElementById('temp-valor').textContent = '--';
				}
				// Bater√≠a
				if (data.bateria && typeof data.bateria.porcentaje !== 'undefined') {
					document.getElementById('bat-valor').textContent = data.bateria.porcentaje + ' %';
				} else {
					document.getElementById('bat-valor').textContent = '--';
				}
				// Red
				if (data.red !== undefined && data.red !== null) {
					document.getElementById('red-valor').textContent = Number(data.red).toFixed(1) + ' Mbps';
				} else {
					document.getElementById('red-valor').textContent = '--';
				}
				// GPS Lat/Lon y mapa
				let velocidadGPS = null;
				if (data.gps && data.gps.latitud && data.gps.longitud) {
					let lat = Number(data.gps.latitud);
					let lon = Number(data.gps.longitud);
					let gpsActivo = data.gps.valido === true;
					document.getElementById('gps-lat').textContent = isNaN(lat) ? '--' : lat.toFixed(1);
					document.getElementById('gps-lon').textContent = isNaN(lon) ? '--' : lon.toFixed(1);
					if (!isNaN(lat) && !isNaN(lon)) {
						mostrarMapaGPS(lat, lon, gpsActivo);
						// Calcular velocidad en tiempo real basada en GPS
						velocidadGPS = calcularVelocidadGPS(lat, lon);
					}
				} else {
					document.getElementById('gps-lat').textContent = '--';
					document.getElementById('gps-lon').textContent = '--';
				}

				// Velocidad (usar calculada de GPS o la del servidor como fallback)
				if (velocidadGPS !== null) {
					document.getElementById('vel-valor').textContent = velocidadGPS.toFixed(2) + ' km/h';
				} else if (data.velocidad !== undefined && data.velocidad !== null) {
					document.getElementById('vel-valor').textContent = Number(data.velocidad).toFixed(2) + ' km/h';
				} else {
					document.getElementById('vel-valor').textContent = '--';
				}
			}
			// Rel√©s
			function renderReles(reles) {
				console.log('=== renderReles llamado con:', reles);
				estadoReles = reles || {};
				const contenedor = document.getElementById('reles-botones');
				console.log('Contenedor reles-botones:', contenedor);
				if (!contenedor) {
					console.error('NO ENCONTRADO: elemento reles-botones');
					return;
				}
				contenedor.innerHTML = '';
				// Los nombres de los rel√©s se reciben por WebSocket en data.nombres_reles
				let nombresReles = window.nombres_reles || {};
				console.log('Nombres de rel√©s:', nombresReles);
				for (let i = 1; i <= 9; i++) {
					let nombre = nombresReles[i] || `Rel√© ${i}`;
					let estaActivo = estadoReles[i] === true;
					const btn = document.createElement('button');
					btn.className = `btn btn-rele btn-modern ${estaActivo ? 'activo' : 'inactivo'}`;
					btn.id = `rele${i}`;
					btn.setAttribute('data-numero', String(i));
					btn.innerHTML = `<span style='font-weight:600;'>${nombre}</span>`;
					console.log(`Creando bot√≥n rel√© ${i}:`, btn.id, 'activo:', estaActivo);
					btn.addEventListener('click', function(e) {
						const numero = parseInt(this.getAttribute('data-numero'));
						console.log('üî¥ CLICK DETECTADO EN REL√â:', numero);
						console.log('window.ws existe:', typeof window.ws !== 'undefined');
						console.log('window.ws:', window.ws);
						if (typeof window.ws === 'undefined' || window.ws === null) {
							console.error('‚ùå window.ws NO EXISTE');
							alert('Error: WebSocket no inicializado');
							return;
						}
						console.log('window.ws.readyState:', window.ws.readyState, '(1=OPEN)');
						if (window.ws.readyState !== 1) {
							console.error('‚ùå WebSocket NO conectado. readyState:', window.ws.readyState);
							alert('Error: WebSocket no conectado. readyState=' + window.ws.readyState);
							return;
						}
						const nuevoEstado = !(estadoReles[numero] === true);
						console.log('üì§ Enviando comando rel√©', numero, '-> estado:', nuevoEstado);
						// Actualizaci√≥n optimista de UI
						estadoReles[numero] = nuevoEstado;
						this.classList.toggle('activo', nuevoEstado);
						this.classList.toggle('inactivo', !nuevoEstado);
						const mensaje = JSON.stringify({
							tipo: 'rele',
							numero: numero,
							estado: nuevoEstado
						});
						console.log('Mensaje a enviar:', mensaje);
						window.ws.send(mensaje);
						console.log('‚úÖ Comando enviado');
					});
					contenedor.appendChild(btn);
				}
				console.log('=== renderReles finalizado. Botones creados: 9');
			}
	// Funci√≥n para aplicar velocidad en UI
			function aplicarVelocidadUI(velocidad) {
				console.log('Aplicando velocidad UI:', velocidad);
				velocidadActual = velocidad;
				const mapeoVelocidad = [
					{ id: 'vel-lenta', valor: 30 },
					{ id: 'vel-media', valor: 60 },
					{ id: 'vel-rapida', valor: 90 }
				];
				mapeoVelocidad.forEach(v => {
					const btn = document.getElementById(v.id);
					if (!btn) return;
					const activo = v.valor === velocidad;
					btn.classList.toggle('activo', activo);
					btn.classList.toggle('inactivo', !activo);
					console.log('Bot√≥n', v.id, 'activo:', activo);
				});
			}
	// toggleRele eliminado, todo se hace por WebSocket
			function conectarWS() {
				console.log('üì° Intentando conectar WebSocket...');
				let wsProto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
				let wsUrl = wsProto + location.hostname + ':8080/ws';
				console.log('URL WebSocket:', wsUrl);
				window.ws = new WebSocket(wsUrl);
				window.ws.onopen = function() {
					console.log('‚úÖ WebSocket ABIERTO - readyState:', window.ws.readyState);
					setConexion(true);
					conectado = true;
					// Solicitar datos completos al conectar para asegurar estados iniciales de rel√©s
					window.ws.send(JSON.stringify({ tipo: 'obtener_datos' }));
					console.log('üì§ Enviado: obtener_datos');
					// Asegurar que el mapa se inicialice si no lo est√°
					setTimeout(function() {
						if (window._leafletMap && window._leafletMap.invalidateSize) {
							window._leafletMap.invalidateSize();
							console.log('Mapa redimensionado');
						}
					}, 500);
				};
				window.ws.onclose = function() {
					console.log('‚ùå WebSocket CERRADO');
					setConexion(false);
					conectado = false;
					setTimeout(conectarWS, 2000); // reconectar
				};
				window.ws.onerror = function(error) {
					console.error('‚ö†Ô∏è Error WebSocket:', error);
					setConexion(false);
				};
				window.ws.onmessage = function(event) {
					console.log('üì• Mensaje WebSocket recibido:', event.data);
					try {
						let data = JSON.parse(event.data);
						console.log('Tipo de mensaje:', data.tipo);
						if (data.tipo === 'conexion' || data.tipo === 'datos') {
							console.log('Recibido conexion/datos, nombres_reles:', data.nombres_reles);
							if (data.nombres_reles) {
								window.nombres_reles = data.nombres_reles;
							}
							actualizarIndicadores(data);
							if (data.reles) {
								console.log('Llamando renderReles con:', data.reles);
								renderReles(data.reles);
							}
							// Cargar velocidad guardada de BD
							if (typeof data.velocidad !== 'undefined') {
								console.log('üì§ Velocidad inicial recibida:', data.velocidad);
								aplicarVelocidadUI(Number(data.velocidad));
							}
							// Destino inicial
							if (data.destino && typeof mostrarDestino === 'function' && data.destino.latitud && data.destino.longitud) {
								try { mostrarDestino(Number(data.destino.latitud), Number(data.destino.longitud), data.destino.nombre || ''); } catch(e) { console.warn('No se pudo mostrar destino inicial:', e); }
							}
						}
						if (data.tipo === 'reles' && data.reles) {
							console.log('Tipo reles recibido:', data.reles);
							renderReles(data.reles);
						}
						if (data.tipo === 'respuesta_rele' && typeof data.numero !== 'undefined') {
							console.log('Respuesta de rel√©:', data.numero, 'estado:', data.estado, 'exito:', data.exito);
							const n = Number(data.numero);
							const on = (data.estado === 'on' || data.estado === true);
							estadoReles[n] = on;
							const btn = document.getElementById('rele' + n);
							if (btn) {
								btn.classList.toggle('activo', on);
								btn.classList.toggle('inactivo', !on);
								console.log('‚úÖ Bot√≥n rel√©', n, 'actualizado');
							}
						}
						// Respuestas GPS
						if (data.tipo === 'respuesta_gps') {
							console.log('Respuesta GPS:', data);
							if (data.exito) {
								alert('‚úî ' + (data.mensaje || 'Ubicaci√≥n guardada'));
							} else {
								alert('‚úñ ' + (data.mensaje || 'Error al guardar ubicaci√≥n'));
							}
						}
						if (data.tipo === 'destino_actual') {
							if (data.exito) {
								alert('üìç Destino establecido: ' + data.latitud + ', ' + data.longitud);
								if (typeof mostrarDestino === 'function' && data.latitud && data.longitud) {
									try { mostrarDestino(Number(data.latitud), Number(data.longitud), data.nombre || ''); } catch(e) {}
								}
							} else if (data.mensaje) {
								alert('‚úñ ' + data.mensaje);
							}
						}
					} catch(e) {
						console.error('Error al parsear mensaje WebSocket:', e, event.data);
					}
				};
			}
			window.addEventListener('DOMContentLoaded', () => {
				// Conectar eventos de botones de velocidad
				const mapeoVelocidad = [
					{ id: 'vel-lenta', valor: 30 },
					{ id: 'vel-media', valor: 60 },
					{ id: 'vel-rapida', valor: 90 }
				];
				mapeoVelocidad.forEach(cfg => {
					const btn = document.getElementById(cfg.id);
					if (!btn) return;
					btn.addEventListener('click', () => {
						console.log('Click en velocidad:', cfg.valor);
						if (!(window.ws && window.ws.readyState === 1)) {
							console.error('WebSocket no conectado');
							alert('Error: WebSocket no conectado');
							return;
						}
						console.log('Enviando velocidad:', cfg.valor);
						aplicarVelocidadUI(cfg.valor);
						window.ws.send(JSON.stringify({ 
							tipo: 'velocidad', 
							nivel: cfg.valor 
						}));
					});
				});

				// Eventos GPS
				const btnGuardarGPS = document.getElementById('gps-guardar');
				if (btnGuardarGPS) {
					btnGuardarGPS.addEventListener('click', () => {
						if (!(window.ws && window.ws.readyState === 1)) {
							alert('Error: WebSocket no conectado');
							return;
						}
						console.log('Solicitando guardar posici√≥n GPS actual...');
						window.ws.send(JSON.stringify({ tipo: 'gps_guardar' }));
					});
				}

				const btnIrDestino = document.getElementById('gps-destino');
				if (btnIrDestino) {
					btnIrDestino.addEventListener('click', () => {
						if (!(window.ws && window.ws.readyState === 1)) {
							alert('Error: WebSocket no conectado');
							return;
						}
						const entrada = prompt('Ingrese destino como "latitud,longitud" (ej: 4.7110,-74.0721)');
						if (!entrada) return;
						const partes = entrada.split(/[,\s]+/).map(s => s.trim()).filter(Boolean);
						if (partes.length < 2) {
							alert('Formato inv√°lido. Use: latitud,longitud');
							return;
						}
						const lat = parseFloat(partes[0]);
						const lon = parseFloat(partes[1]);
						if (!isFinite(lat) || !isFinite(lon)) {
							alert('Coordenadas inv√°lidas');
							return;
						}
						const nombre = (document.getElementById('gps-nombre')?.value || '').trim();
						console.log('Enviando destino:', lat, lon, nombre ? ('nombre=' + nombre) : '');
						window.ws.send(JSON.stringify({ tipo: 'gps_destino', latitud: lat, longitud: lon, nombre: nombre || undefined }));
					});
				}
				conectarWS();
			});
	</script>
	<script>
		// Men√∫s flotantes de c√°maras - Inicializar despu√©s de que el DOM est√© listo
		document.addEventListener('DOMContentLoaded', function() {
			function initMenuCam(camNum) {
				const btnMenu = document.getElementById(`btn-menu-cam${camNum}`);
				const menuOpciones = document.getElementById(`menu-cam${camNum}-opciones`);
				
				if (!btnMenu || !menuOpciones) {
					console.error(`No se encontraron elementos para c√°mara ${camNum}`);
					return;
				}
				
				btnMenu.onclick = function(e) {
					e.stopPropagation();
					menuOpciones.style.display = menuOpciones.style.display === 'none' ? 'block' : 'none';
				};
				
				// Cerrar men√∫ al clickear fuera
				document.addEventListener('click', function(e) {
					if (menuOpciones.style.display === 'block' && !menuOpciones.contains(e.target) && !btnMenu.contains(e.target)) {
						menuOpciones.style.display = 'none';
					}
				});
			}
			
			initMenuCam(1);
			initMenuCam(2);
			
			// Iniciar autom√°ticamente las c√°maras si est√° configurado
			async function iniciarCamarasAutomaticamente() {
				try {
					const res = await fetch('/api/config');
					if (res.ok) {
						const config = await res.json();
						
						// Iniciar c√°mara 1 si est√° configurada y no est√° desactivada
						if (config.iniciar_auto_camara1 !== false && !config.desactivar_camara1) {
							setTimeout(() => {
								const btnPlay1 = document.getElementById('playCam1');
								if (btnPlay1 && !playing.cam1) {
									btnPlay1.click();
									console.log('C√°mara 1 iniciada autom√°ticamente');
								}
							}, 500);
						}
						
						// Iniciar c√°mara 2 si est√° configurada y no est√° desactivada
						if (config.iniciar_auto_camara2 !== false && !config.desactivar_camara2) {
							setTimeout(() => {
								const btnPlay2 = document.getElementById('playCam2');
								if (btnPlay2 && !playing.cam2) {
									btnPlay2.click();
									console.log('C√°mara 2 iniciada autom√°ticamente');
								}
							}, 700);
						}
					}
				} catch (error) {
					console.error('Error al cargar configuraci√≥n para inicio autom√°tico:', error);
				}
			}
			
			// Llamar a la funci√≥n despu√©s de un breve delay para asegurar que todo est√© cargado
			setTimeout(iniciarCamarasAutomaticamente, 1000);
			
			// Men√∫ flotante del mapa
			const btnMenuMapa = document.getElementById('btn-menu-mapa');
			const menuMapaOpciones = document.getElementById('menu-mapa-opciones');
			
			if (btnMenuMapa && menuMapaOpciones) {
				btnMenuMapa.onclick = function(e) {
					e.stopPropagation();
					menuMapaOpciones.style.display = menuMapaOpciones.style.display === 'none' ? 'block' : 'none';
				};
				
				document.addEventListener('click', function(e) {
					if (menuMapaOpciones.style.display === 'block' && !menuMapaOpciones.contains(e.target) && !btnMenuMapa.contains(e.target)) {
						menuMapaOpciones.style.display = 'none';
					}
				});
			}
			
			// Guardar ubicaci√≥n con entrada de texto
			const btnGuardarUbicacion = document.getElementById('mapa-guardar-ubicacion');
			if (btnGuardarUbicacion) {
				btnGuardarUbicacion.onclick = function() {
					const nombre = prompt('Nombre de la ubicaci√≥n (opcional):');
					if (nombre === null) return; // Usuario cancel√≥
					
					const nombreFinal = nombre.trim() || `Ubicaci√≥n ${new Date().toLocaleString('es-ES', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}`;
					document.getElementById('gps-nombre').value = nombreFinal;
					document.getElementById('gps-guardar').click();
					menuMapaOpciones.style.display = 'none';
				};
			}
			
			// Grabar recorrido
			const btnGrabarRecorrido = document.getElementById('mapa-grabar-recorrido');
			if (btnGrabarRecorrido) {
				let grabandoRecorrido = false;
				btnGrabarRecorrido.onclick = function() {
					grabandoRecorrido = !grabandoRecorrido;
					if (grabandoRecorrido) {
						this.textContent = '‚èπÔ∏è Detener recorrido';
						this.style.background = '#d32f2f';
						console.log('Iniciando grabaci√≥n de recorrido...');
						// Aqu√≠ se implementar√≠a la l√≥gica para grabar el recorrido
					} else {
						this.textContent = 'üõ§Ô∏è Grabar recorrido';
						this.style.background = '';
						console.log('Deteniendo grabaci√≥n de recorrido...');
					}
					menuMapaOpciones.style.display = 'none';
				};
			}
		});
	</script>
