<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuraci√≥n - Drone Acu√°tico</title>
  <link rel="stylesheet" href="/static/tema_universal.css">
  <style>
    body, .config-main {
      text-align: left !important;
      background: #0f1218 !important;
      color: #e5e7eb !important;
      font-weight: 600 !important;
    }
    .config-main {
      max-width: 98vw;
      width: 100%;
      margin: 0 auto;
      padding: 0 2vw;
    }
    .panel-cam, .panel-bajo {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
    }
    .panel-bajo {
      grid-template-columns: 1fr 1fr 1fr;
    }
    @media (max-width: 700px) {
      .config-main {
        padding: 0 1vw;
      }
      .panel-cam, .panel-bajo {
        padding: 12px 4px !important;
      }
      .panel-bajo {
        grid-template-columns: 1fr 1fr;
      }
    }
    @media (max-width: 480px) {
      .panel-bajo {
        grid-template-columns: 1fr;
      }
      .panel-cam, .panel-bajo {
        padding: 8px 2px !important;
      }
      .config-main {
        padding: 0 0.5vw;
      }
      h2, h3 {
        font-size: 1.1em !important;
      }
    }
    
    /* Estilos mejorados para inputs y labels */
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="password"],
    select,
    textarea {
      font-size: 18px !important;
      font-family: 'Arial', 'Helvetica', 'Segoe UI', sans-serif !important;
      font-weight: 600 !important;
      padding: 12px 14px !important;
      border-radius: 8px !important;
      border: 2px solid #4b5563 !important;
      background: #111824 !important;
      color: #e5e7eb !important;
      box-sizing: border-box !important;
      line-height: 1.4 !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    }
    
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    input[type="password"]:focus,
    select:focus,
    textarea:focus {
      outline: none !important;
      border-color: #7dd3fc !important;
      background: #0b0f16 !important;
      box-shadow: 0 0 0 3px rgba(125, 211, 252, 0.15) !important;
    }
    
    input::placeholder {
      color: #94a3b8 !important;
      font-size: 16px !important;
      opacity: 0.8 !important;
    }
    
    label {
      font-size: 16px !important;
      font-weight: 700 !important;
      color: #7dd3fc !important;
      font-family: 'Arial', 'Helvetica', 'Segoe UI', sans-serif !important;
    }
    
    /* Ajustes para m√≥vil */
    @media (max-width: 480px) {
      input[type="text"],
      input[type="email"],
      input[type="number"],
      input[type="password"],
      select,
      textarea {
        font-size: 16px !important;
        padding: 10px 12px !important;
      }
      
      label {
        font-size: 15px !important;
      }
      
      input::placeholder {
        font-size: 14px !important;
      }
    }
  </style>

</head>
<body>
  <main class="config-main" style="max-width: 700px; margin: 32px auto; display: flex; flex-direction: column; align-items: stretch; gap: 28px;">
        <div style="margin-bottom: 18px; text-align: left; display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn" onclick="window.location.href='/'">‚üµ Regresar</button>
          <button class="btn btn-guardar" onclick="guardarConfig()">üíæ Guardar</button>
        </div>
    <!-- Datos generales -->
    <h2 style="margin-top:0; color:#6ec1e4;">Datos generales</h2>
    <div style="display: flex; flex-direction: column; gap: 12px;">
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="ipPublica">IP P√∫blica</label><input id="ipPublica" type="text" placeholder="192.168.1.15" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="correo">Correo de notificaci√≥n</label><input id="correo" type="email" placeholder="correo@dominio.com" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: row; align-items: center; gap: 8px;"><input id="solicitarPassword" type="checkbox" /><label for="solicitarPassword">Solicitar contrase√±a al entrar</label></div>
    </div>
    <!-- Configuraci√≥n GPS -->
    <h2 style="margin-top:0; color:#6ec1e4;">Configuraci√≥n GPS</h2>
    <div class="row" style="display: flex; flex-direction: row; align-items: center; gap: 8px;"><input id="guardarRecorrido" type="checkbox" /><label for="guardarRecorrido">‚úì Guardar recorrido autom√°ticamente</label></div>
    <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="frecuenciaGuardado">Frecuencia guardado GPS (seg)</label><input id="frecuenciaGuardado" type="number" min="5" max="300" step="5" placeholder="30" style="width: 100%;" /></div>
    <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="tamanoMapa">Tama√±o del mapa (px)</label><input id="tamanoMapa" type="number" min="200" max="800" step="10" placeholder="400" style="width: 100%;" /></div>
    <div id="mapa-gps-container"></div>


    <!-- C√°maras -->
    <h2 style="margin-top:0; color:#6ec1e4;">C√°maras</h2>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
      <button class="btn" onclick="buscarOnvif()">üîé Buscar c√°maras ONVIF</button>
      <span id="onvifStatus" style="color:#6ec1e4; font-weight:600;"></span>
    </div>
    <div id="onvifResultados" style="display:flex; flex-direction:column; gap:6px; margin-bottom:12px;"></div>
    <div style="display: flex; flex-direction: column; gap: 18px;">
      <div style="width: 100%; max-width: 600px; margin-bottom: 8px;">
        <h3 style="margin-top:0; color:#6ec1e4;">C√°mara 1 (ONVIF)</h3>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
          <label for="rtspCam1Url">URL RTSP completa <small style="color:#6ec1e4;">(recomendado)</small></label>
          <input id="rtspCam1Url" type="text" placeholder="rtsp://admin:admin@192.168.1.9:554/live/ch0" style="width:100%; font-family: monospace;" />
          <small style="color:#888;">O completa los campos individuales abajo:</small>
        </div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam1Host">IP / Host</label><input id="onvifCam1Host" type="text" placeholder="192.168.1.9" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam1Port">Puerto ONVIF</label><input id="onvifCam1Port" type="number" min="1" max="65535" placeholder="8899" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rtspCam1Port">Puerto RTSP</label><input id="rtspCam1Port" type="number" min="1" max="65535" placeholder="554" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam1User">Usuario</label><input id="onvifCam1User" type="text" placeholder="admin" value="admin" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam1Pass">Contrase√±a</label><div style="display:flex; gap:8px; align-items:center; width:100%;"><input id="onvifCam1Pass" type="password" placeholder="admin" value="admin" style="width:100%;" /><button class="btn" style="min-width:96px; padding:10px 12px; font-weight:600;" type="button" onclick="togglePassword('onvifCam1Pass', this)">üëÅ Mostrar</button></div></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam1Perfil">Ruta RTSP del stream <small style="color:#888;">(ej: live/ch0, Streaming/Channels/101)</small></label><input id="onvifCam1Perfil" type="text" placeholder="live/ch0" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: row; align-items: center; gap: 8px;"><input id="desactivarCamara1" type="checkbox" /><label for="desactivarCamara1">Desactivar C√°mara 1</label></div>
        <div class="row" style="display: flex; flex-direction: row; align-items: center; gap: 8px;"><input id="iniciarAutoCamara1" type="checkbox" checked /><label for="iniciarAutoCamara1">‚úì Iniciar autom√°ticamente la c√°mara</label></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
          <label for="modoResolucionCam1">Modo de resoluci√≥n</label>
          <select id="modoResolucionCam1" onchange="toggleResolucionManual('cam1')" style="width:100%;">
            <option value="manual">Manual</option>
            <option value="automatico">Autom√°tico (seg√∫n velocidad de internet)</option>
          </select>
        </div>
        <div class="row" id="resolucionManualCam1" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
          <label for="resolucionCam1">Resoluci√≥n</label>
          <select id="resolucionCam1" style="width:100%;">
            <option value="360p">360p (640x360) - Latencia m√≠nima</option>
            <option value="480p" selected>480p (854x480) - Balanceado</option>
            <option value="720p">720p (1280x720) - Alta calidad</option>
            <option value="1080p">1080p (1920x1080) - M√°xima calidad</option>
          </select>
        </div>
      </div>
      <div style="width: 100%; max-width: 600px;">
        <h3 style="margin-top:0; color:#6ec1e4;">C√°mara 2 (ONVIF)</h3>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
          <label for="rtspCam2Url">URL RTSP completa <small style="color:#6ec1e4;">(recomendado)</small></label>
          <input id="rtspCam2Url" type="text" placeholder="rtsp://admin:admin@192.168.1.10:554/live/ch0" style="width:100%; font-family: monospace;" />
          <small style="color:#888;">O completa los campos individuales abajo:</small>
        </div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam2Host">IP / Host</label><input id="onvifCam2Host" type="text" placeholder="192.168.1.10" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam2Port">Puerto ONVIF</label><input id="onvifCam2Port" type="number" min="1" max="65535" placeholder="8899" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rtspCam2Port">Puerto RTSP</label><input id="rtspCam2Port" type="number" min="1" max="65535" placeholder="554" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam2User">Usuario</label><input id="onvifCam2User" type="text" placeholder="admin" value="admin" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam2Pass">Contrase√±a</label><div style="display:flex; gap:8px; align-items:center; width:100%;"><input id="onvifCam2Pass" type="password" placeholder="admin" value="admin" style="width:100%;" /><button class="btn" style="min-width:96px; padding:10px 12px; font-weight:600;" type="button" onclick="togglePassword('onvifCam2Pass', this)">üëÅ Mostrar</button></div></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="onvifCam2Perfil">Ruta RTSP del stream <small style="color:#888;">(ej: live/ch0, Streaming/Channels/101)</small></label><input id="onvifCam2Perfil" type="text" placeholder="live/ch0" style="width:100%;" /></div>
        <div class="row" style="display: flex; flex-direction: row; align-items: center; gap: 8px;"><input id="desactivarCamara2" type="checkbox" /><label for="desactivarCamara2">Desactivar C√°mara 2</label></div>
        <div class="row" style="display: flex; flex-direction: row; align-items: center; gap: 8px;"><input id="iniciarAutoCamara2" type="checkbox" checked /><label for="iniciarAutoCamara2">‚úì Iniciar autom√°ticamente la c√°mara</label></div>
        <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
          <label for="modoResolucionCam2">Modo de resoluci√≥n</label>
          <select id="modoResolucionCam2" onchange="toggleResolucionManual('cam2')" style="width:100%;">
            <option value="manual">Manual</option>
            <option value="automatico">Autom√°tico (seg√∫n velocidad de internet)</option>
          </select>
        </div>
        <div class="row" id="resolucionManualCam2" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
          <label for="resolucionCam2">Resoluci√≥n</label>
          <select id="resolucionCam2" style="width:100%;">
            <option value="360p">360p (640x360) - Latencia m√≠nima</option>
            <option value="480p" selected>480p (854x480) - Balanceado</option>
            <option value="720p">720p (1280x720) - Alta calidad</option>
            <option value="1080p">1080p (1920x1080) - M√°xima calidad</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Rel√©s -->
    <h2 style="margin-top:0; color:#6ec1e4;">‚ö° Nombres de Rel√©s (1‚Äì9)</h2>
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rele1">Rel√© 1</label><input id="rele1" type="text" placeholder="Nombre 1" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rele2">Rel√© 2</label><input id="rele2" type="text" placeholder="Nombre 2" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rele3">Rel√© 3</label><input id="rele3" type="text" placeholder="Nombre 3" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rele4">Rel√© 4</label><input id="rele4" type="text" placeholder="Nombre 4" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rele5">Rel√© 5</label><input id="rele5" type="text" placeholder="Nombre 5" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rele6">Rel√© 6</label><input id="rele6" type="text" placeholder="Nombre 6" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rele7">Rel√© 7</label><input id="rele7" type="text" placeholder="Nombre 7" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rele8">Rel√© 8</label><input id="rele8" type="text" placeholder="Nombre 8" style="width: 100%;" /></div>
      <div class="row" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;"><label for="rele9">Rel√© 9</label><input id="rele9" type="text" placeholder="Nombre 9" style="width: 100%;" /></div>
    </div>
  </main>

  <footer style="text-align:center; margin: 24px 0;">
    <button class="btn" onclick="window.location.href='/'">‚üµ Regresar</button>
    <button class="btn btn-guardar" onclick="guardarConfig()">üíæ Guardar</button>
  </footer>
  <div id="mensaje" class="msg"></div>

  <script>
        // Mostrar el mapa con la ubicaci√≥n actual
        function mostrarUbicacionActual() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              if (window.mostrarMapaGPS) {
                window.mostrarMapaGPS(lat, lon);
              } else {
                const script = document.createElement('script');
                script.src = 'leaflet_loader.js';
                script.onload = function() {
                  window.mostrarMapaGPS(lat, lon);
                };
                document.body.appendChild(script);
              }
            }, function(err) {
              setMsg('No se pudo obtener la ubicaci√≥n actual.', false);
            });
          } else {
            setMsg('Geolocalizaci√≥n no soportada.', false);
          }
        }
        document.addEventListener('DOMContentLoaded', mostrarUbicacionActual);
    const API = '/api/config';

    function volverAlControl() {
      window.location.href = '/';
    }

    function setMsg(texto, ok = true) {
      const el = document.getElementById('mensaje');
      el.textContent = texto;
      el.style.color = ok ? '#B2FF59' : '#FFCDD2';
      setTimeout(() => el.textContent = '', 3000);
    }

    function togglePassword(id, btn) {
      const input = document.getElementById(id);
      if (!input) return;
      const isHidden = input.type === 'password';
      input.type = isHidden ? 'text' : 'password';
      if (btn) {
        btn.textContent = isHidden ? 'üôà Ocultar' : 'üëÅ Mostrar';
      }
    }

    function recogerConfig() {
      return {
        ip_publica: document.getElementById('ipPublica').value.trim(),
        solicitar_password: document.getElementById('solicitarPassword').checked,
        correo: document.getElementById('correo').value.trim(),
        tamano_mapa: parseInt(document.getElementById('tamanoMapa').value || '400', 10),
        guardar_recorrido: document.getElementById('guardarRecorrido').checked,
        frecuencia_guardado: parseInt(document.getElementById('frecuenciaGuardado').value || '30', 10),
        rtsp_camara1_url: document.getElementById('rtspCam1Url').value.trim(),
        onvif_camara1_host: document.getElementById('onvifCam1Host').value.trim(),
        onvif_camara1_puerto: parseInt(document.getElementById('onvifCam1Port').value || '8899', 10),
        rtsp_camara1_puerto: parseInt(document.getElementById('rtspCam1Port').value || '554', 10),
        onvif_camara1_usuario: document.getElementById('onvifCam1User').value.trim(),
        onvif_camara1_contrasena: document.getElementById('onvifCam1Pass').value,
        onvif_camara1_perfil: document.getElementById('onvifCam1Perfil').value.trim(),
        desactivar_camara1: document.getElementById('desactivarCamara1').checked,
        iniciar_auto_camara1: document.getElementById('iniciarAutoCamara1').checked,
        camara1_modo_resolucion: document.getElementById('modoResolucionCam1').value,
        camara1_resolucion: document.getElementById('resolucionCam1').value,
        rtsp_camara2_url: document.getElementById('rtspCam2Url').value.trim(),
        onvif_camara2_host: document.getElementById('onvifCam2Host').value.trim(),
        onvif_camara2_puerto: parseInt(document.getElementById('onvifCam2Port').value || '8899', 10),
        rtsp_camara2_puerto: parseInt(document.getElementById('rtspCam2Port').value || '554', 10),
        onvif_camara2_usuario: document.getElementById('onvifCam2User').value.trim(),
        onvif_camara2_contrasena: document.getElementById('onvifCam2Pass').value,
        onvif_camara2_perfil: document.getElementById('onvifCam2Perfil').value.trim(),
        desactivar_camara2: document.getElementById('desactivarCamara2').checked,
        iniciar_auto_camara2: document.getElementById('iniciarAutoCamara2').checked,
        camara2_modo_resolucion: document.getElementById('modoResolucionCam2').value,
        camara2_resolucion: document.getElementById('resolucionCam2').value,
        reles: {
          1: document.getElementById('rele1').value.trim(),
          2: document.getElementById('rele2').value.trim(),
          3: document.getElementById('rele3').value.trim(),
          4: document.getElementById('rele4').value.trim(),
          5: document.getElementById('rele5').value.trim(),
          6: document.getElementById('rele6').value.trim(),
          7: document.getElementById('rele7').value.trim(),
          8: document.getElementById('rele8').value.trim(),
          9: document.getElementById('rele9').value.trim()
        }
      };
    }

    function llenarCampos(cfg) {
      if (!cfg) return;
      document.getElementById('ipPublica').value = cfg.ip_publica || '';
      document.getElementById('solicitarPassword').checked = !!cfg.solicitar_password;
      document.getElementById('correo').value = cfg.correo || '';
      document.getElementById('tamanoMapa').value = cfg.tamano_mapa || 400;
      document.getElementById('guardarRecorrido').checked = !!cfg.guardar_recorrido;
      document.getElementById('frecuenciaGuardado').value = cfg.frecuencia_guardado || 30;
      document.getElementById('rtspCam1Url').value = cfg.rtsp_camara1_url || '';
      document.getElementById('onvifCam1Host').value = cfg.onvif_camara1_host || '';
      document.getElementById('onvifCam1Port').value = cfg.onvif_camara1_puerto || 8899;
      document.getElementById('rtspCam1Port').value = cfg.rtsp_camara1_puerto || 554;
      document.getElementById('onvifCam1User').value = cfg.onvif_camara1_usuario || 'admin';
      document.getElementById('onvifCam1Pass').value = cfg.onvif_camara1_contrasena || 'admin';
      document.getElementById('onvifCam1Perfil').value = cfg.onvif_camara1_perfil || 'Streaming/Channels/101';
      document.getElementById('desactivarCamara1').checked = !!cfg.desactivar_camara1;
      document.getElementById('iniciarAutoCamara1').checked = (cfg.iniciar_auto_camara1 !== undefined) ? !!cfg.iniciar_auto_camara1 : true;
      document.getElementById('modoResolucionCam1').value = cfg.camara1_modo_resolucion || 'manual';
      document.getElementById('resolucionCam1').value = cfg.camara1_resolucion || '480p';
      toggleResolucionManual('cam1');
      document.getElementById('rtspCam2Url').value = cfg.rtsp_camara2_url || '';
      document.getElementById('onvifCam2Host').value = cfg.onvif_camara2_host || '';
      document.getElementById('onvifCam2Port').value = cfg.onvif_camara2_puerto || 8899;
      document.getElementById('rtspCam2Port').value = cfg.rtsp_camara2_puerto || 554;
      document.getElementById('onvifCam2User').value = cfg.onvif_camara2_usuario || 'admin';
      document.getElementById('onvifCam2Pass').value = cfg.onvif_camara2_contrasena || 'admin';
      document.getElementById('onvifCam2Perfil').value = cfg.onvif_camara2_perfil || 'Streaming/Channels/101';
      document.getElementById('desactivarCamara2').checked = !!cfg.desactivar_camara2;
      document.getElementById('iniciarAutoCamara2').checked = (cfg.iniciar_auto_camara2 !== undefined) ? !!cfg.iniciar_auto_camara2 : true;
      document.getElementById('modoResolucionCam2').value = cfg.camara2_modo_resolucion || 'manual';
      document.getElementById('resolucionCam2').value = cfg.camara2_resolucion || '480p';
      toggleResolucionManual('cam2');
      if (cfg.reles) {
        for (let i = 1; i <= 9; i++) {
          const val = (cfg.reles[i] || '');
          document.getElementById('rele'+i).value = val;
        }
      }
    }

    function toggleResolucionManual(camId) {
      const modo = document.getElementById(`modoResolucionCam${camId === 'cam1' ? '1' : '2'}`).value;
      const divManual = document.getElementById(`resolucionManualCam${camId === 'cam1' ? '1' : '2'}`);
      if (modo === 'manual') {
        divManual.style.display = 'flex';
      } else {
        divManual.style.display = 'none';
      }
    }

    async function guardarConfig() {
      const cfg = recogerConfig();
      try {
        const res = await fetch(API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg) });
        const data = await res.json();
        if (data.exito) setMsg('Configuraci√≥n guardada en la base de datos.');
        else setMsg('Error en guardado: ' + (data.mensaje || 'Desconocido'), false);
      } catch (e) {
        setMsg('Error conectando al servidor.', false);
      }
    }

    async function cargarConfig() {
      try {
        const res = await fetch(API);
        if (!res.ok) return setMsg('Sin configuraci√≥n en servidor.', false);
        const cfg = await res.json();
        llenarCampos(cfg);
        setMsg('Configuraci√≥n cargada desde servidor.');
      } catch (e) {
        setMsg('Error cargando configuraci√≥n del servidor.', false);
      }
    }

    // Descubrimiento ONVIF
    async function buscarOnvif() {
      const status = document.getElementById('onvifStatus');
      const cont = document.getElementById('onvifResultados');
      status.textContent = 'Buscando c√°maras ONVIF...';
      cont.innerHTML = '';
      try {
        const res = await fetch('/api/onvif/discover');
        if (!res.ok) {
          status.textContent = 'No se pudo buscar c√°maras.';
          return;
        }
        const data = await res.json();
        const dispositivos = data.dispositivos || [];
        if (!dispositivos.length) {
          status.textContent = 'No se encontraron c√°maras ONVIF.';
          return;
        }
        status.textContent = `Encontradas ${dispositivos.length} c√°mara(s).`;
        dispositivos.forEach((d, idx) => {
          const div = document.createElement('div');
          div.style.display = 'flex';
          div.style.gap = '6px';
          div.style.alignItems = 'center';
          div.style.flexWrap = 'wrap';
          div.style.padding = '4px 0';
          div.innerHTML = `<strong>${idx+1}.</strong> ${d.host}:${d.puerto} <small style="color:#888;">(Servicio: ${d.xaddrs || 'N/A'})</small>`;
          const btn1 = document.createElement('button');
          btn1.className = 'btn';
          btn1.textContent = 'Usar en C√°mara 1';
          btn1.onclick = () => {
            document.getElementById('onvifCam1Host').value = d.host || '';
            document.getElementById('onvifCam1Port').value = d.puerto || 8899;
            document.getElementById('onvifCam1User').value = 'admin';
            document.getElementById('onvifCam1Pass').value = 'admin';
          };
          const btn2 = document.createElement('button');
          btn2.className = 'btn';
          btn2.textContent = 'Usar en C√°mara 2';
          btn2.onclick = () => {
            document.getElementById('onvifCam2Host').value = d.host || '';
            document.getElementById('onvifCam2Port').value = d.puerto || 8899;
            document.getElementById('onvifCam2User').value = 'admin';
            document.getElementById('onvifCam2Pass').value = 'admin';
          };
          div.appendChild(btn1);
          div.appendChild(btn2);
          cont.appendChild(div);
        });
      } catch (e) {
        status.textContent = 'Error en b√∫squeda ONVIF.';
      }
    }

    window.onload = function() {
      cargarConfig();
    };
  </script>

</main>
</body>
</html>
