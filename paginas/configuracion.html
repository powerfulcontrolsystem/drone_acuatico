<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuraci√≥n - Drone Acu√°tico</title>
  <link rel="stylesheet" href="/static/tema_universal.css">
  <!-- MARCADOR: SOLO tema_universal.css cargado -->
</head>
<body>
  <main class="config-main" style="max-width: 700px; margin: 32px auto; display: flex; flex-direction: column; gap: 24px;">
    <section class="card" style="margin:0;">
      <h1 style="text-align:center;">Configuraci√≥n General</h1>
      <div class="grid">
        <div class="row"><label for="ipPublica">IP P√∫blica</label><input id="ipPublica" type="text" placeholder="192.168.1.15" /></div>
        <div class="row"><label for="correo">Correo de notificaci√≥n</label><input id="correo" type="email" placeholder="correo@dominio.com" /></div>
        <div class="row"><label for="tamanoMapa">Tama√±o del mapa (px)</label><input id="tamanoMapa" type="number" min="200" max="800" step="10" placeholder="400" /></div>
        <div class="row"><input id="solicitarPassword" type="checkbox" /><label for="solicitarPassword">Solicitar contrase√±a al entrar</label></div>
        <div class="row"><label for="frecuenciaGuardado">Frecuencia guardado GPS (seg)</label><input id="frecuenciaGuardado" type="number" min="5" max="300" step="5" placeholder="30" /></div>
      </div>
    </section>
    <section class="card" style="margin:0;">
      <div class="row">
        <input id="guardarRecorrido" type="checkbox" />
        <label for="guardarRecorrido">‚úì Guardar recorrido autom√°ticamente</label>
      </div>
      <div id="mapa-gps-container"></div>
    </section>


    <section class="card" style="margin:0;">
      <h2>üì∑ C√°maras</h2>
      <div class="grid-uno">
        <div class="row"><label for="urlCamara1SD">URL RTSP C√°mara 1 - Calidad SD</label><input id="urlCamara1SD" type="text" placeholder="rtsp://usuario:clave@192.168.1.9:554/live/ch0" /></div>
        <div class="row"><label for="urlCamara1HD">URL RTSP C√°mara 1 - Calidad HD/2K</label><input id="urlCamara1HD" type="text" placeholder="rtsp://usuario:clave@192.168.1.9:554/live/ch1" /></div>
        <div class="row"><input id="desactivarCamara1" type="checkbox" /><label for="desactivarCamara1">Desactivar C√°mara 1</label></div>
        <div class="row"><label for="urlCamara2SD">URL RTSP C√°mara 2 - Calidad SD</label><input id="urlCamara2SD" type="text" placeholder="rtsp://usuario:clave@192.168.1.10:554/live/ch0" /></div>
        <div class="row"><label for="urlCamara2HD">URL RTSP C√°mara 2 - Calidad HD/2K</label><input id="urlCamara2HD" type="text" placeholder="rtsp://usuario:clave@192.168.1.10:554/live/ch1" /></div>
        <div class="row"><input id="desactivarCamara2" type="checkbox" /><label for="desactivarCamara2">Desactivar C√°mara 2</label></div>
      </div>
    </section>

    <section class="card" style="margin:0;">
      <h2>‚ö° Nombres de Rel√©s (1‚Äì9)</h2>
      <div class="grid">
        <div class="row"><label for="rele1">Rel√© 1</label><input id="rele1" type="text" placeholder="Nombre 1" /></div>
        <div class="row"><label for="rele2">Rel√© 2</label><input id="rele2" type="text" placeholder="Nombre 2" /></div>
        <div class="row"><label for="rele3">Rel√© 3</label><input id="rele3" type="text" placeholder="Nombre 3" /></div>
        <div class="row"><label for="rele4">Rel√© 4</label><input id="rele4" type="text" placeholder="Nombre 4" /></div>
        <div class="row"><label for="rele5">Rel√© 5</label><input id="rele5" type="text" placeholder="Nombre 5" /></div>
        <div class="row"><label for="rele6">Rel√© 6</label><input id="rele6" type="text" placeholder="Nombre 6" /></div>
        <div class="row"><label for="rele7">Rel√© 7</label><input id="rele7" type="text" placeholder="Nombre 7" /></div>
        <div class="row"><label for="rele8">Rel√© 8</label><input id="rele8" type="text" placeholder="Nombre 8" /></div>
        <div class="row"><label for="rele9">Rel√© 9</label><input id="rele9" type="text" placeholder="Nombre 9" /></div>
      </div>
    </section>
  </main>

  <footer style="text-align:center; margin: 24px 0;">
    <button class="btn btn-guardar" onclick="guardarConfig()">üíæ Guardar</button>
    <button class="btn btn-cargar" onclick="cargarConfig()">‚§≥ Cargar</button>
  </footer>
  <div id="mensaje" class="msg"></div>

  <script>
        // Mostrar el mapa con la ubicaci√≥n actual
        function mostrarUbicacionActual() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              if (window.mostrarMapaGPS) {
                window.mostrarMapaGPS(lat, lon);
              } else {
                const script = document.createElement('script');
                script.src = 'leaflet_loader.js';
                script.onload = function() {
                  window.mostrarMapaGPS(lat, lon);
                };
                document.body.appendChild(script);
              }
            }, function(err) {
              setMsg('No se pudo obtener la ubicaci√≥n actual.', false);
            });
          } else {
            setMsg('Geolocalizaci√≥n no soportada.', false);
          }
        }
        document.addEventListener('DOMContentLoaded', mostrarUbicacionActual);
    const API = '/api/config';

    function volverAlControl() {
      window.location.href = '/';
    }

    function setMsg(texto, ok = true) {
      const el = document.getElementById('mensaje');
      el.textContent = texto;
      el.style.color = ok ? '#B2FF59' : '#FFCDD2';
      setTimeout(() => el.textContent = '', 3000);
    }

    function recogerConfig() {
      return {
        ip_publica: document.getElementById('ipPublica').value.trim(),
        solicitar_password: document.getElementById('solicitarPassword').checked,
        correo: document.getElementById('correo').value.trim(),
        tamano_mapa: parseInt(document.getElementById('tamanoMapa').value || '400', 10),
        guardar_recorrido: document.getElementById('guardarRecorrido').checked,
        frecuencia_guardado: parseInt(document.getElementById('frecuenciaGuardado').value || '30', 10),
        url_camara1_sd: document.getElementById('urlCamara1SD').value.trim(),
        url_camara1_hd: document.getElementById('urlCamara1HD').value.trim(),
        desactivar_camara1: document.getElementById('desactivarCamara1').checked,
        url_camara2_sd: document.getElementById('urlCamara2SD').value.trim(),
        url_camara2_hd: document.getElementById('urlCamara2HD').value.trim(),
        desactivar_camara2: document.getElementById('desactivarCamara2').checked,
        reles: {
          1: document.getElementById('rele1').value.trim(),
          2: document.getElementById('rele2').value.trim(),
          3: document.getElementById('rele3').value.trim(),
          4: document.getElementById('rele4').value.trim(),
          5: document.getElementById('rele5').value.trim(),
          6: document.getElementById('rele6').value.trim(),
          7: document.getElementById('rele7').value.trim(),
          8: document.getElementById('rele8').value.trim(),
          9: document.getElementById('rele9').value.trim()
        }
      };
    }

    function llenarCampos(cfg) {
      if (!cfg) return;
      document.getElementById('ipPublica').value = cfg.ip_publica || '';
      document.getElementById('solicitarPassword').checked = !!cfg.solicitar_password;
      document.getElementById('correo').value = cfg.correo || '';
      document.getElementById('tamanoMapa').value = cfg.tamano_mapa || 400;
      document.getElementById('guardarRecorrido').checked = !!cfg.guardar_recorrido;
      document.getElementById('frecuenciaGuardado').value = cfg.frecuencia_guardado || 30;
      document.getElementById('urlCamara1SD').value = cfg.url_camara1_sd || '';
      document.getElementById('urlCamara1HD').value = cfg.url_camara1_hd || '';
      document.getElementById('desactivarCamara1').checked = !!cfg.desactivar_camara1;
      document.getElementById('urlCamara2SD').value = cfg.url_camara2_sd || '';
      document.getElementById('urlCamara2HD').value = cfg.url_camara2_hd || '';
      document.getElementById('desactivarCamara2').checked = !!cfg.desactivar_camara2;
      if (cfg.reles) {
        for (let i = 1; i <= 9; i++) {
          const val = (cfg.reles[i] || '');
          document.getElementById('rele'+i).value = val;
        }
      }
    }

    async function guardarConfig() {
      const cfg = recogerConfig();
      try {
        const res = await fetch(API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg) });
        const data = await res.json();
        if (data.exito) setMsg('Configuraci√≥n guardada en la base de datos.');
        else setMsg('Error en guardado: ' + (data.mensaje || 'Desconocido'), false);
      } catch (e) {
        setMsg('Error conectando al servidor.', false);
      }
    }

    async function cargarConfig() {
      try {
        const res = await fetch(API);
        if (!res.ok) return setMsg('Sin configuraci√≥n en servidor.', false);
        const cfg = await res.json();
        llenarCampos(cfg);
        setMsg('Configuraci√≥n cargada desde servidor.');
      } catch (e) {
        setMsg('Error cargando configuraci√≥n del servidor.', false);
      }
    }

    window.onload = function() {
      cargarConfig();
    };
  </script>
  <script src="tema.js"></script>
  <script>
    // MARCADOR: Script de depuraci√≥n de tema universal
    console.log('MARCADOR: configuracion.html cargando tema_universal.css');
    const testDiv = document.createElement('div');
    testDiv.textContent = 'MARCADOR VISUAL: CSS universal activo';
    testDiv.style.background = '#6ec1e4';
    testDiv.style.color = '#232a36';
    testDiv.style.padding = '8px';
    testDiv.style.textAlign = 'center';
    testDiv.style.fontWeight = 'bold';
    testDiv.style.margin = '12px 0';
    document.body.insertBefore(testDiv, document.body.firstChild);
  </script>
</main>
</body>
</html>
