<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Remoto Digital - Drone Acu√°tico</title>
    
    <link rel="stylesheet" href="tema.css?v=20251229b">
    
    <style>
        /* SOLO LAYOUT - SIN COLORES */
        body { padding: 5px; overflow: hidden; height: 100vh; }
        .container { max-width: 100%; height: 100%; display: flex; flex-direction: column; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; margin-bottom: 5px; flex-shrink: 0; }
        .header-right { display: flex; gap: 12px; align-items: center; }
        h1 { font-size: 16px; margin: 0; flex: 1; }
        .estado-conexion { padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .conectado { }
        .desconectado { }
        .info-sistema { display: flex; gap: 6px; align-items: center; font-size: 11px; }
        .indicador-bat, .indicador-peso { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-family: monospace; }
        .bat-ok {  }
        .bat-warning {  }
        .bat-critical {  }
        .peso-ok {  }
        .peso-warning {  }
        .peso-critical {  }
        .grid-vistas { display: grid; grid-template-columns: 1fr 1fr 1fr; margin-bottom: 5px; flex: 1; min-height: 0; gap: 5px; }
        .vista-columna { padding: 8px; display: flex; flex-direction: column; min-height: 0; }
        .vista-titulo { font-size: 12px; font-weight: bold; text-align: center; margin-bottom: 5px; padding: 4px; flex-shrink: 0; }
        .camara { overflow: hidden; flex: 1; min-height: 0; display: flex; align-items: center; justify-content: center; }
        .camara img { width: 100%; height: 100%; object-fit: cover; }
        .camara-placeholder { font-size: 11px; }
        #mapa { width: 100%; height: 100%; }
        .panel-controles { padding: 10px; flex-shrink: 0; }
        .panel-controles h3 { font-size: 14px; margin: 0 0 10px 0; text-align: center; padding-bottom: 8px; }
        .grid-reles { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .btn-rele { border: none; padding: 12px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .btn-rele:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .btn-rele:active { transform: scale(0.95); }
        .btn-rele.activo { }
        @media (orientation: portrait) { .grid-vistas { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { h1 { font-size: 14px; } .btn-rele { padding: 10px; font-size: 12px; } }
    </style>
</head>
<body>
    <!-- Bot√≥n flotante para cambiar tema -->
    <button id="btn-cambiar-tema" class="btn-tema-flotante" onclick="cambiarTema()" title="Cambiar tema">üåô</button>
    
    <div class="container">
        <!-- Header -->
        <header>
            <h1>üö§ Control Remoto Digital</h1>
            <div class="header-right">
                <div class="info-sistema">
                    <span id="estado-conexion" class="estado-conexion desconectado">‚óè Desconectado</span>
                    <span id="indicador-bat" class="indicador-bat">üîã --%</span>
                    <span id="indicador-peso" class="indicador-peso">‚öñÔ∏è -- kg</span>
                </div>
            </div>
        </header>

        <!-- Grid de 3 columnas: C√°mara 1, C√°mara 2, Mapa -->
        <div class="grid-vistas">
            <!-- C√°mara 1 -->
            <div class="vista-columna">
                <div class="vista-titulo">üìπ C√°mara 1</div>
                <div class="camara">
                    <div class="camara-placeholder" id="camara1-placeholder">
                        C√°mara 1 no configurada
                    </div>
                </div>
            </div>

            <!-- C√°mara 2 -->
            <div class="vista-columna">
                <div class="vista-titulo">üìπ C√°mara 2</div>
                <div class="camara">
                    <div class="camara-placeholder" id="camara2-placeholder">
                        C√°mara 2 no configurada
                    </div>
                </div>
            </div>

            <!-- Mapa GPS -->
            <div class="vista-columna">
                <div class="vista-titulo">üó∫Ô∏è Mapa GPS</div>
                <div id="mapa"></div>
            </div>
        </div>

        <!-- Panel de control de rel√©s -->
        <div class="panel-controles">
            <h3>‚ö° CONTROL DE REL√âS GPIO</h3>
            <div class="grid-reles">
                <button class="btn-rele" id="rele-1" onclick="toggleRele(1)">R1</button>
                <button class="btn-rele" id="rele-2" onclick="toggleRele(2)">R2</button>
                <button class="btn-rele" id="rele-3" onclick="toggleRele(3)">R3</button>
                <button class="btn-rele" id="rele-4" onclick="toggleRele(4)">R4</button>
                <button class="btn-rele" id="rele-5" onclick="toggleRele(5)">R5</button>
                <button class="btn-rele" id="rele-6" onclick="toggleRele(6)">R6</button>
                <button class="btn-rele" id="rele-7" onclick="toggleRele(7)">R7</button>
                <button class="btn-rele" id="rele-8" onclick="toggleRele(8)">R8</button>
                <button class="btn-rele" id="rele-9" onclick="toggleRele(9)">R9</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let ws = null;
        let mapa = null;
        let estadoReles = {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false, 8: false, 9: false};
        let nombresReles = {1: 'R1', 2: 'R2', 3: 'R3', 4: 'R4', 5: 'R5', 6: 'R6', 7: 'R7', 8: 'R8', 9: 'R9'};

        // ==================== WEBSOCKET ====================
        
        function conectarWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket conectado');
                document.getElementById('estado-conexion').textContent = '‚óè Conectado';
                document.getElementById('estado-conexion').className = 'estado-conexion conectado';
            };

            ws.onmessage = function(event) {
                const datos = JSON.parse(event.data);
                procesarMensaje(datos);
            };

            ws.onclose = function() {
                console.log('WebSocket desconectado');
                document.getElementById('estado-conexion').textContent = '‚óè Desconectado';
                document.getElementById('estado-conexion').className = 'estado-conexion desconectado';
                
                // Reintentar conexi√≥n despu√©s de 3 segundos
                setTimeout(conectarWebSocket, 3000);
            };

            ws.onerror = function(error) {
                console.error('Error WebSocket:', error);
            };
        }

        function procesarMensaje(datos) {
            console.log('Mensaje recibido:', datos);

            switch(datos.tipo) {
                case 'conexion':
                    console.log('‚úì Conectado al servidor');
                    // Sincronizar estado de rel√©s
                    if (datos.reles) {
                        estadoReles = datos.reles;
                        // Cargar nombres si vienen en la conexi√≥n inicial
                        if (datos.nombres_reles) {
                            for (let i = 1; i <= 9; i++) {
                                const nombre = (datos.nombres_reles[i] || '').trim();
                                if (nombre) {
                                    nombresReles[i] = nombre;
                                }
                            }
                        }
                        actualizarUIReles();
                    }
                    break;

                case 'respuesta_rele':
                    if (datos.exito) {
                        console.log(`‚úì Rel√© ${datos.numero}: ${datos.estado}`);
                    } else {
                        console.error(`‚úó Error rel√© ${datos.numero}: ${datos.error}`);
                        // Revertir estado en caso de error
                        estadoReles[datos.numero] = !estadoReles[datos.numero];
                        actualizarBotonRele(datos.numero);
                    }
                    break;

                case 'estado_reles':
                    estadoReles = datos.reles;
                    actualizarUIReles();
                    break;

                case 'config_actualizada':
                    console.log('‚úì Configuraci√≥n actualizada, recargando nombres...');
                    cargarNombresReles();
                    break;

                case 'error':
                    console.error('‚úó Error:', datos.mensaje);
                    break;
            }
        }

        function enviarMensaje(datos) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(datos));
            } else {
                console.error('WebSocket no conectado');
            }
        }

        // ==================== CONTROL DE REL√âS ====================
        
        function toggleRele(numero) {
            const nuevoEstado = !estadoReles[numero];
            estadoReles[numero] = nuevoEstado;

            // Actualizar UI inmediatamente
            actualizarBotonRele(numero);

            // Enviar comando al servidor
            enviarMensaje({
                tipo: 'rele',
                numero: numero,
                estado: nuevoEstado
            });

            console.log(`Rel√© ${numero}: ${nuevoEstado ? 'ON' : 'OFF'}`);
        }

        function actualizarBotonRele(numero) {
            const boton = document.getElementById(`rele-${numero}`);
            const nombre = nombresReles[numero] || `R${numero}`;
            boton.textContent = nombre;
            if (estadoReles[numero]) {
                boton.classList.add('activo');
            } else {
                boton.classList.remove('activo');
            }
        }

        function actualizarUIReles() {
            for (let i = 1; i <= 9; i++) {
                actualizarBotonRele(i);
            }
        }

        // ==================== CARGAR CONFIGURACI√ìN ====================
        
        async function cargarNombresReles() {
            try {
                const res = await fetch('/api/config');
                if (!res.ok) return;
                const cfg = await res.json();
                if (cfg.reles) {
                    for (let i = 1; i <= 9; i++) {
                        const nombre = (cfg.reles[i] || '').trim();
                        if (nombre) {
                            nombresReles[i] = nombre;
                        }
                    }
                    // Actualizar botones con los nuevos nombres
                    actualizarUIReles();
                    console.log('‚úì Nombres de rel√©s cargados:', nombresReles);
                }
            } catch (e) {
                console.error('Error cargando nombres de rel√©s:', e);
            }
        }

        // ==================== MAPA ====================
        
        function inicializarMapa() {
            // Crear mapa centrado en Colombia (ajustar seg√∫n ubicaci√≥n)
            mapa = L.map('mapa').setView([4.6097, -74.0817], 13);
            
            // Capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(mapa);

            // Marcador de ejemplo
            L.marker([4.6097, -74.0817]).addTo(mapa)
                .bindPopup('Drone Acu√°tico')
                .openPopup();
        }

        // ==================== INICIALIZACI√ìN ====================
        
        window.onload = function() {
            console.log('Inicializando aplicaci√≥n...');
            cargarNombresReles();
            inicializarMapa();
            conectarWebSocket();
        };
    </script>
    <script src="tema.js"></script>
    <script src="config-ui.js"></script>
</body>
</html>
