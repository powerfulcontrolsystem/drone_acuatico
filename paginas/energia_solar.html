<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Victron 75/15 - Datos En Vivo</title>
	<style>
		body {
			background: #0f1218;
			color: #e5e7eb;
			font-family: Arial, sans-serif;
			padding: 20px;
			margin: 0;
			font-size: 14px;
			font-weight: 500;
		}
		.container {
			max-width: 1000px;
			margin: 0 auto;
		}
		h1 {
			color: #2196f3;
			margin-bottom: 10px;
			font-size: 24px;
			font-weight: 700;
		}
		.estado {
			font-size: 18px;
			font-weight: 700;
			margin-bottom: 20px;
			padding: 10px;
			border-radius: 5px;
		}
		.conectado {
			background: #4caf50;
			color: white;
		}
		.desconectado {
			background: #4caf50;
			color: white;
		}
		.datos {
			background: #1a1f28;
			border: 1px solid #2d3748;
			padding: 15px;
			border-radius: 5px;
			line-height: 1.5;
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 10px;
		}
		.linea {
			display: flex;
			flex-direction: column;
			padding: 10px;
			border: 1px solid #2d3748;
			border-radius: 6px;
			background: #0f1218;
			min-height: 50px;
		}
		.linea:last-child {
			border-bottom: 1px solid #2d3748;
		}
		.clave {
			color: #2196f3;
			font-weight: 600;
			min-width: auto;
			margin-bottom: 4px;
			font-size: 12px;
		}
		.valor {
			color: #4caf50;
			text-align: left;
			min-width: auto;
			font-size: 16px;
			font-weight: 700;
		}
		.valor-principal {
			color: #fff;
			font-size: 2em;
			font-weight: 900;
			margin-bottom: 2px;
		}
		.clave-principal {
			color: #2196f3;
			font-size: 1.1em;
			font-weight: 800;
			margin-bottom: 2px;
		}
		.error {
			color: #ff9800;
			font-size: 14px;
			font-weight: 600;
		}
		.btn {
			background: #2196f3;
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 600;
			margin-top: 15px;
		}
		.btn:hover {
			background: #1976d2;
		}
	</style>
</head>
<body>
	<div class="container">
		<button class="btn" onclick="irAtras()" style="margin-bottom: 15px;">‚¨Ö Atr√°s</button>
		<h1>üì° Victron 75/15 - Monitor En Vivo</h1>
		
		<div class="estado" id="estado">
			üî¥ Desconectado
		</div>
		
		<div class="datos" id="datos">
			<div class="linea">
				<span class="clave">Estado:</span>
				<span class="valor">Conectando...</span>
			</div>
		</div>
		
		<button class="btn" onclick="reconectar()">Reconectar WebSocket</button>
		<button class="btn" onclick="limpiarConsola()">Limpiar</button>
	</div>

	<script>
		function irAtras() {
			try {
				if (window.history && window.history.length > 1) {
					window.history.back();
					return;
				}
			} catch(e) {}
			// Fallback: ir directamente a la p√°gina de control
			window.location.href = 'control%20remoto%20digital.html';
		}

		let ws = null;
		let ultimosDatosValidos = null; // Guardar √∫ltimos datos v√°lidos
		
		function conectarWS() {
			console.log('[INFO] Intentando conectar WebSocket...');
			let wsProto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
			let wsUrl = wsProto + location.hostname + ':8080/ws';
			
			ws = new WebSocket(wsUrl);
			
			ws.onopen = function() {
				console.log('[OK] WebSocket conectado');
				// Solicitar datos iniciales
				ws.send(JSON.stringify({ tipo: 'obtener_datos' }));
			};
			
			ws.onmessage = function(event) {
				try {
					let data = JSON.parse(event.data);
					
					// Solo procesamos mensajes tipo 'solar'
					if (data.tipo === 'solar' && data.datos) {
						mostrarDatos(data.datos);
					}
				} catch(e) {
					console.error('[ERROR] Error procesando mensaje:', e);
				}
			};
			
			ws.onerror = function(error) {
				console.error('[ERROR] Error WebSocket:', error);
				document.getElementById('estado').className = 'estado desconectado';
				document.getElementById('estado').textContent = 'üî¥ Error de WebSocket';
			};
			
			ws.onclose = function() {
				console.warn('[WARN] WebSocket cerrado, reconectando en 3s...');
				document.getElementById('estado').className = 'estado desconectado';
				document.getElementById('estado').textContent = 'üî¥ Desconectado (reconectando...)';
				setTimeout(conectarWS, 3000);
			};
		}
		
		function mostrarDatos(datos) {
			const estado = document.getElementById('estado');
			const datosDiv = document.getElementById('datos');

			// WebSocket est√° conectado si recibimos datos
			// El campo datos.conectado indica si el Victron responde, no el WebSocket
			if (datos.conectado === true) {
				estado.className = 'estado conectado';
				estado.textContent = 'üü¢ Victron Conectado';
				ultimosDatosValidos = datos;
			} else {
				estado.className = 'estado conectado';
				estado.textContent = 'üü° Esperando datos...';
				if (ultimosDatosValidos) {
					datos = ultimosDatosValidos;
				}
			}

			// Datos principales a mostrar primero
			const principales = [
				{ campo: 'porcentaje', etiqueta: 'Bater√≠a', sufijo: '%', clase: 'valor-principal', claveClase: 'clave-principal' },
				{ campo: 'bateria_voltaje', etiqueta: 'Voltaje Bat.', sufijo: 'V', clase: 'valor-principal', claveClase: 'clave-principal' },
				{ campo: 'potencia', etiqueta: 'Carga Solar', sufijo: 'W', clase: 'valor-principal', claveClase: 'clave-principal' },
				{ campo: 'bateria_corriente', etiqueta: 'Consumo', sufijo: 'A', clase: 'valor-principal', claveClase: 'clave-principal' }
			];

			let html = '<div style="grid-column: 1 / -1; display: flex; justify-content: space-between; gap: 10px; margin-bottom: 10px;">';
			principales.forEach(p => {
				let valor = datos[p.campo];
				let valorFormato = '--';
				if (valor !== undefined && valor !== null && !isNaN(valor)) {
					if (p.campo === 'porcentaje') {
						valorFormato = parseFloat(valor).toFixed(0) + p.sufijo;
					} else if (p.campo === 'bateria_voltaje') {
						valorFormato = parseFloat(valor).toFixed(2) + p.sufijo;
					} else if (p.campo === 'potencia') {
						valorFormato = parseFloat(valor).toFixed(0) + p.sufijo;
					} else if (p.campo === 'bateria_corriente') {
						valorFormato = parseFloat(valor).toFixed(2) + p.sufijo;
					} else {
						valorFormato = valor.toString();
					}
				}
				html += `<div style="flex:1; text-align:center;">
					<span class="${p.claveClase}">${p.etiqueta}</span><br>
					<span class="${p.clase}">${valorFormato}</span>
				</div>`;
			});
			html += '</div>';

			// Resto de los datos
			const camposOrdenados = [
				'panel_voltaje',
				'panel_corriente',
				'yield_today',
				'yield_total',
				'max_power_today',
				'yield_ayer',
				'max_power_ayer',
				'bateria_voltaje',
				'bateria_corriente',
				'porcentaje',
				'estado',
				'error_code',
				'intervalo_frame_s',
				'error',
				'cargando',
				'conectado',
				'exito',
				'puerto'
			];

			const etiquetas = {
				'conectado': 'Conectado',
				'exito': '√âxito',
				'puerto': 'Puerto Serial',
				'intervalo_frame_s': 'Intervalo de tramas (s)',
				'error': 'Error',
				'panel_voltaje': 'Voltaje Panel (V)',
				'panel_corriente': 'Corriente Panel (A)',
				'potencia': 'Potencia Panel (W)',
				'bateria_voltaje': 'Voltaje Bater√≠a (V)',
				'bateria_corriente': 'Corriente Bater√≠a (A)',
				'porcentaje': 'Porcentaje Bater√≠a (%)',
				'estado': 'Estado Carga',
				'error_code': 'C√≥digo Error',
				'yield_today': 'Energ√≠a Hoy (Wh)',
				'yield_total': 'Energ√≠a Total (kWh)',
				'max_power_today': 'M√°x. Potencia Hoy (W)',
				'yield_ayer': 'Energ√≠a Ayer (Wh)',
				'max_power_ayer': 'M√°x. Potencia Ayer (W)',
				'cargando': 'Cargando'
			};

			camposOrdenados.forEach(campo => {
				// Saltar los que ya est√°n en principales
				if (principales.some(p => p.campo === campo)) return;
				const valor = datos[campo];
				const etiqueta = etiquetas[campo] || campo;
				let valorFormato = '';
				if (valor === undefined || valor === null) {
					valorFormato = '--';
				} else if (typeof valor === 'boolean') {
					valorFormato = valor ? 'S√ç' : 'NO';
				} else if (typeof valor === 'number') {
					if (campo.includes('voltaje')) {
						valorFormato = valor.toFixed(2);
					} else if (campo.includes('corriente')) {
						valorFormato = valor.toFixed(2);
					} else if (campo.includes('porcentaje')) {
						valorFormato = valor.toFixed(0) + '%';
					} else if (campo === 'intervalo_frame_s') {
						valorFormato = valor.toFixed(2) + ' s';
					} else if (campo.includes('potencia')) {
						valorFormato = valor.toFixed(0);
					} else {
						valorFormato = valor.toString();
					}
				} else {
					valorFormato = valor.toString();
				}
				html += `<div class=\"linea\">
				<span class=\"clave\">${etiqueta}:</span>
				<span class=\"valor\">${valorFormato}</span>
			</div>`;
			});

			datosDiv.innerHTML = html;
		}
		
		function reconectar() {
			console.log('[ACTION] Usuario solicit√≥ reconectar');
			if (ws) {
				ws.close();
			}
			setTimeout(conectarWS, 500);
		}
		
		function limpiarConsola() {
			console.clear();
			console.log('[INFO] Consola limpiada');
		}
		
		// Conectar al cargar la p√°gina
		window.addEventListener('load', function() {
			console.log('[INIT] P√°gina cargada, conectando WebSocket...');
			conectarWS();
		});
		
		// Intentar reconectar si se cierra accidentalmente
		window.addEventListener('beforeunload', function() {
			if (ws) {
				ws.close();
			}
		});
	</script>
</body>
</html>
