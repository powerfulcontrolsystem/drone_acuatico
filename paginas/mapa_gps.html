<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Mapa GPS - Drone</title>
	<link rel="stylesheet" href="/static/tema_universal.css">
	<style>
		:root {
			--bg: #0b0f16;
			--panel: #0f172a;
			--text: #e5e7eb;
			--muted: #94a3b8;
			--accent: #5ad3f0;
		}
		* { box-sizing: border-box; }
		body {
			margin: 0;
			background: var(--bg);
			color: var(--text);
			font-family: 'Segoe UI', 'Space Grotesk', sans-serif;
			height: 100vh;
			display: flex;
			flex-direction: column;
		}
		.map-wrapper {
			position: relative;
			flex: 1;
			height: 50vh;
		}
		#mapa-gps {
			position: absolute;
			inset: 0;
			background: #0f172a;
		}
		.top-bar {
			position: absolute;
			top: 12px;
			left: 12px;
			display: flex;
			gap: 10px;
			z-index: 1000;
			flex-wrap: wrap;
		}
		.info {
			position: absolute;
			bottom: 12px;
			left: 12px;
			padding: 10px 12px;
			border-radius: 10px;
			background: rgba(2, 6, 14, 0.78);
			border: 1px solid #0f172a;
			color: var(--text);
			font-size: 0.95rem;
			display: flex;
			gap: 10px;
			align-items: center;
			backdrop-filter: blur(6px);
			min-width: 260px;
		}
		.dot {
			width: 10px;
			height: 10px;
			border-radius: 50%;
			background: #22c55e;
			box-shadow: 0 0 12px rgba(34,197,94,0.9);
		}
		.dot.off {
			background: #ef4444;
			box-shadow: 0 0 12px rgba(239,68,68,0.8);
		}
		.panels-container {
			display: flex;
			height: 50vh;
			gap: 0;
		}
		.panel {
			flex: 1;
			background: var(--panel);
			border: 1px solid #2d3748;
			display: flex;
			flex-direction: column;
		}
		.panel-header {
			padding: 12px;
			border-bottom: 1px solid #2d3748;
			font-weight: 600;
			color: var(--accent);
			font-size: 1rem;
		}
		.panel-content {
			flex: 1;
			overflow-y: auto;
			padding: 12px;
		}
		.lista-item {
			padding: 8px;
			margin-bottom: 8px;
			background: rgba(93, 211, 240, 0.1);
			border-left: 3px solid var(--accent);
			border-radius: 4px;
			cursor: pointer;
			transition: all 0.2s ease;
			font-size: 0.9rem;
		}
		.lista-item:hover {
			background: rgba(93, 211, 240, 0.15);
			transform: translateX(4px);
		}
		.lista-vacia {
			color: var(--muted);
			text-align: center;
			padding: 20px 12px;
			font-style: italic;
		}
	</style>
	<script src="/static/leaflet_loader.js"></script>
</head>
<body>
	<div class="map-wrapper">
		<div class="top-bar">
			<button class="btn" id="btn-atras">‚üµ Atr√°s</button>
		</div>
		<div id="mapa-gps"></div>
		<div class="info" id="gps-info">
			<span class="dot" id="gps-dot"></span>
			<span id="gps-text">Esperando datos GPS‚Ä¶</span>
		</div>
	</div>
	<div class="panels-container">
		<div class="panel">
			<div class="panel-header">üìç Ubicaciones Guardadas</div>
			<div style="padding: 10px 12px 0 12px;">
				<input id="busqueda-ubicacion" type="text" placeholder="Buscar por nombre..." style="width:100%;padding:6px 8px;border-radius:6px;border:1px solid #2d3748;background:#181e29;color:#e5e7eb;font-size:1em;outline:none;">
			</div>
			<div class="panel-content" id="ubicaciones-list">
				<div class="lista-vacia">No hay ubicaciones guardadas</div>
			</div>
		</div>
		<div class="panel" style="border-left: 1px solid #2d3748;">
			<div class="panel-header">üõ§Ô∏è Rutas Guardadas</div>
			<div class="panel-content" id="rutas-list">
				<div class="lista-vacia">No hay rutas guardadas</div>
			</div>
		</div>
	</div>

	<script>
		window.autoCenter = true;
		let ws;
		let ubicacionesGuardadas = [];
		let marcadorUbicacionSeleccionada = null;
	// --- UBICACIONES GUARDADAS ---
	async function cargarUbicaciones(busqueda = "") {
		try {
			let url = '/api/ubicaciones';
			if (busqueda && busqueda.trim() !== "") {
				url += '?busqueda=' + encodeURIComponent(busqueda.trim());
			}
			const res = await fetch(url);
			if (!res.ok) throw new Error('No se pudo obtener ubicaciones');
			const data = await res.json();
			if (!data.exito) throw new Error('No se pudo obtener ubicaciones');
			ubicacionesGuardadas = data.ubicaciones || [];
			renderizarUbicaciones();
		} catch (e) {
			document.getElementById('ubicaciones-list').innerHTML = '<div class="lista-vacia">Error cargando ubicaciones</div>';
		}
	}

	function renderizarUbicaciones() {
		const cont = document.getElementById('ubicaciones-list');
		if (!ubicacionesGuardadas || ubicacionesGuardadas.length === 0) {
			cont.innerHTML = '<div class="lista-vacia">No hay ubicaciones guardadas</div>';
			return;
		}
		cont.innerHTML = '';
		ubicacionesGuardadas.forEach(ubic => {
			const div = document.createElement('div');
			div.className = 'lista-item';
			div.textContent = ubic.nombre + (ubic.descripcion ? ' ‚Äî ' + ubic.descripcion : '');
			div.title = `Lat: ${ubic.latitud}, Lon: ${ubic.longitud}`;
			div.onclick = () => seleccionarUbicacion(ubic);
			cont.appendChild(div);
		});
	}

	function seleccionarUbicacion(ubic) {
		if (!window._leafletMap) return;
		// Eliminar marcador anterior
		if (marcadorUbicacionSeleccionada) {
			window._leafletMap.removeLayer(marcadorUbicacionSeleccionada);
		}
		// Crear marcador caf√©
		marcadorUbicacionSeleccionada = L.circleMarker([ubic.latitud, ubic.longitud], {
			radius: 10,
			color: '#7c4700',
			fillColor: '#a97c50',
			fillOpacity: 0.95,
			weight: 3
		}).addTo(window._leafletMap);
		marcadorUbicacionSeleccionada.bindPopup(`<b>${ubic.nombre}</b><br>Lat: ${ubic.latitud}<br>Lon: ${ubic.longitud}`).openPopup();
		window._leafletMap.setView([ubic.latitud, ubic.longitud], 17, { animate: true });
	}

		function actualizarGpsUI(g) {
			const valido = !!g?.valido && isFinite(g.latitud) && isFinite(g.longitud);
			const dot = document.getElementById('gps-dot');
			const text = document.getElementById('gps-text');
			if (!valido) {
				dot.classList.add('off');
				text.textContent = 'GPS sin se√±al';
				return;
			}
			dot.classList.remove('off');
			const lat = Number(g.latitud);
			const lon = Number(g.longitud);
			const alt = g.altitud ?? 0;
			const vel = g.velocidad ?? 0;
			const sat = g.satelites ?? 0;
			text.textContent = `Lat: ${lat.toFixed(6)}  Lon: ${lon.toFixed(6)}  Alt: ${alt}m  Vel: ${vel}kn  Sat: ${sat}`;
			mostrarMapaGPS(lat, lon, true);
		}

		function conectarWS() {
			const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
			const url = proto + location.hostname + ':8080/ws';
			ws = new WebSocket(url);
			window.ws = ws;

			ws.onopen = () => {
				setTimeout(() => {
					if (window._leafletMap?.invalidateSize) {
						window._leafletMap.invalidateSize();
					}
				}, 200);
			};

			ws.onmessage = (ev) => {
				try {
					const msg = JSON.parse(ev.data);
					if (msg?.tipo === 'gps' && msg.datos) {
						actualizarGpsUI(msg.datos);
					}
				} catch (e) {
					console.log('Error procesando mensaje:', e);
				}
			};

			ws.onclose = () => {
				setTimeout(conectarWS, 2000);
			};

			ws.onerror = () => {};
		}

		async function consultarGpsActual() {
			try {
				const res = await fetch('/api/gps/actual', { cache: 'no-store' });
				if (!res.ok) return;
				const json = await res.json();
				if (!json.exito || !json.datos) return;
				actualizarGpsUI(json.datos);
			} catch (e) {
				console.log('Error en fallback GPS:', e);
			}
		}

		function irAtras() {
			try {
				if (window.history && window.history.length > 1) {
					window.history.back();
					return;
				}
			} catch (e) {}
			window.location.href = 'control%20remoto%20digital.html';
		}

		window.addEventListener('DOMContentLoaded', () => {
			document.getElementById('btn-atras').addEventListener('click', irAtras);
			conectarWS();
			consultarGpsActual();
			setInterval(consultarGpsActual, 4000);
			// Cargar ubicaciones guardadas
			cargarUbicaciones();
			// Buscar por nombre
			document.getElementById('busqueda-ubicacion').addEventListener('input', e => {
				cargarUbicaciones(e.target.value);
			});
		});
	</script>
</body>
</html>
