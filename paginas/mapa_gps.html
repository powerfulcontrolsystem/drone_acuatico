<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Mapa GPS - Drone Acuático</title>
	<link rel="stylesheet" href="/static/tema_universal.css">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--panel-bg: #0b0f16;
			--panel-border: #1f2937;
			--accent: #5ad3f0;
			--text: #e5e7eb;
			--muted: #94a3b8;
		}
		* { box-sizing: border-box; }
		body {
			margin: 0;
			background: #0b0f16;
			color: var(--text);
			font-family: 'Space Grotesk', 'Segoe UI', sans-serif;
			min-height: 100vh;
			display: flex;
			flex-direction: column;
		}
		/* Cuadro superior de ancho completo con el mapa */
		.cuadro-mapa {
			position: relative;
			width: 100%;
			height: 100vh;
			min-height: 320px;
			background: rgba(17, 24, 39, 0.6);
			border: 1px solid var(--panel-border);
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 14px 40px rgba(0,0,0,0.35);
		}
		#mapa-gps {
			position: absolute;
			inset: 0;
		}
		.gps-overlay {
			position: absolute;
			left: 12px;
			bottom: 12px;
			background: rgba(2, 6, 14, 0.75);
			border: 1px solid #0f172a;
			color: var(--text);
			padding: 8px 10px;
			border-radius: 10px;
			font-size: 0.9rem;
			display: flex;
			gap: 10px;
			align-items: center;
			backdrop-filter: blur(6px);
		}
		.gps-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: #22c55e;
			box-shadow: 0 0 10px rgba(34,197,94,0.8);
		}
		.gps-dot.off {
			background: #ef4444;
			box-shadow: 0 0 10px rgba(239,68,68,0.7);
		}
		.map-controls {
			position: absolute;
			right: 12px;
			bottom: 12px;
			display: flex;
			gap: 8px;
		}
		.map-controls .btn-menu {
			width: 40px;
			height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 0;
			border-radius: 10px;
		}
	</style>
	<script src="leaflet_loader.js"></script>
</head>
<body>
	<div class="cuadro-mapa">
		<div id="mapa-gps"></div>
		<div class="gps-overlay" id="gps-info">
			<span class="gps-dot" id="gps-dot"></span>
			<span id="gps-text">Esperando datos GPS…</span>
		</div>
		<div class="map-controls">
			<button id="btn-centrar" class="btn-menu" title="Centrar en posición">
				<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#5ad3f0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M12 2v4M12 18v4M2 12h4M18 12h4"></path>
					<circle cx="12" cy="12" r="3"></circle>
					<circle cx="12" cy="12" r="8"></circle>
				</svg>
			</button>
		</div>
	</div>
	<script>
		let autoCenter = true;
		let ws;

		function conectarWS() {
			const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
			const url = proto + location.hostname + ':8080/ws';
			ws = new WebSocket(url);

			ws.onopen = function() {
				console.log('WebSocket conectado');
				// Ajustar mapa si ya existe
				setTimeout(() => {
					if (window._leafletMap && window._leafletMap.invalidateSize) {
						window._leafletMap.invalidateSize();
					}
				}, 300);
			};

			ws.onmessage = function(ev) {
				try {
					const msg = JSON.parse(ev.data);
					if (msg && msg.tipo === 'gps' && msg.datos) {
						const g = msg.datos;
						const valido = !!g.valido && isFinite(g.latitud) && isFinite(g.longitud);
						const dot = document.getElementById('gps-dot');
						const text = document.getElementById('gps-text');
						if (!valido) {
							dot.classList.add('off');
							text.textContent = 'GPS sin señal';
							return;
						}
						dot.classList.remove('off');
						const lat = Number(g.latitud);
						const lon = Number(g.longitud);
						const alt = g.altitud ?? 0;
						const vel = g.velocidad ?? 0;
						const sat = g.satelites ?? 0;
						text.textContent = `Lat: ${lat.toFixed(6)}  Lon: ${lon.toFixed(6)}  Alt: ${alt}m  Vel: ${vel}kn  Sat: ${sat}`;

						// Actualizar mapa usando la función de leaflet_loader
						mostrarMapaGPS(lat, lon, valido);
					}
				} catch (e) {
					console.log('Error procesando mensaje:', e);
				}
			};

			ws.onclose = function() {
				console.log('WebSocket desconectado, reconectando...');
				setTimeout(conectarWS, 2000);
			};

			ws.onerror = function(e) {
				console.error('Error WebSocket:', e);
			};
		}

		// Botón centrar
		document.getElementById('btn-centrar').addEventListener('click', () => {
			autoCenter = true;
			if (window._gpsActual && window._leafletMap) {
				const z = Math.max(window._leafletMap.getZoom(), 16);
				window._leafletMap.setView([window._gpsActual.lat, window._gpsActual.lon], z, { animate: true });
			}
		});

		// Detectar interacción del usuario con el mapa para desactivar auto-centrado
		function bindUserPan() {
			const tryBind = () => {
				if (window._leafletMap) {
					['dragstart', 'zoomstart'].forEach(ev => window._leafletMap.on(ev, () => { autoCenter = false; }));
				} else {
					setTimeout(tryBind, 400);
				}
			};
			tryBind();
		}

		// Inicializar
		window.addEventListener('DOMContentLoaded', () => {
			conectarWS();
			bindUserPan();
			// Fallback: si no hay WS o no llegan datos, consultar REST periódicamente
			setInterval(async () => {
				try {
					const res = await fetch('/api/gps/actual', { cache: 'no-store' });
					if (!res.ok) return;
					const json = await res.json();
					if (!json.exito || !json.datos) return;
					const g = json.datos;
					const valido = !!g.valido && isFinite(g.latitud) && isFinite(g.longitud);
					const dot = document.getElementById('gps-dot');
					const text = document.getElementById('gps-text');
					if (!valido) {
						dot.classList.add('off');
						text.textContent = 'GPS sin señal';
						return;
					}
					dot.classList.remove('off');
					const lat = Number(g.latitud);
					const lon = Number(g.longitud);
					const alt = g.altitud ?? 0;
					const vel = g.velocidad ?? 0;
					const sat = g.satelites ?? 0;
					text.textContent = `Lat: ${lat.toFixed(6)}  Lon: ${lon.toFixed(6)}  Alt: ${alt}m  Vel: ${vel}kn  Sat: ${sat}`;
					mostrarMapaGPS(lat, lon, valido);
				} catch (e) {
					console.log('Error en fallback GPS:', e);
				}
			}, 3000);
		});
	</script>
</body>
</html>
