â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CORRECCIONES IMPLEMENTADAS - SIN DATOS/DESCONECTADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FECHA: 16 de Enero de 2026
PROBLEMA: PÃ¡gina muestra "ğŸ”´ Desconectado" sin datos
SOLUCIÃ“N: AÃ±adir cÃ¡lculo de porcentaje de baterÃ­a + mejorar flujo JS

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. ERROR ENCONTRADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ PROBLEMA 1: Falta de campo "porcentaje"
   - La pÃ¡gina esperaba campo 'porcentaje' en datos solares
   - Victron NO envÃ­a porcentaje directamente
   - parsear_datos_victron() no lo calculaba
   - actualizarBateria() recibÃ­a 'porcentaje' como 0 o undefined
   - Resultado: Barra de baterÃ­a siempre en 0%

âŒ PROBLEMA 2: Flujo JavaScript incompleto
   - Servidor enviaba datos con tipo='solar'
   - JavaScript solo llamaba actualizarPanelSolar()
   - NO llamaba actualizarBateria() con los datos solares
   - BaterÃ­a nunca se actualizaba

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
2. SOLUCIONES APLICADAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… SOLUCIÃ“N 1: Calcular porcentaje de baterÃ­a
   Archivo: funciones.py, funciÃ³n parsear_datos_victron()
   
   Antes:
   - Retornaba sin campo 'porcentaje'
   - JavaScript mostraba "-- %" o "0 %"
   
   Ahora:
   - Calcula porcentaje del voltaje de baterÃ­a
   - Rango: 10V (0%) a 14V (100%)
   - FÃ³rmula: porcentaje = (V - 10) / 4 * 100
   - Limitado a rango 0-100%
   
   Ejemplo:
   - 10V â†’ 0%
   - 12V â†’ 50%
   - 14V â†’ 100%
   
   âœ… Ahora retorna:
   'porcentaje': porcentaje_bateria

âœ… SOLUCIÃ“N 2: Mejorar flujo JavaScript
   Archivo: energia_solar.html, funciÃ³n conectarWS()
   
   Antes:
   ws.onmessage: solo llamaba actualizarPanelSolar()
   
   Ahora:
   ws.onmessage: llama AMBAS funciones con mismos datos
   - actualizarPanelSolar(data.datos)  // Panel
   - actualizarBateria(data.datos)     // BaterÃ­a
   
   âœ… Ambos paneles se actualizan correctamente

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
3. ESTRUCTURA COMPLETA DE DATOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SERVIDOR ENVÃA (obtener_solar()):
{
  'conectado': True/False,
  'exito': True/False,
  'error': '...' si hay error,
  'puerto': '/dev/ttyUSB0',
  
  // Panel Solar
  'panel_voltaje': 18.5,      // V
  'panel_corriente': 2.1,     // A
  'potencia': 38,             // W
  
  // BaterÃ­a
  'bateria_voltaje': 12.8,    // V
  'bateria_corriente': 0.5,   // A
  'porcentaje': 70,           // % âœ… NUEVO
  
  // Estado
  'estado': 'bulk',           // bulk/absorption/float/apagado/falla
  'error_code': 0,
  
  // EnergÃ­a
  'yield_today': 450,         // Wh
  'yield_total': 125.4,       // kWh
  'max_power_today': 75,      // W
  'yield_ayer': 380,          // Wh
  'max_power_ayer': 65,       // W
  
  'cargando': True/False,
  'raw_data': {...}
}

PÃGINA RECIBE:
{
  'tipo': 'solar',
  'datos': { ...todos los campos arriba... }
}

JAVASCRIPT PROCESA:
1. actualizarPanelSolar(datos)
   - Muestra: Panel Voltaje, Corriente, Potencia
   - Muestra: Estado (Bulk, Absorption, Float)
   - Muestra: EnergÃ­a hoy, total, ayer
   - Muestra: CÃ³digo de error
   - Muestra: Puerto serial

2. actualizarBateria(datos)
   - Muestra: Voltaje baterÃ­a
   - Muestra: Porcentaje (0-100%)
   - Muestra: Barra de carga coloreada
   - Muestra: Estado (Cargando, Descargando, Llena)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
4. CÃ“MO PROBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OPCIÃ“N A: Script automÃ¡tico (RECOMENDADO)
cd /home/admin/drone_acuatico
bash reiniciar_y_probar.sh

OPCIÃ“N B: Manual
# 1. Detener servidor anterior
pkill -9 -f 'servidor.py'

# 2. Probar Victron
python3 /home/admin/drone_acuatico/diagnostico_rapido.py

# 3. Reiniciar servidor
cd /home/admin/drone_acuatico
source venv_pi/bin/activate
python3 servidor.py &

# 4. Verificar
sleep 3
ps aux | grep servidor.py | grep -v grep

OPCIÃ“N C: En navegador
1. Abrir: http://192.168.1.7:8080
2. Click en "â˜€ï¸ EnergÃ­a Solar"

RESULTADOS ESPERADOS:

ğŸŸ¢ Si Victron conectado:
   â”œâ”€ Panel conexiÃ³n: ğŸŸ¢ Conectado (borde verde)
   â”œâ”€ Puerto: /dev/ttyUSB0
   â”œâ”€ Panel Solar:
   â”‚  â”œâ”€ Voltaje: 18.5V
   â”‚  â”œâ”€ Corriente: 2.1A
   â”‚  â”œâ”€ Potencia: 38W
   â”‚  â””â”€ Estado: ğŸ“ˆ Carga RÃ¡pida
   â”œâ”€ BaterÃ­a:
   â”‚  â”œâ”€ Voltaje: 12.8V
   â”‚  â”œâ”€ Carga: 70% [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘]
   â”‚  â””â”€ Estado: âš¡ Cargando (+0.50A)
   â””â”€ DiagnÃ³stico:
      â”œâ”€ Error: âœ… Sin errores (0)
      â”œâ”€ EnergÃ­a Ayer: 380 Wh
      â””â”€ MÃ¡x. Ayer: 65W

ğŸ”´ Si Victron NO conectado:
   â”œâ”€ Panel conexiÃ³n: ğŸ”´ Desconectado (borde rojo)
   â”œâ”€ Todos los campos: "--"
   â””â”€ Estado: "Sin datos"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
5. VERIFICACIÃ“N DE CAMBIOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ARCHIVO 1: funciones.py (MODIFICADO)
âœ… LÃ­nea ~770: Nuevo cÃ¡lculo de porcentaje
   porcentaje_bateria = max(0, min(100, int((bateria_voltaje - 10.0) / 4.0 * 100)))

âœ… LÃ­nea ~790: Retorna 'porcentaje' en el diccionario
   return { 'porcentaje': porcentaje_bateria, ... }

ARCHIVO 2: energia_solar.html (MODIFICADO)
âœ… LÃ­nea ~408: onmessage ahora llama ambas funciones
   if (data.tipo === 'solar' && data.datos) {
       actualizarPanelSolar(data.datos);
       actualizarBateria(data.datos);  // âœ… NUEVO
   }

âœ… FunciÃ³n actualizarBateria() ya tenÃ­a:
   const porcentaje = datos.porcentaje || 0;  // âœ… Soporta el campo nuevo

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
6. TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEMA: "ğŸ”´ Desconectado" pero Victron estÃ¡ conectado
SOLUCIÃ“N:
  1. Ejecutar: python3 diagnostico_rapido.py
  2. Verificar que muestre datos
  3. Si muestra datos pero pÃ¡gina no: Limpiar cachÃ© navegador (Ctrl+Shift+R)
  4. Si diagnÃ³stico falla: Ver secciÃ³n anterior "no se conecta bien"

PROBLEMA: Porcentaje siempre en 0%
SOLUCIÃ“N:
  1. Revisar voltaje baterÃ­a que se muestra
  2. Si es 0V: BaterÃ­a desconectada o no envÃ­a datos
  3. Si es 12V+: Porcentaje deberÃ­a ser >0%
  4. Revisar cÃ¡lculo: (12 - 10) / 4 * 100 = 50%

PROBLEMA: Barra de baterÃ­a no se colora
SOLUCIÃ“N:
  1. Abrir: Firefox â†’ Herr. â†’ Inspector â†’ Console
  2. Ver si hay errores JavaScript
  3. Verificar que actualizarBateria() se llama

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
7. PRÃ“XIMAS MEJORAS (opcionales)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Si el usuario quiere calibraciÃ³n de baterÃ­a mÃ¡s precisa:
  - Permitir configurar voltaje mÃ­n/mÃ¡x por tipo de baterÃ­a
  - Usar tabla de descarga segÃºn tecnologÃ­a
  - Guardar calibraciÃ³n en BD

Posibles tipos de baterÃ­a:
  - LiFePO4: 10V-14.4V
  - Li-ion: 9V-12.6V
  - SLA/AGM: 11.5V-13.8V
  - GEL: 11.5V-13.8V
  - Ãcido-plomo: 10V-13.2V

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIN DEL DOCUMENTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
